@model SchoolBookPlatform.ViewModels.Post.PostListViewModel
@{
    ViewData["Title"] = "Trang chủ";
    Layout = "~/Views/Shared/_Layout.cshtml";

}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>
                    @if (Model.ViewType == "home")
                    {
                        <span>Bài đăng gần đây</span>
                    }
                    else
                    {
                        <span>Đang theo dõi</span>
                    }
                </h2>
                <a asp-controller="Post" asp-action="Create" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Đăng bài mới
                </a>
            </div>

            @* Hiển thị thông báo *@
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <!-- Nút test GetIp -->
            @if (ViewContext.RouteData.Values["action"]?.ToString() == "Home" && 
                 ViewContext.RouteData.Values["controller"]?.ToString() == "Feeds")
            {
                <div class="mb-3">
                    <a asp-action="GetIp" asp-controller="Feeds" class="btn btn-outline-success">
                        <i class="fas fa-network-wired me-1"></i> Get Ip Now
                    </a>
                </div>
            }

            @if (TempData["Ip + Info"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["Ip + Info"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            @* Kiểm tra nếu là tab Following và không có bài đăng *@
            @if (Model.ViewType == "following" && !Model.Posts.Any())
            {
                <div class="empty-following text-center py-5">
                    <i class="fas fa-user-friends fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Bạn chưa follow ai</h4>
                    <p class="text-muted">Follow người khác để xem bài đăng của họ tại đây</p>
                    <a href="@Url.Action("Explore", "User")" class="btn btn-primary">
                        <i class="fas fa-search"></i> Khám phá người dùng
                    </a>
                </div>
            }

            @* Modal hiển thị ảnh/video toàn màn hình *@
            <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-fullscreen">
                    <div class="modal-content">
                        <div class="modal-header border-0">
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-0 position-relative">
                            <!-- Background mờ -->
                            <div id="blurredBackground" class="position-absolute top-0 start-0 w-100 h-100"></div>
                            
                            <!-- Carousel Modal -->
                            <div id="modalCarousel" class="carousel slide h-100" data-bs-ride="carousel">
                                <div class="carousel-inner h-100"></div>
                                
                                <!-- Counter cho modal -->
                                <div class="carousel-counter-modal position-absolute top-0 end-0 m-3">
                                    <span id="modalCurrentSlide" class="badge bg-dark bg-opacity-75 p-2">1</span>
                                    <span class="text-white">/</span>
                                    <span id="modalTotalSlides" class="badge bg-dark bg-opacity-75 p-2">0</span>
                                </div>
                                
                                <!-- Navigation buttons -->
                                <button class="carousel-control-prev" type="button" data-bs-target="#modalCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#modalCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @* Danh sách bài đăng - Thay toàn bộ phần này *@
            <div id="posts-container">
                @await Html.PartialAsync("_PostListPartial", Model)
            </div>

            <!-- No more posts message -->
            <div id="no-more-posts" class="text-center my-5" style="display: none;">
                <p class="text-muted">Đã hiển thị tất cả bài đăng</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Biến toàn cục để quản lý lazyload
        let currentPage = @Model.CurrentPage;
        let isLoading = false;
        let hasMorePosts = @Json.Serialize(Model.HasMorePosts);
        const viewType = "@Model.ViewType";
        let observer = null;
        let initialLoadComplete = false;

        // Hàm lazyload khi scroll đến cuối
        function setupLazyLoading() {

            // Tạo observer mới
            observer = new IntersectionObserver((entries) => {

                const entry = entries[0];
                if (entry.isIntersecting && !isLoading && hasMorePosts && initialLoadComplete) {
                    console.log('Loading more posts triggered!');
                    loadMorePosts();
                }
            }, {
                root: null,
                rootMargin: '300px',
                threshold: 0.1
            });

            // Quan sát loading spinner
            const loadingSpinner = document.getElementById('loading-spinner');
            const noMorePosts = document.getElementById('no-more-posts');

            if (loadingSpinner) {
                // Chỉ show loading spinner nếu còn bài đăng
                if (hasMorePosts && @(Model.Posts?.Count ?? 0) > 0) {
                    loadingSpinner.classList.remove('hidden');
                    loadingSpinner.classList.add('visible');
                    observer.observe(loadingSpinner);
                    console.log('Observer attached to loading spinner');
                } else {
                    loadingSpinner.classList.add('hidden');
                    loadingSpinner.classList.remove('visible');
                }
            }

            // Hiển thị thông báo "Đã hiển thị tất cả bài đăng" nếu không còn bài
            if (noMorePosts && !hasMorePosts && @(Model.Posts?.Count ?? 0) > 0) {
                noMorePosts.style.display = 'block';
            }
        }

        // Hàm tải thêm bài đăng
        async function loadMorePosts() {

            isLoading = true;
            const pageToLoad = currentPage + 1;

            // Hiển thị loading spinner
            const loadingSpinner = document.getElementById('loading-spinner');
            const noMorePosts = document.getElementById('no-more-posts');

            if (loadingSpinner) {
                loadingSpinner.classList.add('visible');
                loadingSpinner.classList.remove('hidden');
            }
            if (noMorePosts) noMorePosts.style.display = 'none';

            try {
                // Xác định action dựa trên viewType
                const action = viewType === 'following' ? 'Following' : 'Home';
                const url = `/Feeds/${action}?page=${pageToLoad}`;

                const response = await fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                

                if (response.ok) {
                    const html = await response.text();

                    if (html.trim()) {
                        const postsContainer = document.getElementById('posts-container');
                        const newPostsContainer = document.createElement('div');
                        newPostsContainer.innerHTML = html;

                        const postCards = newPostsContainer.querySelectorAll('.post-card');

                        if (postCards.length > 0) {
                            // Thêm vào DOM với animation
                            postCards.forEach(card => {
                                card.classList.add('new-post');
                            });
                            postsContainer.appendChild(newPostsContainer);

                            // Cập nhật current page
                            currentPage = pageToLoad;

                            // Khởi tạo lại các sự kiện cho bài đăng mới
                            initializeNewPosts();

                            // Kiểm tra xem còn bài đăng không
                            hasMorePosts = postCards.length === @Model.PageSize;
                            
                            // Cập nhật UI dựa trên hasMorePosts
                            updateLoadingUI();

                        } else {

                            hasMorePosts = false;
                            updateLoadingUI();
                        }
                    } else {
                        hasMorePosts = false;
                        updateLoadingUI();
                    }
                } else {

                    hasMorePosts = false;
                    updateLoadingUI();
                }
            } catch (error) {

                hasMorePosts = false;
                updateLoadingUI();
            } finally {
                isLoading = false;


                // Đánh dấu đã load xong lần đầu
                if (!initialLoadComplete) {
                    initialLoadComplete = true;
                }

                // Nếu không còn bài đăng, ngừng quan sát
                if (!hasMorePosts && observer) {
                    observer.disconnect();
                }
            }
        }

        // Hàm cập nhật UI cho loading
        function updateLoadingUI() {
            const loadingSpinner = document.getElementById('loading-spinner');
            const noMorePosts = document.getElementById('no-more-posts');

            if (hasMorePosts) {
                // Còn bài đăng: hiển thị loading spinner
                if (loadingSpinner) {
                    loadingSpinner.classList.remove('hidden');
                    loadingSpinner.classList.add('visible');
                }
                if (noMorePosts) {
                    noMorePosts.style.display = 'none';
                }
            } else {
                // Hết bài đăng: ẩn loading spinner, hiển thị thông báo
                if (loadingSpinner) {
                    loadingSpinner.classList.add('hidden');
                    loadingSpinner.classList.remove('visible');
                }
                if (noMorePosts && @(Model.Posts?.Count ?? 0) > 0) {
                    noMorePosts.style.display = 'block';
                }
            }
        }

        // Hàm tải thêm bài đăng
        async function loadMorePosts() {

            isLoading = true;
            const pageToLoad = currentPage + 1;

            // Hiển thị loading spinner
            const loadingSpinner = document.getElementById('loading-spinner');
            const noMorePosts = document.getElementById('no-more-posts');

            if (loadingSpinner) {
                loadingSpinner.style.display = 'block';
                loadingSpinner.style.opacity = '1';
            }
            if (noMorePosts) noMorePosts.style.display = 'none';

            try {
                // Xác định action dựa trên viewType
                const action = viewType === 'following' ? 'Following' : 'Home';
                const url = `/Feeds/${action}?page=${pageToLoad}`;

                const response = await fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (response.ok) {
                    const html = await response.text();

                    if (html.trim()) {
                        // Thêm bài đăng mới vào container
                        const postsContainer = document.getElementById('posts-container');

                        // Tạo container mới cho bài đăng
                        const newPostsContainer = document.createElement('div');
                        newPostsContainer.innerHTML = html;

                        // Kiểm tra xem có bài đăng không
                        const postCards = newPostsContainer.querySelectorAll('.post-card');

                        if (postCards.length > 0) {
                            // Thêm vào DOM
                            postsContainer.appendChild(newPostsContainer);

                            // Cập nhật current page
                            currentPage = pageToLoad;

                            // Khởi tạo lại các sự kiện cho bài đăng mới
                            initializeNewPosts();

                            // Kiểm tra xem còn bài đăng không
                            hasMorePosts = postCards.length === @Model.PageSize;

                            // Nếu không còn bài đăng, hiển thị thông báo
                            if (!hasMorePosts) {
                                if (noMorePosts) {
                                    noMorePosts.style.display = 'block';
                                    noMorePosts.style.opacity = '1';
                                }
                            }
                        } else {
                            hasMorePosts = false;
                            if (noMorePosts) {
                                noMorePosts.style.display = 'block';
                                noMorePosts.style.opacity = '1';
                            }
                        }
                    } else {
                        hasMorePosts = false;
                        if (noMorePosts) {
                            noMorePosts.style.display = 'block';
                            noMorePosts.style.opacity = '1';
                        }
                    }
                } else {
                    
                    hasMorePosts = false;
                }
            } catch (error) {
                // Không rollback vì có thể do mạng
            } finally {
                isLoading = false;

                // Ẩn loading spinner nhưng vẫn giữ element để observer tiếp tục làm việc
                if (loadingSpinner) {
                    loadingSpinner.style.opacity = '0.5';
                }

                // Nếu không còn bài đăng, ngừng quan sát
                if (!hasMorePosts && observer) {
                    observer.disconnect();
                }
            }
        }

        // Hàm khởi tạo các sự kiện cho bài đăng mới
        function initializeNewPosts() {

            // Khởi tạo sự kiện click cho bài đăng mới
            document.querySelectorAll('.post-card:not([data-initialized])').forEach(card => {
                card.setAttribute('data-initialized', 'true');
                card.addEventListener('click', function() {
                    const postId = this.dataset.postId;
                    window.location.href = `/Post/Details/${postId}`;
                });
            });

            // Khởi tạo sự kiện vote cho bài đăng mới
            document.querySelectorAll('.vote-btn:not([data-vote-initialized])').forEach(btn => {
                btn.setAttribute('data-vote-initialized', 'true');
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();

                    const postId = this.dataset.postId;
                    const isUpvote = this.dataset.voteType === 'true';

                    try {
                        const response = await fetch('/Feeds/Vote', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `postId=${postId}&isUpvote=${isUpvote}`
                        });

                        const data = await response.json();
                        if (data.success) {
                            const newScore = data.upvoteCount - data.downvoteCount;
                            const displayScore = newScore < 0 ? 0 : newScore;

                            const scoreElement = document.querySelector(`.vote-score[data-post-id="${postId}"]`);
                            if (scoreElement) {
                                scoreElement.textContent = displayScore;
                                scoreElement.classList.add('score-updated');
                                setTimeout(() => {
                                    scoreElement.classList.remove('score-updated');
                                }, 500);
                            }
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                });
            });

            // Khởi tạo carousel cho bài đăng mới
            initializeNewCarousels();

            // Khởi tạo modal cho bài đăng mới
            if (typeof initializeModalForNewPosts === 'function') {
                initializeModalForNewPosts();
            }
        }

        // Hàm khởi tạo carousel cho bài đăng mới
        function initializeNewCarousels() {
            document.querySelectorAll('.carousel:not([data-carousel-initialized])').forEach(carousel => {
                carousel.setAttribute('data-carousel-initialized', 'true');

                const carouselId = carousel.id;
                const postId = carouselId.replace('carousel-', '');
                const currentSlideSpan = document.getElementById(`current-slide-${postId}`);
                const totalSlidesSpan = document.getElementById(`total-slides-${postId}`);

                if (currentSlideSpan && totalSlidesSpan) {
                    carousel.addEventListener('slide.bs.carousel', function (event) {
                        const activeSlide = event.to;
                        currentSlideSpan.textContent = activeSlide + 1;
                    });
                }
            });
        }

        // Thêm event listener cho scroll thủ công (fallback)
        function setupScrollListener() {
            console.log('Setting up scroll listener as fallback...');

            window.addEventListener('scroll', function() {
                if (isLoading || !hasMorePosts) return;

                const loadingSpinner = document.getElementById('loading-spinner');
                if (!loadingSpinner) return;

                const spinnerRect = loadingSpinner.getBoundingClientRect();
                const windowHeight = window.innerHeight;

                // Nếu loading spinner cách đáy màn hình < 500px
                if (spinnerRect.top < windowHeight + 500) {
                    console.log('Scroll trigger - loading more posts');
                    loadMorePosts();
                }
            });
        }

        // Khởi tạo lazyloading khi trang được tải
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');

            // Kiểm tra nếu không có bài đăng nào, ẩn loading spinner ngay
            if (@(Model.Posts?.Count ?? 0) === 0) {
                const loadingSpinner = document.getElementById('loading-spinner');
                const noMorePosts = document.getElementById('no-more-posts');

                if (loadingSpinner) {
                    loadingSpinner.classList.add('hidden');
                }
                if (noMorePosts) {
                    noMorePosts.style.display = 'none';
                }
            } else {
                // Có bài đăng, thiết lập lazyloading
                setupLazyLoading();
                setupScrollListener();
            }

            // Khởi tạo bài đăng ban đầu
            initializeNewPosts();

            console.log('Initialization complete');
        });

        function testLazyLoad() {
            console.log('Manual test triggered');
            loadMorePosts();
        }
        // Xử lý click vào bài đăng để đi đến trang chi tiết
        document.querySelectorAll('.post-card').forEach(card => {
            card.addEventListener('click', function() {
                const postId = this.dataset.postId;
                window.location.href = `/Post/Details/${postId}`;
            });
        });
        
        // Khởi tạo lazyloading khi trang được tải
        document.addEventListener('DOMContentLoaded', function() {
            setupLazyLoading();
            initializeNewPosts();

            // Nếu không có bài đăng nào và là trang đầu tiên, ẩn loading spinner
            if (@Model.CurrentPage == 1 && @(Model.Posts?.Count ?? 0) == 0) {
                const loadingSpinner = document.getElementById('loading-spinner');
                if (loadingSpinner) loadingSpinner.style.display = 'none';
            }
        });
        // Xử lý vote với AJAX
        document.querySelectorAll('.vote-btn').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.stopPropagation(); // Ngăn chặn sự kiện click lan ra card

                const postId = this.dataset.postId;
                const isUpvote = this.dataset.voteType === 'true';

                try {
                    const response = await fetch('/Feeds/Vote', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `postId=${postId}&isUpvote=${isUpvote}`
                    });

                    const data = await response.json();
                    if (data.success) {
                        // Tính toán điểm tổng mới (Upvote - Downvote)
                        const newScore = data.upvoteCount - data.downvoteCount;
                        // Nếu dưới 0 thì hiển thị 0
                        const displayScore = newScore < 0 ? 0 : newScore;

                        // Cập nhật điểm số
                        const scoreElement = document.querySelector(`.vote-score[data-post-id="${postId}"]`);
                        if (scoreElement) {
                            scoreElement.textContent = displayScore;

                            // Thêm hiệu ứng
                            scoreElement.classList.add('score-updated');
                            setTimeout(() => {
                                scoreElement.classList.remove('score-updated');
                            }, 500);
                        }
                    } else {
                        alert(data.message || 'Có lỗi xảy ra');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi vote');
                }
            });
        });
    
        // JavaScript để cập nhật số đếm khi chuyển slide trong carousel post
        document.querySelectorAll('.carousel').forEach(carousel => {
            const carouselId = carousel.id;
            const currentSlideSpan = document.getElementById(`current-slide-${carouselId.replace('carousel-', '')}`);
            const totalSlidesSpan = document.getElementById(`total-slides-${carouselId.replace('carousel-', '')}`);

            if (currentSlideSpan && totalSlidesSpan) {
                // Lắng nghe sự kiện slide.bs.carousel
                carousel.addEventListener('slide.bs.carousel', function (event) {
                    const activeSlide = event.to;
                    currentSlideSpan.textContent = activeSlide + 1;
                });
            }
        });

        // JavaScript để xử lý modal media toàn màn hình
        document.addEventListener('DOMContentLoaded', function() {
            const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            const modalCarousel = document.getElementById('modalCarousel');
            const modalCarouselInner = modalCarousel.querySelector('.carousel-inner');
            const modalCurrentSlideSpan = document.getElementById('modalCurrentSlide');
            const modalTotalSlidesSpan = document.getElementById('modalTotalSlides');
            const blurredBackground = document.getElementById('blurredBackground');
            const prevButton = modalCarousel.querySelector('.carousel-control-prev');
            const nextButton = modalCarousel.querySelector('.carousel-control-next');

            let currentPostMedia = [];
            let currentPostId = null;
            let currentPostCarousel = null;
            let lastModalMediaIndex = 0; // Lưu vị trí media cuối cùng trong modal
            let playingVideos = new Map(); // Lưu các video đang phát

            // Biến lưu trữ tất cả media của bài post
            const postMediaMap = new Map();

            // Biến lưu trữ carousel instances
            const postCarousels = new Map();

            // Khởi tạo dữ liệu media cho từng bài post và carousel instances
            document.querySelectorAll('.card').forEach(card => {
                const postId = card.querySelector('.media-modal-link')?.dataset?.postId;
                if (postId) {
                    const mediaItems = [];
                    card.querySelectorAll('.carousel-item').forEach((item, index) => {
                        const videoElement = item.querySelector('video');
                        const imgElement = item.querySelector('img');

                        if (videoElement) {
                            mediaItems.push({
                                type: 'video',
                                src: videoElement.dataset.src || videoElement.querySelector('source')?.src,
                                alt: videoElement.dataset.mediaName || '',
                                name: videoElement.dataset.mediaName || '',
                                element: videoElement
                            });
                        } else if (imgElement) {
                            mediaItems.push({
                                type: 'image',
                                src: imgElement.dataset.src || imgElement.src,
                                alt: imgElement.alt,
                                name: imgElement.dataset.mediaName || '',
                                element: imgElement
                            });
                        }
                    });
                    postMediaMap.set(postId, mediaItems);

                    // Lưu carousel instance
                    const carouselElement = document.getElementById(`carousel-${postId}`);
                    if (carouselElement) {
                        const carouselInstance = new bootstrap.Carousel(carouselElement);
                        postCarousels.set(postId, carouselInstance);
                    }
                }
            });

            // Lắng nghe click vào media
            document.querySelectorAll('.media-modal-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const postId = this.dataset.postId;
                    const mediaIndex = parseInt(this.dataset.mediaIndex);
                    const totalMedia = parseInt(this.dataset.totalMedia);
                    const mediaType = this.dataset.mediaType;

                    currentPostId = postId;
                    currentPostMedia = postMediaMap.get(postId) || [];
                    currentPostCarousel = postCarousels.get(postId);
                    lastModalMediaIndex = mediaIndex; // Lưu vị trí bắt đầu

                    // Cập nhật tổng số media
                    modalTotalSlidesSpan.textContent = currentPostMedia.length;

                    // Ẩn/Hiện counter và nút điều hướng dựa trên số lượng media
                    const counterElement = document.querySelector('.carousel-counter-modal');
                    if (currentPostMedia.length <= 1) {
                        // Ẩn counter và nút điều hướng nếu chỉ có 1 media
                        if (counterElement) counterElement.style.display = 'none';
                        if (prevButton) prevButton.style.display = 'none';
                        if (nextButton) nextButton.style.display = 'none';
                    } else {
                        // Hiện counter và nút điều hướng nếu có nhiều media
                        if (counterElement) counterElement.style.display = 'block';
                        if (prevButton) prevButton.style.display = 'flex';
                        if (nextButton) nextButton.style.display = 'flex';
                    }

                    // Xóa nội dung carousel cũ
                    modalCarouselInner.innerHTML = '';

                    // Thêm các media vào carousel modal
                    currentPostMedia.forEach((media, index) => {
                        const carouselItem = document.createElement('div');
                        carouselItem.className = `carousel-item h-100 ${index === mediaIndex ? 'active' : ''}`;

                        const mediaContainer = document.createElement('div');
                        mediaContainer.className = 'd-flex justify-content-center align-items-center h-100';

                        if (media.type === 'image') {
                            const img = document.createElement('img');
                            img.src = media.src;
                            img.alt = media.alt;
                            img.className = 'img-fluid modal-media';
                            img.style.maxHeight = '95vh';
                            img.style.maxWidth = '95vw';
                            img.style.objectFit = 'contain';
                            img.style.cursor = 'pointer';

                            // Thêm sự kiện click để đóng modal khi click vào ảnh
                            img.addEventListener('click', function() {
                                imageModal.hide();
                            });

                            mediaContainer.appendChild(img);
                        } else if (media.type === 'video') {
                            const videoContainer = document.createElement('div');
                            videoContainer.className = 'position-relative w-100 h-100';

                            const video = document.createElement('video');
                            video.className = 'modal-video';
                            video.controls = true;
                            video.controlsList = 'nodownload';
                            video.preload = 'auto';
                            video.autoplay = index === mediaIndex; // Tự động phát video khi mở modal
                            video.style.maxHeight = '95vh';
                            video.style.maxWidth = '95vw';
                            video.style.objectFit = 'contain';
                            video.style.backgroundColor = '#000';

                            const source = document.createElement('source');
                            source.src = media.src;
                            source.type = 'video/mp4';

                            video.appendChild(source);
                            video.appendChild(document.createTextNode('Trình duyệt của bạn không hỗ trợ video.'));

                            // Lưu tham chiếu video để quản lý
                            video.dataset.mediaIndex = index;

                            // Thêm sự kiện để quản lý trạng thái phát
                            video.addEventListener('play', function() {
                                playingVideos.set(index, video);

                                // Dừng các video khác đang phát
                                playingVideos.forEach((vid, idx) => {
                                    if (idx !== index && !vid.paused) {
                                        vid.pause();
                                    }
                                });
                            });

                            video.addEventListener('pause', function() {
                                playingVideos.delete(index);
                            });

                            videoContainer.appendChild(video);
                            mediaContainer.appendChild(videoContainer);
                        }

                        carouselItem.appendChild(mediaContainer);
                        modalCarouselInner.appendChild(carouselItem);
                    });

                    // Khởi tạo lại carousel modal
                    const modalCarouselInstance = new bootstrap.Carousel(modalCarousel, {
                        interval: false
                    });

                    // Điều hướng đến media được click
                    modalCarouselInstance.to(mediaIndex);

                    // Cập nhật số slide hiện tại
                    modalCurrentSlideSpan.textContent = mediaIndex + 1;

                    // Cập nhật background mờ (chỉ cho ảnh)
                    updateBlurredBackground(mediaIndex);

                    // Hiển thị modal
                    imageModal.show();
                });
            });

            // Lắng nghe sự kiện chuyển slide trong modal
            modalCarousel.addEventListener('slide.bs.carousel', function(event) {
                const nextSlide = event.to;
                lastModalMediaIndex = nextSlide; // Cập nhật vị trí cuối cùng
                modalCurrentSlideSpan.textContent = nextSlide + 1;
                updateBlurredBackground(nextSlide);

                // Dừng video hiện tại khi chuyển slide
                playingVideos.forEach(video => {
                    if (!video.paused) {
                        video.pause();
                    }
                });
                playingVideos.clear();

                // Tự động phát video nếu slide mới là video
                setTimeout(() => {
                    const activeItem = modalCarouselInner.querySelector('.carousel-item.active');
                    if (activeItem) {
                        const video = activeItem.querySelector('video');
                        if (video) {
                            video.play().catch(e => console.log('Autoplay failed:', e));
                        }
                    }
                }, 300);
            });

            // Khi modal đóng, cập nhật carousel trong post và reset UI
            document.getElementById('imageModal').addEventListener('hidden.bs.modal', function() {
                // Dừng tất cả video đang phát
                playingVideos.forEach(video => {
                    if (!video.paused) {
                        video.pause();
                    }
                });
                playingVideos.clear();

                if (currentPostCarousel && currentPostId) {
                    // Chuyển carousel trong post đến vị trí media cuối cùng xem trong modal
                    currentPostCarousel.to(lastModalMediaIndex);

                    // Cập nhật counter trong post
                    const postCurrentSlideSpan = document.getElementById(`current-slide-${currentPostId}`);
                    if (postCurrentSlideSpan) {
                        postCurrentSlideSpan.textContent = lastModalMediaIndex + 1;
                    }
                }

                // Hiển thị lại counter và nút điều hướng (để chuẩn bị cho lần mở tiếp theo)
                const counterElement = document.querySelector('.carousel-counter-modal');
                if (counterElement) counterElement.style.display = 'block';
                if (prevButton) prevButton.style.display = 'none'; // Vẫn ẩn mặc định
                if (nextButton) nextButton.style.display = 'none'; // Vẫn ẩn mặc định

                // Reset biến
                currentPostMedia = [];
                currentPostId = null;
                currentPostCarousel = null;
                blurredBackground.innerHTML = '';
                modalCarouselInner.innerHTML = '';
                modalCurrentSlideSpan.textContent = '1';
                modalTotalSlidesSpan.textContent = '0';
            });

            // Hàm cập nhật background mờ (chỉ cho ảnh)
            function updateBlurredBackground(slideIndex) {
                blurredBackground.innerHTML = '';

                if (currentPostMedia.length > 0 && slideIndex < currentPostMedia.length) {
                    const currentMedia = currentPostMedia[slideIndex];

                    // Chỉ tạo background mờ cho ảnh
                    if (currentMedia.type === 'image') {
                        const backgroundImage = document.createElement('img');
                        backgroundImage.src = currentMedia.src;
                        backgroundImage.style.width = '100%';
                        backgroundImage.style.height = '100%';
                        backgroundImage.style.objectFit = 'cover';
                        backgroundImage.style.filter = 'blur(20px) brightness(0.3)';
                        backgroundImage.style.position = 'absolute';
                        backgroundImage.style.top = '0';
                        backgroundImage.style.left = '0';

                        blurredBackground.appendChild(backgroundImage);
                    } else if (currentMedia.type === 'video') {
                        // Video không có background mờ, chỉ hiển thị background tối
                        blurredBackground.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
                    }
                }
            }

            // Lắng nghe click vào nút đóng modal
            document.querySelector('#imageModal .btn-close').addEventListener('click', function() {
                imageModal.hide();
            });

            // Cho phép đóng modal bằng phím ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && imageModal._isShown) {
                    imageModal.hide();
                }

                // Thêm phím mũi tên để chuyển media (chỉ khi có nhiều hơn 1 media)
                if (imageModal._isShown && currentPostMedia.length > 1) {
                    const carouselInstance = bootstrap.Carousel.getInstance(modalCarousel);
                    if (e.key === 'ArrowLeft') {
                        carouselInstance.prev();
                    } else if (e.key === 'ArrowRight') {
                        carouselInstance.next();
                    }
                }
            });

            // Click bên ngoài media để đóng modal
            document.getElementById('imageModal').addEventListener('click', function(e) {
                // Chỉ đóng khi click vào background, không phải vào media
                if (e.target === this ||
                    (e.target.classList.contains('modal-body') &&
                        !e.target.closest('.carousel-item') &&
                        !e.target.closest('.modal-video') &&
                        !e.target.closest('.modal-media'))) {
                    imageModal.hide();
                }
            });
        });

        // Lắng nghe click vào media của các bài đăng mới
        newPostCards.forEach(card => {
            const mediaLinks = card.querySelectorAll('.media-modal-link');
            mediaLinks.forEach(link => {
                if (!link.hasAttribute('data-modal-listener')) {
                    link.setAttribute('data-modal-listener', 'true');

                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const postId = this.dataset.postId;
                        const mediaIndex = parseInt(this.dataset.mediaIndex);
                        const totalMedia = parseInt(this.dataset.totalMedia);
                        const mediaType = this.dataset.mediaType;

                        currentPostId = postId;
                        currentPostMedia = postMediaMap.get(postId) || [];
                        currentPostCarousel = postCarousels.get(postId);
                        lastModalMediaIndex = mediaIndex;

                        // Cập nhật tổng số media
                        modalTotalSlidesSpan.textContent = currentPostMedia.length;

                        // Ẩn/Hiện counter và nút điều hướng
                        const counterElement = document.querySelector('.carousel-counter-modal');
                        if (currentPostMedia.length <= 1) {
                            if (counterElement) counterElement.style.display = 'none';
                            if (prevButton) prevButton.style.display = 'none';
                            if (nextButton) nextButton.style.display = 'none';
                        } else {
                            if (counterElement) counterElement.style.display = 'block';
                            if (prevButton) prevButton.style.display = 'flex';
                            if (nextButton) nextButton.style.display = 'flex';
                        }

                        // Xóa nội dung carousel cũ
                        modalCarouselInner.innerHTML = '';

                        // Thêm các media vào carousel modal
                        currentPostMedia.forEach((media, index) => {
                            const carouselItem = document.createElement('div');
                            carouselItem.className = `carousel-item h-100 ${index === mediaIndex ? 'active' : ''}`;

                            const mediaContainer = document.createElement('div');
                            mediaContainer.className = 'd-flex justify-content-center align-items-center h-100';

                            if (media.type === 'image') {
                                const img = document.createElement('img');
                                img.src = media.src;
                                img.alt = media.alt;
                                img.className = 'img-fluid modal-media';
                                img.style.maxHeight = '95vh';
                                img.style.maxWidth = '95vw';
                                img.style.objectFit = 'contain';
                                img.style.cursor = 'pointer';

                                img.addEventListener('click', function() {
                                    imageModal.hide();
                                });

                                mediaContainer.appendChild(img);
                            } else if (media.type === 'video') {
                                const videoContainer = document.createElement('div');
                                videoContainer.className = 'position-relative w-100 h-100';

                                const video = document.createElement('video');
                                video.className = 'modal-video';
                                video.controls = true;
                                video.controlsList = 'nodownload';
                                video.preload = 'auto';
                                video.autoplay = index === mediaIndex;
                                video.style.maxHeight = '95vh';
                                video.style.maxWidth = '95vw';
                                video.style.objectFit = 'contain';
                                video.style.backgroundColor = '#000';

                                const source = document.createElement('source');
                                source.src = media.src;
                                source.type = 'video/mp4';

                                video.appendChild(source);
                                video.appendChild(document.createTextNode('Trình duyệt của bạn không hỗ trợ video.'));

                                video.dataset.mediaIndex = index;

                                video.addEventListener('play', function() {
                                    playingVideos.set(index, video);
                                    playingVideos.forEach((vid, idx) => {
                                        if (idx !== index && !vid.paused) {
                                            vid.pause();
                                        }
                                    });
                                });

                                video.addEventListener('pause', function() {
                                    playingVideos.delete(index);
                                });

                                videoContainer.appendChild(video);
                                mediaContainer.appendChild(videoContainer);
                            }

                            carouselItem.appendChild(mediaContainer);
                            modalCarouselInner.appendChild(carouselItem);
                        });

                        // Khởi tạo lại carousel modal
                        const modalCarouselInstance = new bootstrap.Carousel(modalCarousel, {
                            interval: false
                        });

                        // Điều hướng đến media được click
                        modalCarouselInstance.to(mediaIndex);

                        // Cập nhật số slide hiện tại
                        modalCurrentSlideSpan.textContent = mediaIndex + 1;

                        // Cập nhật background mờ
                        updateBlurredBackground(mediaIndex);

                        // Hiển thị modal
                        imageModal.show();
                    });
                }
            });
        });

        // Hàm cập nhật background mờ
        function updateBlurredBackground(slideIndex) {
            blurredBackground.innerHTML = '';

            if (currentPostMedia.length > 0 && slideIndex < currentPostMedia.length) {
                const currentMedia = currentPostMedia[slideIndex];

                if (currentMedia.type === 'image') {
                    const backgroundImage = document.createElement('img');
                    backgroundImage.src = currentMedia.src;
                    backgroundImage.style.width = '100%';
                    backgroundImage.style.height = '100%';
                    backgroundImage.style.objectFit = 'cover';
                    backgroundImage.style.filter = 'blur(20px) brightness(0.3)';
                    backgroundImage.style.position = 'absolute';
                    backgroundImage.style.top = '0';
                    backgroundImage.style.left = '0';

                    blurredBackground.appendChild(backgroundImage);
                } else if (currentMedia.type === 'video') {
                    blurredBackground.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
                }
            }
        }

        // Lắng nghe sự kiện chuyển slide trong modal
        modalCarousel.addEventListener('slide.bs.carousel', function(event) {
            const nextSlide = event.to;
            lastModalMediaIndex = nextSlide;
            modalCurrentSlideSpan.textContent = nextSlide + 1;
            updateBlurredBackground(nextSlide);

            playingVideos.forEach(video => {
                if (!video.paused) {
                    video.pause();
                }
            });
            playingVideos.clear();

            setTimeout(() => {
                const activeItem = modalCarouselInner.querySelector('.carousel-item.active');
                if (activeItem) {
                    const video = activeItem.querySelector('video');
                    if (video) {
                        video.play().catch(e => console.log('Autoplay failed:', e));
                    }
                }
            }, 300);
        });

        // Khi modal đóng
        document.getElementById('imageModal').addEventListener('hidden.bs.modal', function() {
            playingVideos.forEach(video => {
                if (!video.paused) {
                    video.pause();
                }
            });
            playingVideos.clear();

            if (currentPostCarousel && currentPostId) {
                currentPostCarousel.to(lastModalMediaIndex);

                const postCurrentSlideSpan = document.getElementById(`current-slide-${currentPostId}`);
                if (postCurrentSlideSpan) {
                    postCurrentSlideSpan.textContent = lastModalMediaIndex + 1;
                }
            }

            const counterElement = document.querySelector('.carousel-counter-modal');
            if (counterElement) counterElement.style.display = 'block';
            if (prevButton) prevButton.style.display = 'none';
            if (nextButton) nextButton.style.display = 'none';

            currentPostMedia = [];
            currentPostId = null;
            currentPostCarousel = null;
            blurredBackground.innerHTML = '';
            modalCarouselInner.innerHTML = '';
            modalCurrentSlideSpan.textContent = '1';
            modalTotalSlidesSpan.textContent = '0';
        });

    </script>
}