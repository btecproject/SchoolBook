@model SchoolBookPlatform.ViewModels.Post.PostListViewModel
@{
    ViewData["Title"] = "Trang chủ";
    Layout = "~/Views/Shared/_Layout.cshtml";

}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <!-- Thanh chuyển tab giữa Home và Following -->
            <div class="feed-tabs mb-4">
                <ul class="nav nav-tabs" id="feedTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link @(Model.ViewType == "home" ? "active" : "")" 
                           asp-controller="Feeds" asp-action="Home"
                           id="home-tab" role="tab" aria-controls="home" aria-selected="true">
                            <i class="fas fa-home me-1"></i> Trang chủ
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link @(Model.ViewType == "following" ? "active" : "")" 
                           asp-controller="Feeds" asp-action="Following"
                           id="following-tab" role="tab" aria-controls="following" aria-selected="false">
                            <i class="fas fa-user-friends me-1"></i> Đang theo dõi
                        </a>
                    </li>
                </ul>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>
                    @if (Model.ViewType == "home")
                    {
                        <span>Bài đăng gần đây</span>
                    }
                    else
                    {
                        <span>Đang theo dõi</span>
                    }
                </h2>
                <a asp-controller="Post" asp-action="Create" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Đăng bài mới
                </a>
            </div>

            @* Hiển thị thông báo *@
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <!-- Nút test GetIp -->
            @if (ViewContext.RouteData.Values["action"]?.ToString() == "Home" && 
                 ViewContext.RouteData.Values["controller"]?.ToString() == "Feeds")
            {
                <div class="mb-3">
                    <a asp-action="GetIp" asp-controller="Feeds" class="btn btn-outline-success">
                        <i class="fas fa-network-wired me-1"></i> Get Ip Now
                    </a>
                </div>
            }

            @if (TempData["Ip + Info"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["Ip + Info"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            @* Kiểm tra nếu là tab Following và không có bài đăng *@
            @if (Model.ViewType == "following" && !Model.Posts.Any())
            {
                <div class="empty-following text-center py-5">
                    <i class="fas fa-user-friends fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Bạn chưa follow ai</h4>
                    <p class="text-muted">Follow người khác để xem bài đăng của họ tại đây</p>
                    <a href="@Url.Action("Explore", "User")" class="btn btn-primary">
                        <i class="fas fa-search"></i> Khám phá người dùng
                    </a>
                </div>
            }

            @* Modal hiển thị ảnh/video toàn màn hình *@
            <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-fullscreen">
                    <div class="modal-content">
                        <div class="modal-header border-0">
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-0 position-relative">
                            <!-- Background mờ -->
                            <div id="blurredBackground" class="position-absolute top-0 start-0 w-100 h-100"></div>
                            
                            <!-- Carousel Modal -->
                            <div id="modalCarousel" class="carousel slide h-100" data-bs-ride="carousel">
                                <div class="carousel-inner h-100"></div>
                                
                                <!-- Counter cho modal -->
                                <div class="carousel-counter-modal position-absolute top-0 end-0 m-3">
                                    <span id="modalCurrentSlide" class="badge bg-dark bg-opacity-75 p-2">1</span>
                                    <span class="text-white">/</span>
                                    <span id="modalTotalSlides" class="badge bg-dark bg-opacity-75 p-2">0</span>
                                </div>
                                
                                <!-- Navigation buttons -->
                                <button class="carousel-control-prev" type="button" data-bs-target="#modalCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#modalCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @* Danh sách bài đăng *@
            @if (Model.Posts.Any())
            {
                @foreach (var post in Model.Posts)
                {
                    <div class="card mb-3 post-card" data-post-id="@post.Id" style="cursor: pointer;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h5 class="card-title">
                                        @post.Title
                                    </h5>
                                    <p class="card-text">@post.Content</p>
                                    <small class="text-muted">
                                        Đăng bởi: <strong>@post.AuthorName</strong> |
                                        @post.CreatedAt.ToString("g")
                                        @if (!string.IsNullOrEmpty(post.VisibleToRoles) && post.VisibleToRoles != "All")
                                        {
                                            <span class="badge bg-info ms-1">@post.VisibleToRoles</span>
                                        }
                                    </small>
                                </div>
                                
                                <!-- Dropdown cho nút Sửa/Xóa -->
                                @if (post.IsOwner || post.CanDelete)
                                {
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" 
                                                data-bs-toggle="dropdown" aria-expanded="false"
                                                onclick="event.stopPropagation();">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            @if (post.IsOwner)
                                            {
                                                <li>
                                                    <a class="dropdown-item" asp-controller="Post" asp-action="Edit" asp-route-id="@post.Id">
                                                        <i class="fas fa-edit me-2"></i> Sửa bài
                                                    </a>
                                                </li>
                                            }
                                            @if (post.CanDelete)
                                            {
                                                <li>
                                                    <form asp-controller="Post" asp-action="Delete" asp-route-id="@post.Id" method="post" class="d-inline">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="dropdown-item text-danger"
                                                                onclick="event.stopPropagation(); return confirm('Bạn có chắc muốn xóa bài đăng này?');">
                                                            <i class="fas fa-trash me-2"></i> Xóa bài
                                                        </button>
                                                    </form>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                }
                            </div>

                            @* Hiển thị file đính kèm (nếu có) *@
                            
                            @if (post.Attachments.Any())
                            {
                                <div class="mt-3">
                                    @{
                                        // Hàm helper kiểm tra video
                                        bool IsVideoFile(string fileName)
                                        {
                                            if (string.IsNullOrEmpty(fileName))
                                                return false;
                                            var extension = System.IO.Path.GetExtension(fileName).ToLower();
                                            var videoExtensions = new[] { ".mp4", ".avi", ".mov", ".mkv", ".wmv", ".flv", ".webm", ".m4v", ".mpg", ".mpeg" };
                                            return videoExtensions.Contains(extension);
                                        }
                                        
                                        var mediaItems = post.Attachments.Where(a => a.IsImage || IsVideoFile(a.FileName)).ToList();
                                        var files = post.Attachments.Where(a => !a.IsImage && !IsVideoFile(a.FileName)).ToList();
                                    }
                                    
                                    @if (mediaItems.Any())
                                    {
                                        <div id="carousel-@post.Id" class="carousel slide mb-3" data-bs-ride="carousel">
                                            <!-- Counter hiển thị số media -->
                                            <div class="carousel-counter">
                                                <span id="current-slide-@post.Id">1</span> / <span id="total-slides-@post.Id">@mediaItems.Count</span>
                                            </div>
                                            
                                            @if (mediaItems.Count > 1)
                                            {
                                                <div class="carousel-indicators">
                                                    @for (int i = 0; i < mediaItems.Count; i++)
                                                    {
                                                        <button type="button" data-bs-target="#carousel-@post.Id" 
                                                                data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")"
                                                                aria-current="@(i == 0 ? "true" : "false")"></button>
                                                    }
                                                </div>
                                            }
                                            
                                            <div class="carousel-inner rounded">
                                                @for (int i = 0; i < mediaItems.Count; i++)
                                                {
                                                    var media = mediaItems[i];
                                                    <div class="carousel-item @(i == 0 ? "active" : "")" data-slide-index="@(i + 1)">
                                                        @if (media.IsImage)
                                                        {
                                                            <a href="javascript:void(0);" class="d-block media-modal-link" 
                                                               data-post-id="@post.Id"
                                                               data-media-index="@i"
                                                               data-total-media="@mediaItems.Count"
                                                               data-media-type="image">
                                                                <img src="@media.FilePath" 
                                                                     class="d-block w-100 post-media"
                                                                     alt="@media.FileName"
                                                                     data-src="@media.FilePath"
                                                                     data-media-name="@media.FileName"
                                                                     style="max-height: 500px; object-fit: contain; background: #f8f9fa; cursor: pointer;" />
                                                            </a>
                                                        }
                                                        else if (IsVideoFile(media.FileName))
                                                        {
                                                            <div class="video-container position-relative">
                                                                <video class="d-block w-100 post-video"
                                                                       controls
                                                                       controlsList="nodownload"
                                                                       preload="metadata"
                                                                       style="max-height: 500px; object-fit: contain; background: #000; cursor: pointer;"
                                                                       data-src="@media.FilePath"
                                                                       data-media-name="@media.FileName">
                                                                    <source src="@media.FilePath" type="video/mp4">
                                                                    Trình duyệt của bạn không hỗ trợ video.
                                                                </video>
                                                                <a href="javascript:void(0);" class="media-modal-link video-overlay"
                                                                   data-post-id="@post.Id"
                                                                   data-media-index="@i"
                                                                   data-total-media="@mediaItems.Count"
                                                                   data-media-type="video">
                                                                    <div class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center">
                                                                        <div class="video-play-icon bg-dark bg-opacity-50 rounded-circle p-3">
                                                                            <i class="fas fa-play text-white fa-2x"></i>
                                                                        </div>
                                                                    </div>
                                                                </a>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                            
                                            @if (mediaItems.Count > 1)
                                            {
                                                <button class="carousel-control-prev" type="button" data-bs-target="#carousel-@post.Id" data-bs-slide="prev">
                                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                    <span class="visually-hidden">Previous</span>
                                                </button>
                                                <button class="carousel-control-next" type="button" data-bs-target="#carousel-@post.Id" data-bs-slide="next">
                                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                    <span class="visually-hidden">Next</span>
                                                </button>
                                            }
                                        </div>
                                    }
                                    
                                    @if (files.Any())
                                    {
                                        <div class="file-list">
                                            <small class="text-muted d-block mb-2">File đính kèm:</small>
                                            @foreach (var file in files)
                                            {
                                                <a href="@file.FilePath" target="_blank" 
                                                   class="d-flex align-items-center text-decoration-none text-dark p-2 border rounded mb-2">
                                                    @{
                                                        var icon = "fa-file";
                                                        var extension = System.IO.Path.GetExtension(file.FileName).ToLower();
                                                        var color = "#6c757d";
                                                        
                                                        if (extension == ".pdf") { icon = "fa-file-pdf"; color = "#dc3545"; }
                                                        else if (extension == ".doc" || extension == ".docx") { icon = "fa-file-word"; color = "#0d6efd"; }
                                                        else if (extension == ".xls" || extension == ".xlsx") { icon = "fa-file-excel"; color = "#198754"; }
                                                        else if (extension == ".ppt" || extension == ".pptx") { icon = "fa-file-powerpoint"; color = "#fd7e14"; }
                                                        else if (extension == ".zip" || extension == ".rar") { icon = "fa-file-archive"; color = "#6f42c1"; }
                                                        else if (extension == ".mp4" || extension == ".avi" || extension == ".mov" || extension == ".mkv") { 
                                                            icon = "fa-file-video"; color = "#9c27b0"; 
                                                        }
                                                    }
                                                    <i class="fas @icon fa-2x me-3" style="color: @color;"></i>
                                                    <div class="flex-grow-1">
                                                        <div class="fw-medium text-truncate" style="max-width: 300px;">@file.FileName</div>
                                                        <small class="text-muted">@((file.FileSize / 1024f / 1024f).ToString("F2")) MB</small>
                                                    </div>
                                                    <i class="fas fa-download text-primary"></i>
                                                </a>
                                            }
                                        </div>
                                    }
                                </div>
                            }

                            <div class="mt-3 d-flex align-items-center gap-2" onclick="event.stopPropagation();">
                                <!-- Nút Upvote và Downvote với tổng điểm -->
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-danger vote-btn"
                                            data-post-id="@post.Id"
                                            data-vote-type="false">
                                        <i class="fas fa-thumbs-down"></i>
                                    </button>
                                    
                                    <span class="btn btn-sm btn-light disabled vote-score"
                                          data-post-id="@post.Id"
                                          style="min-width: 50px; pointer-events: none;">
                                        @{
                                            // Tính điểm tổng: Upvote - Downvote
                                            // Nếu dưới 0 thì hiển thị 0
                                            var score = post.UpvoteCount - post.DownvoteCount;
                                            var displayScore = score < 0 ? 0 : score;
                                            // Không cần dấu + nữa
                                        }
                                        @displayScore
                                    </span>
                                    
                                    <button class="btn btn-sm btn-outline-primary vote-btn"
                                            data-post-id="@post.Id"
                                            data-vote-type="true">
                                        <i class="fas fa-thumbs-up"></i>
                                    </button>
                                </div>

                                <!-- Nút bình luận -->
                                <a asp-controller="Post" asp-action="Details" asp-route-id="@post.Id" 
                                   class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation();">
                                    <i class="fas fa-comment me-1"></i> @post.CommentCount
                                </a>
                            </div>
                        </div>
                    </div>
                }
            }
            else if (Model.ViewType == "home")
            {
                @* Tab "Home" không có bài đăng *@
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Chưa có bài đăng nào. Hãy <a asp-controller="Post" asp-action="Create">đăng bài đầu tiên</a>!
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Xử lý click vào bài đăng để đi đến trang chi tiết
    document.querySelectorAll('.post-card').forEach(card => {
        card.addEventListener('click', function() {
            const postId = this.dataset.postId;
            window.location.href = `/Post/Details/${postId}`;
        });
    });

    // Xử lý vote với AJAX
    document.querySelectorAll('.vote-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.stopPropagation(); // Ngăn chặn sự kiện click lan ra card
            
            const postId = this.dataset.postId;
            const isUpvote = this.dataset.voteType === 'true';

            try {
                const response = await fetch('/Feeds/Vote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `postId=${postId}&isUpvote=${isUpvote}`
                });

                const data = await response.json();
                if (data.success) {
                    // Tính toán điểm tổng mới (Upvote - Downvote)
                    const newScore = data.upvoteCount - data.downvoteCount;
                    // Nếu dưới 0 thì hiển thị 0
                    const displayScore = newScore < 0 ? 0 : newScore;
                    
                    // Cập nhật điểm số
                    const scoreElement = document.querySelector(`.vote-score[data-post-id="${postId}"]`);
                    if (scoreElement) {
                        scoreElement.textContent = displayScore;
                        
                        // Thêm hiệu ứng
                        scoreElement.classList.add('score-updated');
                        setTimeout(() => {
                            scoreElement.classList.remove('score-updated');
                        }, 500);
                    }
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi vote');
            }
        });
    });

    // JavaScript để cập nhật số đếm khi chuyển slide trong carousel post
    document.querySelectorAll('.carousel').forEach(carousel => {
        const carouselId = carousel.id;
        const currentSlideSpan = document.getElementById(`current-slide-${carouselId.replace('carousel-', '')}`);
        const totalSlidesSpan = document.getElementById(`total-slides-${carouselId.replace('carousel-', '')}`);

        if (currentSlideSpan && totalSlidesSpan) {
            // Lắng nghe sự kiện slide.bs.carousel
            carousel.addEventListener('slide.bs.carousel', function (event) {
                const activeSlide = event.to;
                currentSlideSpan.textContent = activeSlide + 1;
            });
        }
    });

    // JavaScript để xử lý modal media toàn màn hình
    document.addEventListener('DOMContentLoaded', function() {
        const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
        const modalCarousel = document.getElementById('modalCarousel');
        const modalCarouselInner = modalCarousel.querySelector('.carousel-inner');
        const modalCurrentSlideSpan = document.getElementById('modalCurrentSlide');
        const modalTotalSlidesSpan = document.getElementById('modalTotalSlides');
        const blurredBackground = document.getElementById('blurredBackground');
        const prevButton = modalCarousel.querySelector('.carousel-control-prev');
        const nextButton = modalCarousel.querySelector('.carousel-control-next');

        let currentPostMedia = [];
        let currentPostId = null;
        let currentPostCarousel = null;
        let lastModalMediaIndex = 0; // Lưu vị trí media cuối cùng trong modal
        let playingVideos = new Map(); // Lưu các video đang phát

        // Biến lưu trữ tất cả media của bài post
        const postMediaMap = new Map();

        // Biến lưu trữ carousel instances
        const postCarousels = new Map();

        // Khởi tạo dữ liệu media cho từng bài post và carousel instances
        document.querySelectorAll('.card').forEach(card => {
            const postId = card.querySelector('.media-modal-link')?.dataset?.postId;
            if (postId) {
                const mediaItems = [];
                card.querySelectorAll('.carousel-item').forEach((item, index) => {
                    const videoElement = item.querySelector('video');
                    const imgElement = item.querySelector('img');

                    if (videoElement) {
                        mediaItems.push({
                            type: 'video',
                            src: videoElement.dataset.src || videoElement.querySelector('source')?.src,
                            alt: videoElement.dataset.mediaName || '',
                            name: videoElement.dataset.mediaName || '',
                            element: videoElement
                        });
                    } else if (imgElement) {
                        mediaItems.push({
                            type: 'image',
                            src: imgElement.dataset.src || imgElement.src,
                            alt: imgElement.alt,
                            name: imgElement.dataset.mediaName || '',
                            element: imgElement
                        });
                    }
                });
                postMediaMap.set(postId, mediaItems);

                // Lưu carousel instance
                const carouselElement = document.getElementById(`carousel-${postId}`);
                if (carouselElement) {
                    const carouselInstance = new bootstrap.Carousel(carouselElement);
                    postCarousels.set(postId, carouselInstance);
                }
            }
        });

        // Lắng nghe click vào media
        document.querySelectorAll('.media-modal-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const postId = this.dataset.postId;
                const mediaIndex = parseInt(this.dataset.mediaIndex);
                const totalMedia = parseInt(this.dataset.totalMedia);
                const mediaType = this.dataset.mediaType;

                currentPostId = postId;
                currentPostMedia = postMediaMap.get(postId) || [];
                currentPostCarousel = postCarousels.get(postId);
                lastModalMediaIndex = mediaIndex; // Lưu vị trí bắt đầu

                // Cập nhật tổng số media
                modalTotalSlidesSpan.textContent = currentPostMedia.length;

                // Ẩn/Hiện counter và nút điều hướng dựa trên số lượng media
                const counterElement = document.querySelector('.carousel-counter-modal');
                if (currentPostMedia.length <= 1) {
                    // Ẩn counter và nút điều hướng nếu chỉ có 1 media
                    if (counterElement) counterElement.style.display = 'none';
                    if (prevButton) prevButton.style.display = 'none';
                    if (nextButton) nextButton.style.display = 'none';
                } else {
                    // Hiện counter và nút điều hướng nếu có nhiều media
                    if (counterElement) counterElement.style.display = 'block';
                    if (prevButton) prevButton.style.display = 'flex';
                    if (nextButton) nextButton.style.display = 'flex';
                }

                // Xóa nội dung carousel cũ
                modalCarouselInner.innerHTML = '';

                // Thêm các media vào carousel modal
                currentPostMedia.forEach((media, index) => {
                    const carouselItem = document.createElement('div');
                    carouselItem.className = `carousel-item h-100 ${index === mediaIndex ? 'active' : ''}`;

                    const mediaContainer = document.createElement('div');
                    mediaContainer.className = 'd-flex justify-content-center align-items-center h-100';

                    if (media.type === 'image') {
                        const img = document.createElement('img');
                        img.src = media.src;
                        img.alt = media.alt;
                        img.className = 'img-fluid modal-media';
                        img.style.maxHeight = '95vh';
                        img.style.maxWidth = '95vw';
                        img.style.objectFit = 'contain';
                        img.style.cursor = 'pointer';

                        // Thêm sự kiện click để đóng modal khi click vào ảnh
                        img.addEventListener('click', function() {
                            imageModal.hide();
                        });

                        mediaContainer.appendChild(img);
                    } else if (media.type === 'video') {
                        const videoContainer = document.createElement('div');
                        videoContainer.className = 'position-relative w-100 h-100';

                        const video = document.createElement('video');
                        video.className = 'modal-video';
                        video.controls = true;
                        video.controlsList = 'nodownload';
                        video.preload = 'auto';
                        video.autoplay = index === mediaIndex; // Tự động phát video khi mở modal
                        video.style.maxHeight = '95vh';
                        video.style.maxWidth = '95vw';
                        video.style.objectFit = 'contain';
                        video.style.backgroundColor = '#000';

                        const source = document.createElement('source');
                        source.src = media.src;
                        source.type = 'video/mp4';

                        video.appendChild(source);
                        video.appendChild(document.createTextNode('Trình duyệt của bạn không hỗ trợ video.'));

                        // Lưu tham chiếu video để quản lý
                        video.dataset.mediaIndex = index;

                        // Thêm sự kiện để quản lý trạng thái phát
                        video.addEventListener('play', function() {
                            playingVideos.set(index, video);

                            // Dừng các video khác đang phát
                            playingVideos.forEach((vid, idx) => {
                                if (idx !== index && !vid.paused) {
                                    vid.pause();
                                }
                            });
                        });

                        video.addEventListener('pause', function() {
                            playingVideos.delete(index);
                        });

                        videoContainer.appendChild(video);
                        mediaContainer.appendChild(videoContainer);
                    }

                    carouselItem.appendChild(mediaContainer);
                    modalCarouselInner.appendChild(carouselItem);
                });

                // Khởi tạo lại carousel modal
                const modalCarouselInstance = new bootstrap.Carousel(modalCarousel, {
                    interval: false
                });

                // Điều hướng đến media được click
                modalCarouselInstance.to(mediaIndex);

                // Cập nhật số slide hiện tại
                modalCurrentSlideSpan.textContent = mediaIndex + 1;

                // Cập nhật background mờ (chỉ cho ảnh)
                updateBlurredBackground(mediaIndex);

                // Hiển thị modal
                imageModal.show();
            });
        });

        // Lắng nghe sự kiện chuyển slide trong modal
        modalCarousel.addEventListener('slide.bs.carousel', function(event) {
            const nextSlide = event.to;
            lastModalMediaIndex = nextSlide; // Cập nhật vị trí cuối cùng
            modalCurrentSlideSpan.textContent = nextSlide + 1;
            updateBlurredBackground(nextSlide);

            // Dừng video hiện tại khi chuyển slide
            playingVideos.forEach(video => {
                if (!video.paused) {
                    video.pause();
                }
            });
            playingVideos.clear();

            // Tự động phát video nếu slide mới là video
            setTimeout(() => {
                const activeItem = modalCarouselInner.querySelector('.carousel-item.active');
                if (activeItem) {
                    const video = activeItem.querySelector('video');
                    if (video) {
                        video.play().catch(e => console.log('Autoplay failed:', e));
                    }
                }
            }, 300);
        });

        // Khi modal đóng, cập nhật carousel trong post và reset UI
        document.getElementById('imageModal').addEventListener('hidden.bs.modal', function() {
            // Dừng tất cả video đang phát
            playingVideos.forEach(video => {
                if (!video.paused) {
                    video.pause();
                }
            });
            playingVideos.clear();

            if (currentPostCarousel && currentPostId) {
                // Chuyển carousel trong post đến vị trí media cuối cùng xem trong modal
                currentPostCarousel.to(lastModalMediaIndex);

                // Cập nhật counter trong post
                const postCurrentSlideSpan = document.getElementById(`current-slide-${currentPostId}`);
                if (postCurrentSlideSpan) {
                    postCurrentSlideSpan.textContent = lastModalMediaIndex + 1;
                }
            }

            // Hiển thị lại counter và nút điều hướng (để chuẩn bị cho lần mở tiếp theo)
            const counterElement = document.querySelector('.carousel-counter-modal');
            if (counterElement) counterElement.style.display = 'block';
            if (prevButton) prevButton.style.display = 'none'; // Vẫn ẩn mặc định
            if (nextButton) nextButton.style.display = 'none'; // Vẫn ẩn mặc định

            // Reset biến
            currentPostMedia = [];
            currentPostId = null;
            currentPostCarousel = null;
            blurredBackground.innerHTML = '';
            modalCarouselInner.innerHTML = '';
            modalCurrentSlideSpan.textContent = '1';
            modalTotalSlidesSpan.textContent = '0';
        });

        // Hàm cập nhật background mờ (chỉ cho ảnh)
        function updateBlurredBackground(slideIndex) {
            blurredBackground.innerHTML = '';

            if (currentPostMedia.length > 0 && slideIndex < currentPostMedia.length) {
                const currentMedia = currentPostMedia[slideIndex];

                // Chỉ tạo background mờ cho ảnh
                if (currentMedia.type === 'image') {
                    const backgroundImage = document.createElement('img');
                    backgroundImage.src = currentMedia.src;
                    backgroundImage.style.width = '100%';
                    backgroundImage.style.height = '100%';
                    backgroundImage.style.objectFit = 'cover';
                    backgroundImage.style.filter = 'blur(20px) brightness(0.3)';
                    backgroundImage.style.position = 'absolute';
                    backgroundImage.style.top = '0';
                    backgroundImage.style.left = '0';

                    blurredBackground.appendChild(backgroundImage);
                } else if (currentMedia.type === 'video') {
                    // Video không có background mờ, chỉ hiển thị background tối
                    blurredBackground.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
                }
            }
        }

        // Lắng nghe click vào nút đóng modal
        document.querySelector('#imageModal .btn-close').addEventListener('click', function() {
            imageModal.hide();
        });

        // Cho phép đóng modal bằng phím ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && imageModal._isShown) {
                imageModal.hide();
            }

            // Thêm phím mũi tên để chuyển media (chỉ khi có nhiều hơn 1 media)
            if (imageModal._isShown && currentPostMedia.length > 1) {
                const carouselInstance = bootstrap.Carousel.getInstance(modalCarousel);
                if (e.key === 'ArrowLeft') {
                    carouselInstance.prev();
                } else if (e.key === 'ArrowRight') {
                    carouselInstance.next();
                }
            }
        });

        // Click bên ngoài media để đóng modal
        document.getElementById('imageModal').addEventListener('click', function(e) {
            // Chỉ đóng khi click vào background, không phải vào media
            if (e.target === this ||
                (e.target.classList.contains('modal-body') &&
                    !e.target.closest('.carousel-item') &&
                    !e.target.closest('.modal-video') &&
                    !e.target.closest('.modal-media'))) {
                imageModal.hide();
            }
        });
    });
</script>
}