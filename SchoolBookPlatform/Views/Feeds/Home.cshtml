@model IEnumerable<SchoolBookPlatform.ViewModels.PostViewModel>

@{
    ViewData["Title"] = "Trang chủ";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-4">
    <h2 class="mb-4">Bài viết mới nhất</h2>

    <div class="mb-3">
        <a asp-area="" asp-controller="Post" asp-action="Create" class="btn btn-primary">➕ Tạo bài viết mới</a>
    </div>

    @if (!Model.Any())
    {
        <p class="text-muted">Chưa có bài viết nào.</p>
    }
    else
    {
        foreach (var post in Model)
        {
            <div class="card mb-4 shadow-sm" id="post-@post.Id">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <p class="text-muted mb-0">
                            <strong>@post.UserName</strong> 
                            • @post.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                        </p>
                        
                        <!-- Nút 3 chấm dropdown -->
                        @if (post.CanEdit || post.CanDelete)
                        {
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                        type="button" 
                                        data-bs-toggle="dropdown" 
                                        aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    @if (post.CanEdit)
                                    {
                                        <li>
                                            <a class="dropdown-item" href="/Post/Edit/@post.Id">
                                                <i class="fas fa-edit me-2"></i>Chỉnh sửa
                                            </a>
                                        </li>
                                    }
                                    @if (post.CanDelete)
                                    {
                                        <li>
                                            <hr class="dropdown-divider">
                                        </li>
                                        <li>
                                            <button class="dropdown-item text-danger" 
                                                    onclick="confirmDelete('@post.Id', '@post.Title')">
                                                <i class="fas fa-trash me-2"></i>Xóa bài đăng
                                            </button>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>

                    <h4 class="card-title">
                        <a href="/Post/Details/@post.Id" class="text-decoration-none">@post.Title</a>
                    </h4>

                    @if (post.UpdatedAt.HasValue)
                    {
                        <small class="text-muted">Chỉnh sửa: @post.UpdatedAt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</small>
                    }

                    <div class="mb-3">
                        @if (!string.IsNullOrEmpty(post.Content))
                        {
                            <p class="card-text">
                                @(post.Content.Length > 150 ? post.Content.Substring(0, 150) + "..." : post.Content)
                            </p>
                        }
                    </div>

                    <!-- Thống kê và tương tác -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex gap-3">
                            <span class="text-success">
                                <i class="fas fa-thumbs-up"></i> @post.UpvoteCount
                            </span>
                            <span class="text-danger">
                                <i class="fas fa-thumbs-down"></i> @post.DownvoteCount
                            </span>
                            <span class="text-primary">
                                <i class="fas fa-comments"></i> @post.CommentCount
                            </span>
                            @if (post.AttachmentCount > 0)
                            {
                                <span class="text-info">
                                    <i class="fas fa-paperclip"></i> @post.AttachmentCount
                                </span>
                            }
                        </div>

                        <!-- Vote buttons -->
                        <div class="btn-group btn-group-sm">
                            <button class="btn @(post.CurrentUserVote == true ? "btn-success" : "btn-outline-success")">
                                <i class="fas fa-thumbs-up"></i>
                            </button>
                            <button class="btn @(post.CurrentUserVote == false ? "btn-danger" : "btn-outline-danger")">
                                <i class="fas fa-thumbs-down"></i>
                            </button>
                        </div>
                    </div>

                    <!-- File đính kèm -->
                    @if (post.Attachments.Any())
                    {
                        <div class="mb-3">
                            <h6>File đính kèm:</h6>
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var attachment in post.Attachments)
                                {
                                    <div class="border rounded p-2">
                                        <small>
                                            <i class="fas fa-file @GetFileIcon(attachment.FileType) me-1"></i>
                                            @attachment.FileName
                                            <br>
                                            <span class="text-muted">@attachment.FileSizeFormatted</span>
                                        </small>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Comment preview -->
                    @if (post.Comments.Any())
                    {
                        <div class="border-top pt-3">
                            <h6>Bình luận:</h6>
                            @foreach (var comment in post.Comments.Take(2))
                            {
                                <div class="mb-2">
                                    <strong>@comment.UserName:</strong>
                                    <span>@(comment.Content.Length > 50 ? comment.Content.Substring(0, 50) + "..." : comment.Content)</span>
                                    @if (comment.ReplyCount > 0)
                                    {
                                        <small class="text-muted">(+@comment.ReplyCount phản hồi)</small>
                                    }
                                </div>
                            }
                            @if (post.Comments.Count > 2)
                            {
                                <small class="text-muted">Và @(post.Comments.Count - 2) bình luận khác...</small>
                            }
                        </div>
                    }

                    <!-- Action buttons -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <a href="/Post/Details/@post.Id" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-eye"></i> Xem chi tiết
                            </a>
                        </div>

                        @if (post.CanReport)
                        {
                            <button class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-flag"></i> Báo cáo
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

<!-- Modal xác nhận xóa -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa bài viết "<strong id="postTitleToDelete"></strong>"?</p>
                <p class="text-danger">Hành động này sẽ xóa vĩnh viễn:</p>
                <ul class="text-danger">
                    <li>Bài viết</li>
                    <li>Tất cả file đính kèm</li>
                    <li>Tất cả bình luận</li>
                    <li>Tất cả lượt vote</li>
                    <li>Tất cả báo cáo</li>
                </ul>
                <p class="text-danger"><strong>Hành động này không thể hoàn tác.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa vĩnh viễn</button>
            </div>
        </div>
    </div>
</div>

@functions {
    private string GetFileIcon(string fileType)
    {
        return fileType switch
        {
            "PDF" => "fa-file-pdf text-danger",
            "Word" => "fa-file-word text-primary",
            "Excel" => "fa-file-excel text-success",
            "PowerPoint" => "fa-file-powerpoint text-warning",
            "Image" => "fa-file-image text-info",
            "Video" => "fa-file-video text-purple",
            "Audio" => "fa-file-audio text-secondary",
            "Archive" => "fa-file-archive text-warning",
            _ => "fa-file text-muted"
        };
    }
}

@section Scripts {
    <script>
        let currentPostId = null;

        function confirmDelete(postId, postTitle) {
            currentPostId = postId;
            
            document.getElementById('postTitleToDelete').textContent = postTitle;
            
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (!currentPostId) return;

            const deleteBtn = this;
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xóa...';
            deleteBtn.disabled = true;

            // 🔥 SỬ DỤNG MINIMAL API - KHÔNG CẦN FORM DATA HAY TOKEN
            fetch(`/api/posts/${currentPostId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    // Nếu lỗi 401 (Unauthorized), chuyển hướng đến trang login
                    if (response.status === 401) {
                        window.location.href = '/Authen/Login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Delete success:', data);
                
                // Ẩn modal
                const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                deleteModal.hide();
                
                // Xóa bài viết khỏi DOM ngay lập tức
                const postElement = document.getElementById('post-' + currentPostId);
                if (postElement) {
                    postElement.style.transition = 'all 0.3s ease';
                    postElement.style.opacity = '0';
                    postElement.style.transform = 'translateX(-100px)';
                    
                    setTimeout(() => {
                        postElement.remove();
                        showAlert(data.message, 'success');
                        
                        // Nếu không còn bài viết nào
                        if (document.querySelectorAll('.card').length === 0) {
                            document.querySelector('.container').innerHTML += `
                                <div class="text-center py-5">
                                    <p class="text-muted">Không còn bài viết nào để hiển thị.</p>
                                </div>
                            `;
                        }
                    }, 300);
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                showAlert('Có lỗi xảy ra khi xóa bài viết. Vui lòng thử lại.', 'danger');
            })
            .finally(() => {
                // Khôi phục nút
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
                currentPostId = null;
            });
        });

        function showAlert(message, type) {
            const existingAlert = document.querySelector('.alert-position');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-position`;
            alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
}