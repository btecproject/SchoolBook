@model List<SchoolBookPlatform.ViewModels.Admin.UserListViewModel>

@{
    ViewData["Title"] = "Quản lý người dùng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0"><i class="bi bi-people-fill text-primary"></i> Quản lý người dùng</h2>
            <small class="text-muted">Tổng cộng: <strong>@Model.Count</strong> tài khoản</small>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#importExcelModal">
                <i class="bi bi-file-earmark-excel"></i> Import từ Excel
            </button>
            <a asp-action="Create" class="btn btn-primary btn-lg">
                <i class="bi bi-plus-circle"></i> Tạo user mới
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-check-circle-fill"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    <div class="card border-0 shadow-sm rounded-3 mb-3">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-3">
                    <label for="roleFilter" class="form-label fw-bold mb-1">
                        <i class="bi bi-funnel"></i> Lọc theo vai trò
                    </label>
                    <select id="roleFilter" class="form-select form-select-lg">
                        <option value="all" selected>Tất cả vai trò</option>
                        <option value="HighAdmin">HighAdmin</option>
                        <option value="Admin">Admin</option>
                        <option value="Moderator">Moderator</option>
                        <option value="Teacher">Teacher</option>
                        <option value="Student">Student</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label fw-bold mb-1">
                        <i class="bi bi-funnel"></i> Lọc theo trạng thái
                    </label>
                    <select id="statusFilter" class="form-select form-select-lg">
                        <option value="all" selected>Tất cả trạng thái</option>
                        <option value="active">Hoạt động</option>
                        <option value="inactive">Bị khóa</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="searchInput" class="form-label fw-bold mb-1" >
                        <i class="bi bi-search"></i> Tìm kiếm
                    </label>
                    <input type="text" 
                           id="searchInput" 
                           class="form-control form-control-lg" 
                           placeholder="Tìm theo username, email..."
                           name = "search_q"
                           readonly
                           onfocus="this.removeAttribute('readonly')"
                           autocomplete="off">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-secondary btn-lg w-100" onclick="resetFilters()">
                        <i class="bi bi-x-circle"></i> Xóa lọc
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card border-0 shadow-lg rounded-3 overflow-hidden">
        <div class="card-header bg-gradient bg-primary text-white py-3">
            <h5 class="mb-0"><i class="bi bi-table"></i> Danh sách tài khoản</h5>
        </div>
        <div class="card-body p-0">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle" id="usersTable">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Người dùng</th>
                                <th>Email</th>
                                <th>SĐT</th>
                                <th>Vai trò</th>
                                <th>Trạng thái</th>
                                <th>Khuôn mặt</th>
                                <th>Ngày tạo</th>
                                <th class="text-center">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            @foreach (var user in Model)
                            {
                                <tr class="user-row" data-user-id="@user.Id">
                                    <td class="ps-4">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm me-3 bg-primary text-white rounded-circle d-flex align-items-center justify-content-center">
                                                @(user.Username?[0].ToString().ToUpper() ?? "?")
                                            </div>
                                            <div>
                                                <a asp-controller="Profile" asp-action="Index" asp-route-username="@user.Username"
                                                   class="fw-bold text-decoration-none hover-primary">
                                                    @user.Username
                                                </a>
                                                <br><small class="text-muted">@user.Id.ToString()[..8]...</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="text-primary">@(user.Email ?? "-")</span></td>
                                    <td>@(user.PhoneNumber ?? "-")</td>
                                    <td>
                                        @foreach (var role in user.Roles)
                                        {
                                            var (bg, fg) = role switch
                                            {
                                                "HighAdmin" => ("bg-danger", "text-white"),
                                                "Admin" => ("bg-warning", "text-dark"),
                                                "Moderator" => ("bg-info", "text-white"),
                                                "Teacher" => ("bg-success", "text-white"),
                                                "Student" => ("bg-secondary", "text-white"),
                                                _ => ("bg-light", "text-dark")
                                            };
                                            <span class="badge @bg @fg px-3 py-2 me-1">@role</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @(user.IsActive ? "bg-success" : "bg-danger") px-3 py-2">
                                            @(user.IsActive ? "Hoạt động" : "Bị khóa")
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <i class="bi @(user.FaceRegistered ? "bi-person-check-fill text-success" : "bi-person-x text-muted") fs-4"></i>
                                    </td>
                                    <td><small>@user.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small></td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a asp-action="Edit" asp-route-id="@user.Id" 
                                               class="btn btn-outline-primary btn-sm" 
                                               title="Chỉnh sửa thông tin">
                                                <i class="bi bi-pencil-square"></i>
                                            </a>
        
                                            <button type="button" 
                                                    class="btn btn-outline-warning btn-sm" 
                                                    onclick="showResetPasswordModal('@user.Id', '@user.Username')"
                                                    title="Đặt lại mật khẩu">
                                                <i class="bi bi-key"></i>
                                            </button>
        
                                            <button type="button" 
                                                    class="btn btn-outline-danger btn-sm" 
                                                    onclick="revokeTokens('@user.Id', '@user.Username')"
                                                    title="Hủy tất cả phiên đăng nhập">
                                                <i class="bi bi-shield-x"></i>
                                            </button>
        
                                            <button type="button" 
                                                    class="btn @(user.IsActive ? "btn-outline-dark" : "btn-outline-success") btn-sm"
                                                    onclick="@(user.IsActive ? "disableUser" : "enableUser")('@user.Id', '@user.Username')"
                                                    title="@(user.IsActive ? "Vô hiệu hóa tài khoản" : "Kích hoạt tài khoản")">
                                                <i class="bi @(user.IsActive ? "bi-lock" : "bi-unlock")"></i>
                                            </button>
        
                                            <a asp-action="Delete" asp-route-id="@user.Id" 
                                               class="btn btn-outline-danger btn-sm"
                                               title="Xóa tài khoản vĩnh viễn">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-people display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">Chưa có người dùng nào</h4>
                    <p class="text-muted">Bắt đầu bằng cách import từ Excel hoặc tạo tài khoản mới.</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal Import Excel -->
<div class="modal fade" id="importExcelModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-file-earmark-excel"></i> Import danh sách học sinh từ Excel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="importForm" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label class="form-label fw-bold">File Excel (.xlsx)</label>
                        <input type="file" name="excelFile" accept=".xlsx" class="form-control form-control-lg" required />
                        <div class="form-text mt-2">
                            <strong>Cấu trúc file:</strong><br>
                            Cột A: Họ và tên (VD: Nguyễn Văn A)<br>
                            Cột B: Mã sinh viên (VD: ABC123)<br>
                            Cột C: Email (VD: abc123@gmail.com)<br>
                            Cột D: Số điện thoại (tùy chọn)
                        </div>
                        <a href="/sample-import.xlsx" class="btn btn-outline-info btn-sm mt-2">
                            <i class="bi bi-download"></i> Tải file mẫu
                        </a>
                    </div>

                    <div id="progressSection" class="mt-4" style="display:none;">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-bold">Đang xử lý...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress" style="height: 32px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%">0%</div>
                        </div>
                        <div class="mt-3 text-center">
                            <small>
                                Đã xử lý: <strong id="processed">0</strong> / <strong id="total">0</strong> | 
                                Thành công: <strong id="successCount">0</strong>
                            </small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-success btn-lg px-5" id="btnStartImport">
                    <span id="importSpinner" class="spinner-border spinner-border-sm me-2 d-none"></span>
                    <i class="bi bi-upload"></i> Bắt đầu Import
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Reset Password -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset mật khẩu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Reset mật khẩu cho user: <strong id="resetPasswordUsername"></strong></p>
                <div class="mb-3">
                    <label for="newPassword" class="form-label">Mật khẩu mới</label>
                    <input type="password" class="form-control" id="newPassword" minlength="6" required>
                    <small class="text-muted">Mật khẩu phải chứa ít nhất một chữ cái viết hoa, một chữ cái viết thường, một số và một ký tự đặc biệt.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="confirmResetPassword()">Reset</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        function filterUsers() {
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            const rows = document.querySelectorAll('#usersTableBody tr.user-row');
            let visibleCount = 0;

            rows.forEach(row => {
                let showRow = true;

                // Lọc theo role
                if (roleFilter !== 'all') {
                    const roleBadges = row.querySelectorAll('td:nth-child(4) .badge');
                    const hasRole = Array.from(roleBadges).some(badge =>
                        badge.textContent.trim() === roleFilter
                    );
                    if (!hasRole) showRow = false;
                }

                // Lọc theo trạng thái
                if (statusFilter !== 'all') {
                    const statusBadge = row.querySelector('td:nth-child(5) .badge');
                    const isActive = statusBadge.classList.contains('bg-success');
                    if (statusFilter === 'active' && !isActive) showRow = false;
                    if (statusFilter === 'inactive' && isActive) showRow = false;
                }

                // Tìm kiếm theo username hoặc email
                if (searchTerm) {
                    const username = row.querySelector('td:nth-child(1) a')?.textContent.toLowerCase() || '';
                    const email = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                    const phone = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';

                    if (!username.includes(searchTerm) &&
                        !email.includes(searchTerm) &&
                        !phone.includes(searchTerm)) {
                        showRow = false;
                    }
                }

                // Hiển thị hoặc ẩn row
                if (showRow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Cập nhật số lượng hiển thị
            document.getElementById('visibleUsers').textContent = visibleCount;
        }

        function resetFilters() {
            document.getElementById('roleFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('searchInput').value = '';
            filterUsers();
        }

        // Gắn sự kiện
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('roleFilter').addEventListener('change', filterUsers);
            document.getElementById('statusFilter').addEventListener('change', filterUsers);
            document.getElementById('searchInput').addEventListener('input', filterUsers);

            // Khởi tạo Bootstrap tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });



        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/importExcelHub")
            .configureLogging(signalR.LogLevel.Information)
            .build();

        connection.on("ImportProgress", function (data) {
            $("#progressSection").show();
            $("#processed").text(data.Current);
            $("#total").text(data.Total);
            $("#successCount").text(data.Success);

            const percent = Math.round((data.Current / data.Total) * 100);
            $("#progressBar").css("width", percent + "%").text(percent + "%");
            $("#progressPercent").text(percent + "%");

            // Thêm dòng mới vào bảng
            const avatarLetter = data.Username ? data.Username[0].toUpperCase() : "?";
            const row = `
                <tr class="table-success animate__animated animate__fadeIn">
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <div class="avatar avatar-sm me-3 bg-success text-white rounded-circle">${avatarLetter}</div>
                            <div>
                                <a href="/Profile/${data.Username}" class="fw-bold text-success">${data.Username}</a><br>
                                <small class="text-success"><i class="bi bi-star-fill"></i> Vừa được tạo</small>
                            </div>
                        </div>
                    </td>
                    <td><span class="text-primary">${data.Email || "-"}</span></td>
                    <td>-</td>
                    <td><span class="badge bg-secondary text-white px-3 py-2">Student</span></td>
                    <td><span class="badge bg-success px-3 py-2">Hoạt động</span></td>
                    <td class="text-center"><i class="bi bi-person-x text-muted fs-4"></i></td>
                    <td><small>Vừa xong</small></td>
                    <td class="text-center text-success"><i class="bi bi-check-circle-fill fs-3"></i></td>
                </tr>`;
            $("#usersTableBody").prepend(row);

            // Cập nhật số lượng
            const totalUsers = parseInt(document.getElementById('totalUsers').textContent) + 1;
            document.getElementById('totalUsers').textContent = totalUsers;
            filterUsers(); // Áp dụng lại filter
        });

        connection.start().catch(err => console.error("SignalR Error:", err));

        $("#btnStartImport").click(function () {
            const fileInput = $("#importForm input[name='excelFile']")[0];
            if (!fileInput.files.length) {
                alert("Vui lòng chọn file Excel!");
                return;
            }

            const formData = new FormData($("#importForm")[0]);

            $("#importSpinner").removeClass("d-none");
            $(this).prop("disabled", true);
            $("#progressSection").hide();

            fetch("/Admin/ImportStudentsFromExcel", {
                method: "POST",
                body: formData,
                headers: { "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert(`Import thành công! Đã tạo ${data.count} tài khoản mới.`);
                } else {
                    alert("Lỗi: " + data.message);
                }
            })
            .finally(() => {
                $("#importSpinner").addClass("d-none");
                $("#btnStartImport").prop("disabled", false);
            });
        });

        let currentResetUserId = null;
        function showResetPasswordModal(userId, username) {
            currentResetUserId = userId;
            document.getElementById('resetPasswordUsername').textContent = username;
            document.getElementById('newPassword').value = '';
            new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
        }

        function confirmResetPassword() {
            const newPassword = document.getElementById('newPassword').value;
            if (!newPassword || newPassword.length < 6) {
                alert('Mật khẩu phải có ít nhất 6 ký tự!');
                return;
            }

            fetch('@Url.Action("ResetPassword", "Admin")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    id: currentResetUserId,
                    newPassword: newPassword
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra!');
                });
        }

        function revokeTokens(userId, username) {
            if (!confirm(`Bạn có chắc muốn hủy tất cả tokens của user "${username}"? User sẽ bị đăng xuất khỏi tất cả thiết bị.`)) {
                return;
            }

            fetch('@Url.Action("RevokeTokens", "Admin")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ id: userId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra!');
                });
        }

        function disableUser(userId, username) {
            if (!confirm(`Bạn có chắc muốn vô hiệu hóa user "${username}"? User sẽ bị đăng xuất và không thể đăng nhập.`)) {
                return;
            }

            fetch('@Url.Action("DisableUser", "Admin")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ id: userId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra!');
                });
        }

        function enableUser(userId, username) {
            if (!confirm(`Bạn có chắc muốn kích hoạt user "${username}"?`)) {
                return;
            }

            fetch('@Url.Action("EnableUser", "Admin")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ id: userId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra!');
                });
        }
    </script>

    <style>
        .avatar { width: 40px; height: 40px; font-weight: bold; font-size: 16px; line-height: 40px; }
        .hover-primary:hover { color: #0d6efd !important; }
        tr.table-success { background-color: rgba(25, 135, 84, 0.1) !important; }
    </style>
}