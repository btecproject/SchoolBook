@model SchoolBookPlatform.ViewModels.Profile.ProfileViewModel
@{
    ViewData["Title"] = Model.FullName ?? Model.Username;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
<link rel="stylesheet" href="~/css/page/profile.css" />

<div class="container mt-5 mb-5">
    @Html.AntiForgeryToken()
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-body p-5">
                    <div class="d-flex align-items-center gap-4 mb-4">

                        <!-- Avatar -->
                        <div>
                            @if (Model.IsOwner)
                            {
                                <form asp-action="UploadAvatar" asp-controller="Profile" method="post" enctype="multipart/form-data" id="avatarForm">
                                    <label style="cursor: pointer;">
                                        <img src="@Model.AvatarUrl" class="rounded-circle shadow-sm"
                                             alt="Avatar" style="width: 120px; height: 120px; object-fit: cover;">
                                        <input type="file" name="avatar" accept="image/*" onchange="this.form.submit()" hidden />
                                    </label>
                                </form>
                            }
                            else
                            {
                                <img src="@Model.AvatarUrl" class="rounded-circle shadow-sm"
                                     alt="Avatar" style="width: 120px; height: 120px; object-fit: cover;">
                            }
                        </div>

                        <!-- Tên + Username -->
                        <div class="flex-grow-1">
                            <p id="fullname-wrapper" class="fs-4 fw-bold mb-1 d-flex align-items-center gap-2">

                                <!-- Text hiển thị -->
                                <span id="fullname-display">
                                    @(string.IsNullOrEmpty(Model.FullName) ? Model.Username : Model.FullName)
                                </span>

                                <!-- Input edit -->
                                <input id="fullname-input" class="form-control form-control-sm"
                                       style="max-width: 250px; display:none;" />

                                @if (Model.CanEdit)
                                {
                                    <!-- Nút Edit -->
                                    <button id="fullname-edit-btn" class="btn btn-sm btn-link p-0 d-flex align-items-center btn-edit" onclick="editFullName()">
                                        <span class="material-symbols-outlined" style="font-size:18px; color:#cf8c64">edit</span>
                                    </button>

                                    <!-- Nút Save / Cancel -->
                                    <div id="fullname-actions" style="display:none;">
                                        <button id="fullname-save-btn"
                                                class="btn btn-success btn-sm"
                                                onclick="saveFullName()"
                                                disabled>Lưu</button>

                                        <button id="fullname-cancel-btn"
                                                class="btn btn-secondary btn-sm"
                                                onclick="cancelFullName()">Hủy</button>
                                    </div>
                                }
                            </p>

                            <p class="text-muted mb-2">@Model.Username</p>
                        </div>
                    </div>

                    <!-- Nút Follow/Unfollow (không phải owner) -->
                    @if (!Model.IsOwner)
                    {
                        <button id="followBtn" class="btn @(Model.IsFollowing ? "btn-outline-primary" : "btn-primary") btn-lg px-5"
                                onclick="toggleFollow('@Model.UserId', @Model.IsFollowing.ToString().ToLower())">
                            @(Model.IsFollowing ? "Đang theo dõi" : "Theo dõi")
                        </button>
                    }

                    <!-- Số lượng follow -->
                    <div class="d-flex justify-content-center gap-5 mt-4 mb-4 text-muted">
                        <div>
                            <strong class="text-dark fs-4">@Model.FollowerCount</strong><br>
                            <span>Người theo dõi</span>
                        </div>
                        <div>
                            <strong class="text-dark fs-4">@Model.FollowingCount</strong><br>
                            <span>Đang theo dõi</span>
                        </div>
                    </div>

                    <!-- Bio -->
                    <div class="text-center mb-4">
                        <p id="bio-display">
                            <strong>Giới thiệu:</strong><br>
                            <span>@(string.IsNullOrEmpty(Model.Bio) ? "Chưa có mô tả" : Model.Bio)</span>
                        </p>
                        @if (Model.CanEdit)
                        {
                            <div id="bio-actions">
                                <button class="btn btn-sm btn-link text-primary bio-edit-btn btn-edit" onclick="editField('bio')">
                                    <span class="material-symbols-outlined" style="font-size:18px;vertical-align:middle;">edit</span> Chỉnh sửa
                                </button>
                            </div>
                        }

                        <div id="bio-edit" style="display:none; max-width: 500px; margin: 0 auto;">
                            <textarea id="bio-input" class="form-control" rows="3" oninput="checkChanges('bio', '@Model.Bio')">@Model.Bio</textarea>
                            <div class="mt-2 text-end">
                                <button class="btn btn-success btn-sm" id="bio-save-btn" onclick="saveField('Bio', 'bio-input', 'bio-display', 'bio-edit')" disabled>Lưu</button>
                                <button class="btn btn-secondary btn-sm" onclick="cancelEdit('bio-display', 'bio-edit', 'bio-actions')">Hủy</button>
                            </div>
                        </div>
                    </div>

                    <!-- Tab bar -->
                    <ul class="nav nav-tabs justify-content-center mb-4" id="profileTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#posts">
                                <p>Bài viết</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#info">
                                <p>Thông tin</p>
                            </a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Tab Bài viết -->
                        <div class="tab-pane fade show active" id="posts">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Bài viết (@Model.PostCount)</h5>
                                @if (Model.IsOwner)
                                {
                                    <a asp-controller="Post" asp-action="Create" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus me-1"></i> Đăng bài mới
                                    </a>
                                }
                            </div>
                            
                            @if (Model.UserPosts.Any())
                            {
                                foreach (var post in Model.UserPosts)
                                {
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h5 class="card-title">
                                                        <a asp-controller="Post" asp-action="Details" asp-route-id="@post.Id" class="text-decoration-none">
                                                            @post.Title
                                                        </a>
                                                    </h5>
                                                    <p class="card-text">@post.Content</p>
                                                    <small class="text-muted">
                                                        <i class="far fa-clock"></i> @post.CreatedAt.ToString("g")
                                                        @if (!string.IsNullOrEmpty(post.VisibleToRoles) && post.VisibleToRoles != "All")
                                                        {
                                                            <span class="badge bg-info ms-2">@post.VisibleToRoles</span>
                                                        }
                                                    </small>
                                                </div>
                                            </div>
                                            
                                            <!-- Hiển thị ảnh đầu tiên nếu có -->
                                            @if (post.Attachments.Any())
                                            {
                                                <div class="mt-3">
                                                    @{
                                                        var images = post.Attachments.Where(a => a.IsImage).ToList();
                                                        var files = post.Attachments.Where(a => !a.IsImage).ToList();
                                                    }
                                                    
                                                    @if (images.Any())
                                                    {
                                                        <div class="carousel-container">
                                                            <div id="carousel-profile-@post.Id" class="carousel slide mb-3" data-bs-ride="carousel">
                                                                <!-- Counter hiển thị số ảnh -->
                                                                <div class="carousel-counter">
                                                                    <span id="current-slide-profile-@post.Id">1</span> / <span id="total-slides-profile-@post.Id">@images.Count</span>
                                                                </div>
                                                                
                                                                @if (images.Count > 1)
                                                                {
                                                                    <div class="carousel-indicators">
                                                                        @for (int i = 0; i < images.Count; i++)
                                                                        {
                                                                            <button type="button" data-bs-target="#carousel-profile-@post.Id" 
                                                                                    data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")"
                                                                                    aria-current="@(i == 0 ? "true" : "false")"></button>
                                                                        }
                                                                    </div>
                                                                }
                                                                
                                                                <div class="carousel-inner">
                                                                    @for (int i = 0; i < images.Count; i++)
                                                                    {
                                                                        var img = images[i];
                                                                        <div class="carousel-item @(i == 0 ? "active" : "") text-center">
                                                                            <a href="@img.FilePath" target="_blank" class="d-block h-100">
                                                                                <img src="@img.FilePath" 
                                                                                     alt="@img.FileName"
                                                                                     class="img-fluid mx-auto d-block" />
                                                                            </a>
                                                                        </div>
                                                                    }
                                                                </div>
                                                                
                                                                @if (images.Count > 1)
                                                                {
                                                                    <button class="carousel-control-prev" type="button" data-bs-target="#carousel-profile-@post.Id" data-bs-slide="prev">
                                                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                                        <span class="visually-hidden">Previous</span>
                                                                    </button>
                                                                    <button class="carousel-control-next" type="button" data-bs-target="#carousel-profile-@post.Id" data-bs-slide="next">
                                                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                                        <span class="visually-hidden">Next</span>
                                                                    </button>
                                                                }
                                                            </div>
                                                        </div>
                                                    }
                                                    
                                                    @if (files.Any())
                                                    {
                                                        <div class="file-list">
                                                            <small class="text-muted d-block mb-2">File đính kèm:</small>
                                                            @foreach (var file in files)
                                                            {
                                                                <a href="@file.FilePath" target="_blank" 
                                                                   class="d-flex align-items-center text-decoration-none text-dark p-2 border rounded mb-2">
                                                                    @{
                                                                        var icon = "fa-file";
                                                                        var extension = System.IO.Path.GetExtension(file.FileName).ToLower();
                                                                        var color = "#6c757d";
                                                                        
                                                                        if (extension == ".pdf") { icon = "fa-file-pdf"; color = "#dc3545"; }
                                                                        else if (extension == ".doc" || extension == ".docx") { icon = "fa-file-word"; color = "#0d6efd"; }
                                                                        else if (extension == ".xls" || extension == ".xlsx") { icon = "fa-file-excel"; color = "#198754"; }
                                                                        else if (extension == ".ppt" || extension == ".pptx") { icon = "fa-file-powerpoint"; color = "#fd7e14"; }
                                                                        else if (extension == ".zip" || extension == ".rar") { icon = "fa-file-archive"; color = "#6f42c1"; }
                                                                    }
                                                                    <i class="fas @icon fa-2x me-3" style="color: @color;"></i>
                                                                    <div class="flex-grow-1">
                                                                        <div class="fw-medium text-truncate" style="max-width: 300px;">@file.FileName</div>
                                                                        <small class="text-muted">@((file.FileSize / 1024f / 1024f).ToString("F2")) MB</small>
                                                                    </div>
                                                                    <i class="fas fa-download text-primary"></i>
                                                                </a>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            
                                            <!-- Thống kê -->
                                            <div class="mt-3 d-flex gap-3">
                                                <span class="text-muted">
                                                    <i class="fas fa-thumbs-up"></i> @post.UpvoteCount
                                                </span>
                                                <span class="text-muted">
                                                    <i class="fas fa-thumbs-down"></i> @post.DownvoteCount
                                                </span>
                                                <a asp-controller="Post" asp-action="Details" asp-route-id="@post.Id" class="text-muted text-decoration-none">
                                                    <i class="far fa-comment"></i> @post.CommentCount bình luận
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                }
                                
                                @if (Model.PostCount > Model.UserPosts.Count)
                                {
                                    <div class="text-center mt-4">
                                        <a href="@Url.Action("UserPosts", "Post", new { userId = Model.UserId })" class="btn btn-outline-primary">
                                            Xem tất cả bài viết (@Model.PostCount)
                                        </a>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-center py-5 text-muted">
                                    <i class="fas fa-newspaper fa-3x mb-3"></i>
                                    <h5>Chưa có bài viết nào</h5>
                                    @if (Model.IsOwner)
                                    {
                                        <p class="mb-3">Hãy đăng bài đầu tiên của bạn</p>
                                        <a asp-controller="Post" asp-action="Create" class="btn btn-primary">
                                            <i class="fas fa-plus me-1"></i> Đăng bài ngay
                                        </a>
                                    }
                                    else
                                    {
                                        <p>@Model.Username chưa đăng bài viết nào</p>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Tab Thông tin -->
                        <div class="tab-pane fade" id="info">
                            <div class="row">
                                <div class="col-12">
                                    <!-- Email -->
                                    @if (Model.Email != null)
                                    {
                                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                            <div class="flex-grow-1">
                                                <p id="email-display" class="mb-0"><strong>Email:</strong> <span>@Model.Email</span></p>

                                                <!-- Form chỉnh sửa Email -->
                                                <div id="email-edit" style="display:none;">
                                                    <input type="email" id="email-input" class="form-control mt-2" value="@Model.Email" placeholder="Nhập email"
                                                           oninput="checkChanges('email', '@Model.Email')" />
                                                    <div class="mt-2 text-end">
                                                        <button class="btn btn-success btn-sm" id="email-save-btn" onclick="saveField('Email', 'email-input', 'email-display', 'email-edit')" disabled>Lưu</button>
                                                        <button class="btn btn-secondary btn-sm" onclick="cancelEdit('email-display', 'email-edit', 'email-actions')">Hủy</button>
                                                    </div>
                                                </div>
                                            </div>
                                            @if (Model.CanEdit)
                                            {
                                                <div class="d-flex align-items-center gap-2" id="email-actions">
                                                    <div class="form-check form-switch mb-0">
                                                        <input class="form-check-input" type="checkbox" id="emailPrivacySwitch"
                                                               @(Model.IsEmailPublic ? "checked" : "")
                                                               onchange="togglePrivacy('IsEmailPublic', this.checked)">
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-secondary btn-edit" onclick="editField('email')">
                                                        <span class="material-symbols-outlined" style="font-size:16px;">edit</span>
                                                    </button>
                                                </div>
                                            }
                                        </div>
                                    }

                                    <!-- Số điện thoại -->
                                    @if (Model.PhoneNumber != null)
                                    {
                                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                            <div class="flex-grow-1">
                                                <p id="phone-display" class="mb-0"><strong>Số điện thoại:</strong> <span>@Model.PhoneNumber</span></p>

                                                <!-- Form chỉnh sửa Phone -->
                                                <div id="phone-edit" style="display:none;">
                                                    <input type="tel" id="phone-input" class="form-control mt-2" value="@Model.PhoneNumber" placeholder="Nhập số điện thoại"
                                                           oninput="checkChanges('phone', '@Model.PhoneNumber')" />
                                                    <div class="mt-2 text-end">
                                                        <button class="btn btn-success btn-sm" id="phone-save-btn" onclick="saveField('PhoneNumber', 'phone-input', 'phone-display', 'phone-edit')" disabled>Lưu</button>
                                                        <button class="btn btn-secondary btn-sm" onclick="cancelEdit('phone-display', 'phone-edit', 'phone-actions')">Hủy</button>
                                                    </div>
                                                </div>
                                            </div>
                                            @if (Model.CanEdit)
                                            {
                                                <div class="d-flex align-items-center gap-2" id="phone-actions">
                                                    <div class="form-check form-switch mb-0">
                                                        <input class="form-check-input" type="checkbox" id="phonePrivacySwitch"
                                                               @(Model.IsPhonePublic ? "checked" : "")
                                                               onchange="togglePrivacy('IsPhonePublic', this.checked)">
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-secondary btn-edit" onclick="editField('phone')">
                                                        <span class="material-symbols-outlined" style="font-size:16px;">edit</span>
                                                    </button>
                                                </div>
                                            }
                                        </div>
                                    }

                                    <!-- Giới tính -->
                                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                        <div class="flex-grow-1">
                                            <p id="gender-display" class="mb-0">
                                                <strong>Giới tính:</strong>
                                                @(string.IsNullOrEmpty(Model.Gender) ? "Chưa có thông tin để hiển thị" :
                                                Model.Gender == "Male" ? "Nam" :
                                                Model.Gender == "Female" ? "Nữ" :
                                                Model.Gender == "Other" ? "Khác" : Model.Gender)
                                            </p>

                                            <!-- Form chỉnh sửa Gender -->
                                            <div id="gender-edit" style="display:none;">
                                                <select id="gender-input" class="form-select mt-2" onchange="checkChanges('gender', '@Model.Gender')">
                                                    <option value="">Chọn giới tính</option>
                                                    <option value="Male" selected="@(Model.Gender == "Male")">Nam</option>
                                                    <option value="Female" selected="@(Model.Gender == "Female")">Nữ</option>
                                                    <option value="Other" selected="@(Model.Gender == "Other")">Khác</option>
                                                </select>
                                                <div class="mt-2 text-end">
                                                    <button class="btn btn-success btn-sm" id="gender-save-btn" onclick="saveField('Gender', 'gender-input', 'gender-display', 'gender-edit')" disabled>Lưu</button>
                                                    <button class="btn btn-secondary btn-sm" onclick="cancelEdit('gender-display', 'gender-edit', 'gender-actions')">Hủy</button>
                                                </div>
                                            </div>
                                        </div>
                                        @if (Model.CanEdit)
                                        {
                                            <div class="d-flex align-items-center gap-2" id="gender-actions">
                                                <button class="btn btn-sm btn-outline-secondary btn-edit" onclick="editField('gender')">
                                                    <span class="material-symbols-outlined" style="font-size:16px;">edit</span>
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    <!-- Ngày sinh -->
                                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                        <div class="flex-grow-1">
                                            <p id="birth-display" class="mb-0">
                                                <strong>Ngày sinh:</strong>
                                                @(Model.BirthDate?.ToString("dd/MM/yyyy") ?? "Chưa có thông tin để hiển thị")
                                            </p>

                                            <!-- Form chỉnh sửa BirthDate -->
                                            <div id="birth-edit" style="display:none;">
                                                <input type="date" id="birth-input" class="form-control mt-2" value="@(Model.BirthDate?.ToString("yyyy-MM-dd"))"
                                                       onchange="checkBirthDateChanges()" />
                                                <div class="mt-2 text-end">
                                                    <button class="btn btn-success btn-sm" id="birth-save-btn" onclick="saveBirthDate()" disabled>Lưu</button>
                                                    <button class="btn btn-secondary btn-sm" onclick="cancelEdit('birth-display', 'birth-edit', 'birth-actions')">Hủy</button>
                                                </div>
                                            </div>
                                        </div>
                                        @if (Model.CanEdit)
                                        {
                                            <div class="d-flex align-items-center gap-2" id="birth-actions">
                                                <div class="form-check form-switch mb-0">
                                                    <input class="form-check-input" type="checkbox" id="birthdatePrivacySwitch"
                                                           @(Model.IsBirthDatePublic ? "checked" : "")
                                                           onchange="togglePrivacy('IsBirthDatePublic', this.checked)">
                                                </div>
                                                <button class="btn btn-sm btn-outline-secondary btn-edit" onclick="editField('birth')">
                                                    <span class="material-symbols-outlined" style="font-size:16px;">edit</span>
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    <!-- Ngày tạo tài khoản -->
                                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                        <div class="flex-grow-1">
                                            <p class="text-muted mb-0">
                                                <strong>Tham gia:</strong>
                                                @Model.CreatedAt.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("vi-VN"))
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Lưu trữ giá trị ban đầu để so sánh
    let originalValues = {};
    function editField(name) {
        console.log('Editing field:', name);

        // Ẩn tất cả các form chỉnh sửa đang mở
        const allEditForms = document.querySelectorAll('[id$="-edit"]');
        allEditForms.forEach(form => {
            form.style.setProperty('display', 'none', 'important');
        });

        // Hiển thị tất cả các display và actions
        const allDisplays = document.querySelectorAll('[id$="-display"]');
        allDisplays.forEach(display => {
            display.style.setProperty('display', 'block', 'important');
        });

        const allActions = document.querySelectorAll('[id$="-actions"]');
        allActions.forEach(action => {
            if (action) {
                // Bio hiển thị inline-block, các field khác hiển thị flex
                if (action.id === 'bio-actions') {
                    action.style.setProperty('display', 'inline-block', 'important');
                } else {
                    action.style.setProperty('display', 'flex', 'important');
                }
            }
        });

        // Lưu giá trị ban đầu
        const inputElement = document.getElementById(name + "-input");
        if (inputElement) {
            originalValues[name] = inputElement.value;
        }

        // Ẩn display và actions CỦA FIELD HIỆN TẠI, hiển thị form chỉnh sửa
        const displayElement = document.getElementById(name + "-display");
        const actionsElement = document.getElementById(name + "-actions");
        const editElement = document.getElementById(name + "-edit");

        if (displayElement) {
            displayElement.style.setProperty('display', 'none', 'important');
            console.log('Hidden display:', name + "-display");
        }

        if (actionsElement) {
            actionsElement.style.setProperty('display', 'none', 'important');
            console.log('Hidden actions:', name + "-actions");
        }

        if (editElement) {
            editElement.style.setProperty('display', 'block', 'important');
            console.log('Shown edit form:', name + "-edit");
        }

        // Reset nút lưu về disabled
        const saveBtn = document.getElementById(name + "-save-btn");
        if (saveBtn) {
            saveBtn.disabled = true;
        }
}

    function cancelEdit(displayId, editId, actionsId) {
        console.log('Canceling edit:', displayId, editId, actionsId);

        const displayElement = document.getElementById(displayId);
        const editElement = document.getElementById(editId);
        const actionsElement = document.getElementById(actionsId);

        if (displayElement) {
            displayElement.style.setProperty('display', 'block', 'important');
        }

        if (editElement) {
            editElement.style.setProperty('display', 'none', 'important');
        }

        if (actionsElement) {
            // Bio hiển thị inline-block, các field khác hiển thị flex
            if (actionsId === 'bio-actions') {
                actionsElement.style.setProperty('display', 'inline-block', 'important');
            } else {
                actionsElement.style.setProperty('display', 'flex', 'important');
            }
        }

        // Khôi phục giá trị ban đầu
        const fieldName = displayId.replace('-display', '');
        const inputElement = document.getElementById(fieldName + "-input");
        if (inputElement && originalValues[fieldName] !== undefined) {
            inputElement.value = originalValues[fieldName];
        }
}

    // Hàm riêng cho fullname - SỬA LẠI VỚI !important
    function editFullName() {
        console.log('Editing fullname');

        const display = document.getElementById("fullname-display");
        const input = document.getElementById("fullname-input");
        const editBtn = document.getElementById("fullname-edit-btn");
        const actions = document.getElementById("fullname-actions");

        // Ẩn display và nút edit
        if (display) {
            display.style.setProperty('display', 'none', 'important');
            console.log('Hidden fullname display');
        }

        if (editBtn) {
            editBtn.style.setProperty('display', 'none', 'important');
            console.log('Hidden fullname edit button');
        }

        // Hiện input và actions (save/cancel)
        if (input) {
            input.style.setProperty('display', 'block', 'important');
            console.log('Shown fullname input');
        }

        if (actions) {
            actions.style.setProperty('display', 'inline-block', 'important');
            console.log('Shown fullname actions');
        }

        // Đổ dữ liệu vào input
        if (input && display) {
            input.value = display.innerText.trim();
            console.log('Set input value to:', input.value);
        }
}

    function saveFullName() {
        console.log('Saving fullname');

        const newName = document.getElementById("fullname-input").value.trim();
        if (!newName) {
            console.log('Empty name, not saving');
            return;
        }

        document.getElementById("fullname-display").innerText = newName;

        // Khôi phục giao diện
        const display = document.getElementById("fullname-display");
        const input = document.getElementById("fullname-input");
        const editBtn = document.getElementById("fullname-edit-btn");
        const actions = document.getElementById("fullname-actions");

        if (display) display.style.setProperty('display', 'inline-block', 'important');
        if (input) input.style.setProperty('display', 'none', 'important');
        if (editBtn) editBtn.style.setProperty('display', 'inline-block', 'important');
        if (actions) actions.style.setProperty('display', 'none', 'important');

        console.log('Restored fullname UI');
    }

    function cancelFullName() {
        console.log('Canceling fullname edit');

        // Khôi phục giao diện
        const display = document.getElementById("fullname-display");
        const input = document.getElementById("fullname-input");
        const editBtn = document.getElementById("fullname-edit-btn");
        const actions = document.getElementById("fullname-actions");

        if (display) display.style.setProperty('display', 'inline-block', 'important');
        if (input) input.style.setProperty('display', 'none', 'important');
        if (editBtn) editBtn.style.setProperty('display', 'inline-block', 'important');
        if (actions) actions.style.setProperty('display', 'none', 'important');

        console.log('Restored fullname UI');
    }
    
    function checkChanges(fieldName, originalValue) {
        const inputElement = document.getElementById(fieldName + "-input");
        const saveBtn = document.getElementById(fieldName + "-save-btn");

        if (!inputElement || !saveBtn) return;

        const currentValue = inputElement.value.trim();

        if (currentValue !== originalValue && currentValue !== '') {
            saveBtn.disabled = false;
        } else {
            saveBtn.disabled = true;
        }
}

    function checkBirthDateChanges() {
        const inputElement = document.getElementById("birth-input");
        const saveBtn = document.getElementById("birth-save-btn");
        const originalValue = "@(Model.BirthDate?.ToString("yyyy-MM-dd"))";

        if (!inputElement || !saveBtn) return;

        const currentValue = inputElement.value;

        if (currentValue !== originalValue && currentValue !== '') {
            saveBtn.disabled = false;
        } else {
            saveBtn.disabled = true;
        }
}

    function saveField(fieldName, inputId, displayId, editId) {
        const inputElement = document.getElementById(inputId);
        if (!inputElement) {
            console.error('Input element not found:', inputId);
            return;
        }

        let value = null;

        if (inputElement.tagName === 'SELECT') {
            value = inputElement.value;
        } else if (inputElement.tagName === 'TEXTAREA') {
            value = inputElement.value.trim();
        } else {
            value = inputElement.value.trim();
        }

        const allowedFields = ['Bio', 'FullName', 'Gender', 'BirthDate', 'Email', 'PhoneNumber'];
        if (!allowedFields.includes(fieldName)) {
            alert("Không được phép chỉnh sửa trường này!");
            return;
        }

        console.log('Saving field:', fieldName, 'Value:', value);

        fetch('/Profile/UpdateField', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({
                field: fieldName,
                value: value,
                dateValue: null
            })
        })
            .then(res => {
                console.log('Response status:', res.status);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log('Response data:', data);

                if (data.success) {
                    updateDisplayAfterSave(fieldName, value, displayId);

                    const fieldNameShort = displayId.replace('-display', '');
                    const actionsElement = document.getElementById(fieldNameShort + "-actions");
                    if (actionsElement) {
                        // Bio hiển thị inline-block, các field khác hiển thị flex
                        if (fieldNameShort === 'bio') {
                            actionsElement.style.setProperty('display', 'inline-block', 'important');
                        } else {
                            actionsElement.style.setProperty('display', 'flex', 'important');
                        }
                    }

                    document.getElementById(displayId).style.setProperty('display', 'block', 'important');
                    document.getElementById(editId).style.setProperty('display', 'none', 'important');
                    showToast('Đã cập nhật thông tin thành công', 'success');
                } else {
                    alert(data.message || "Lưu thất bại!");
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert("Đã xảy ra lỗi khi lưu: " + error.message);
            });
    }
    
    function updateDisplayAfterSave(fieldName, value, displayId) {
        const displayElement = document.getElementById(displayId);

        if (fieldName === 'FullName') {
            const span = displayElement.querySelector('span');
            if (span) {
                span.innerText = value || '@Model.Username';
            }
        }
        else if (fieldName === 'Bio') {
            const span = displayElement.querySelector('span');
            if (span) {
                span.innerText = value || "Chưa có mô tả";
            }
        }
        else if (fieldName === 'Gender') {
            const genderText = value === 'Male' ? 'Nam' :
                value === 'Female' ? 'Nữ' :
                    value === 'Other' ? 'Khác' : 'Chưa có thông tin để hiển thị';

            displayElement.innerHTML = `<strong>Giới tính:</strong> ${genderText}`;
        }
        else if (fieldName === 'Email') {
            const span = displayElement.querySelector('span');
            if (span) {
                span.innerText = value || '';
            }
        }
        else if (fieldName === 'PhoneNumber') {
            const span = displayElement.querySelector('span');
            if (span) {
                span.innerText = value || '';
            }
        }
}

    function saveBirthDate() {
        const inputElement = document.getElementById("birth-input");
        if (!inputElement) {
            console.error('Birth input not found');
            return;
        }

        const value = inputElement.value;
        console.log('Saving birth date:', value);

        fetch('/Profile/UpdateField', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({
                field: "BirthDate",
                value: null,
                dateValue: value
            })
        })
            .then(res => {
                console.log('Response status:', res.status);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log('Response data:', data);

                if (data.success) {
                    const formatted = value ? new Date(value).toLocaleDateString('vi-VN') : "Chưa có thông tin để hiển thị";
                    document.getElementById("birth-display").innerHTML = `<strong>Ngày sinh:</strong> ${formatted}`;

                    const actionsElement = document.getElementById("birth-actions");
                    if (actionsElement) {
                        actionsElement.style.setProperty('display', 'flex', 'important');
                    }

                    document.getElementById('birth-display').style.setProperty('display', 'block', 'important');
                    document.getElementById('birth-edit').style.setProperty('display', 'none', 'important');
                    showToast('Đã cập nhật ngày sinh thành công', 'success');
                } else {
                    alert(data.message || "Lưu thất bại!");
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert("Đã xảy ra lỗi khi lưu: " + error.message);
            });
    }
     
    function toggleFollow(userId, isFollowing) {
        console.log('toggleFollow called:', userId, isFollowing);

        const url = isFollowing ? '/Profile/Unfollow' : '/Profile/Follow';
        const btn = document.getElementById('followBtn');

        if (btn) btn.disabled = true;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({ userId: userId })
        })
            .then(res => {
                console.log('Response status:', res.status);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log('Response data:', data);

                if (data.success) {
                    if (btn) {
                        if (data.isFollowing) {
                            btn.textContent = 'Đang theo dõi';
                            btn.className = 'btn btn-outline-primary btn-lg px-5';
                            btn.onclick = () => toggleFollow(userId, true);
                        } else {
                            btn.textContent = 'Theo dõi';
                            btn.className = 'btn btn-primary btn-lg px-5';
                            btn.onclick = () => toggleFollow(userId, false);
                        }
                        btn.disabled = false;
                    }

                    if (data.followerCount !== undefined) {
                        const followerCountElem = document.querySelector('.d-flex.justify-content-center.gap-5 .text-dark.fs-4');
                        if (followerCountElem) {
                            followerCountElem.textContent = data.followerCount;
                        }
                    }
                } else {
                    alert(data.message || 'Đã xảy ra lỗi');
                    if (btn) btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Đã xảy ra lỗi khi thực hiện thao tác: ' + error.message);
                if (btn) btn.disabled = false;
            });
    }

    function togglePrivacy(field, isPublic) {
        console.log('togglePrivacy:', field, isPublic);

        fetch('/Profile/UpdatePrivacy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({
                field: field,
                isPublic: isPublic
            })
        })
            .then(res => {
                console.log('Response status:', res.status);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log('Response data:', data);

                if (data.success) {
                    showToast('Đã cập nhật cài đặt riêng tư', 'success');
                } else {
                    alert(data.message || 'Cập nhật thất bại');
                    const switchElem = document.querySelector(`[onchange*="${field}"]`);
                    if (switchElem) {
                        switchElem.checked = !isPublic;
                    }
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Đã xảy ra lỗi: ' + error.message);
                const switchElem = document.querySelector(`[onchange*="${field}"]`);
                if (switchElem) {
                    switchElem.checked = !isPublic;
                }
            });
    }

    // Hàm hiển thị toast notification
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
        toast.style.zIndex = '9999';
        toast.style.minWidth = '300px';
        toast.textContent = message;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.5s';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    // JavaScript để cập nhật số đếm khi chuyển slide cho carousel trong profile
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.carousel').forEach(carousel => {
            const carouselId = carousel.id;
            const currentSlideSpan = document.getElementById(`current-slide-${carouselId.replace('carousel-', '')}`);
            const totalSlidesSpan = document.getElementById(`total-slides-${carouselId.replace('carousel-', '')}`);

            // Thiết lập số slide tổng cộng
            if (totalSlidesSpan) {
                const totalItems = carousel.querySelectorAll('.carousel-item').length;
                totalSlidesSpan.textContent = totalItems;
            }

            if (currentSlideSpan) {
                // Thiết lập slide hiện tại
                const activeSlide = carousel.querySelector('.carousel-item.active');
                const activeIndex = Array.from(carousel.querySelectorAll('.carousel-item')).indexOf(activeSlide) + 1;
                currentSlideSpan.textContent = activeIndex;
            }

            // Lắng nghe sự kiện slide.bs.carousel
            carousel.addEventListener('slide.bs.carousel', function (event) {
                if (currentSlideSpan) {
                    const nextIndex = event.to + 1; // event.to là index (0-based)
                    currentSlideSpan.textContent = nextIndex;
                }
            });
        });

        // Đảm bảo ảnh được căn giữa sau khi load
        setTimeout(() => {
            document.querySelectorAll('.carousel-item img').forEach(img => {
                const parent = img.closest('.carousel-item');
                if (parent) {
                    // Căn giữa theo chiều dọc nếu ảnh thấp hơn container
                    const imgHeight = img.offsetHeight;
                    const parentHeight = parent.offsetHeight;

                    if (imgHeight < parentHeight) {
                        const marginTop = (parentHeight - imgHeight) / 2;
                        img.style.marginTop = marginTop + 'px';
                    }
                }
            });
        }, 100);
    });

    // Xử lý khi window resize
    window.addEventListener('resize', function() {
        document.querySelectorAll('.carousel-item img').forEach(img => {
            const parent = img.closest('.carousel-item');
            if (parent) {
                const imgHeight = img.offsetHeight;
                const parentHeight = parent.offsetHeight;

                if (imgHeight < parentHeight) {
                    const marginTop = (parentHeight - imgHeight) / 2;
                    img.style.marginTop = marginTop + 'px';
                } else {
                    img.style.marginTop = '0';
                }
            }
        });
    });
</script>
}