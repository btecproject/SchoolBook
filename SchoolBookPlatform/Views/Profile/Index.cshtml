@model SchoolBookPlatform.ViewModels.Profile.ProfileViewModel
@{
    ViewData["Title"] = Model.FullName ?? Model.Username;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
<link rel="stylesheet" href="~/css/page/profile.css"/>

<div class="container mt-5 mb-5">
    @Html.AntiForgeryToken()
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-body p-5">
                    <div class="d-flex align-items-center gap-4 mb-4">

                        <!-- Avatar -->
                        <div>
                            @if (Model.IsOwner)
                            {
                                <form asp-action="UploadAvatar" asp-controller="Profile" method="post" enctype="multipart/form-data" id="avatarForm">
                                    <label style="cursor: pointer;">
                                        <img src="@Model.AvatarUrl" class="rounded-circle shadow-sm"
                                             alt="Avatar" style="width: 120px; height: 120px; object-fit: cover;">
                                        <input type="file" name="avatar" accept="image/*" onchange="this.form.submit()" hidden />
                                    </label>
                                </form>
                            }
                            else
                            {
                                <img src="@Model.AvatarUrl" class="rounded-circle shadow-sm"
                                     alt="Avatar" style="width: 120px; height: 120px; object-fit: cover;">
                            }
                        </div>

                        <!-- Tên + Username -->
                        <div class="flex-grow-1">
                            <p id="fullname-wrapper" class="fs-4 fw-bold mb-1 d-flex align-items-center gap-2">

                                <!-- Text hiển thị -->
                                <span id="fullname-display">
                                    @(string.IsNullOrEmpty(Model.FullName) ? Model.Username : Model.FullName)
                                </span>

                                <!-- Input edit -->
                                <input id="fullname-input" class="form-control form-control-sm"
                                       style="max-width: 250px; display:none;" />

                                @if (Model.CanEdit)
                                {
                                    <!-- Nút Edit -->
                                    <button id="fullname-edit-btn" class="btn btn-sm btn-link p-0 d-flex align-items-center btn-edit" onclick="editFullName()">
                                        <span class="material-symbols-outlined" style="font-size:18px; color:#cf8c64">edit</span>
                                    </button>

                                    <!-- Nút Save / Cancel -->
                                    <div id="fullname-actions" style="display:none;">
                                        <button id="fullname-save-btn"
                                                class="btn btn-success btn-sm"
                                                onclick="saveFullName()"
                                                >Lưu</button>

                                        <button id="fullname-cancel-btn"
                                                class="btn btn-secondary btn-sm"
                                                onclick="cancelFullName()">Hủy</button>
                                    </div>
                                }
                            </p>

                            <p class="text-muted mb-2">@Model.Username</p>
                        </div>
                    </div>

                    <!-- Nút Follow/Unfollow (không phải owner) -->
                    @if (!Model.IsOwner)
                    {
                        <button id="followBtn" class="btn @(Model.IsFollowing ? "btn-outline-primary" : "btn-primary") btn-lg px-5"
                                onclick="toggleFollow('@Model.UserId', @Model.IsFollowing.ToString().ToLower())">
                            @(Model.IsFollowing ? "Đang theo dõi" : "Theo dõi")
                        </button>
                    }

                    <!-- Số lượng follow -->
                    <div class="d-flex justify-content-center gap-5 mt-4 mb-4 text-muted">
                        <div>
                            <strong class="text-dark fs-4">@Model.FollowerCount</strong><br>
                            <span>Người theo dõi</span>
                        </div>
                        <div>
                            <strong class="text-dark fs-4">@Model.FollowingCount</strong><br>
                            <span>Đang theo dõi</span>
                        </div>
                    </div>

                    <!-- Bio -->
                    <div class="text-center mb-4">
                        <p id="bio-display">
                            <strong>Giới thiệu:</strong><br>
                            <span>@(string.IsNullOrEmpty(Model.Bio) ? "Chưa có mô tả" : Model.Bio)</span>
                        </p>
                        @if (Model.CanEdit)
                        {
                            <div id="bio-actions">
                                <button class="btn btn-sm btn-link text-primary bio-edit-btn btn-edit" onclick="editField('bio')">
                                    <span class="material-symbols-outlined" style="font-size:18px;vertical-align:middle;">edit</span> Chỉnh sửa
                                </button>
                            </div>
                        }

                        <div id="bio-edit" style="display:none; max-width: 500px; margin: 0 auto;">
                            <textarea id="bio-input" class="form-control" rows="3" oninput="checkChanges('bio', '@Model.Bio')">@Model.Bio</textarea>
                            <div class="mt-2 text-end">
                                <button class="btn btn-success btn-sm" id="bio-save-btn" onclick="saveField('Bio', 'bio-input', 'bio-display', 'bio-edit')" disabled>Lưu</button>
                                <button class="btn btn-secondary btn-sm" onclick="cancelEdit('bio-display', 'bio-edit', 'bio-actions')">Hủy</button>
                            </div>
                        </div>
                    </div>

                    <!-- Tab bar -->
                    <ul class="nav nav-tabs justify-content-center mb-4" id="profileTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#posts">
                                <p>Bài viết</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#upvoted">
                                <p>Đã thích</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#info">
                                <p>Thông tin</p>
                            </a>
                        </li>
                    </ul>

                    <!-- Modal hiển thị ảnh/video toàn màn hình -->
                    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-fullscreen">
                            <div class="modal-content bg-transparent border-0">
                                <div class="modal-header border-0 position-absolute top-0 end-0 z-3">
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body d-flex justify-content-center align-items-center p-0 position-relative">
                                    <!-- Background mờ -->
                                    <div id="blurredBackground" class="position-absolute top-0 start-0 w-100 h-100" style="z-index: -1;"></div>
                                    
                                    <!-- Container cho carousel modal -->
                                    <div id="modalCarousel" class="carousel slide w-100 h-100" data-bs-interval="false">
                                        <!-- Counter cho modal -->
                                        <div class="carousel-counter-modal position-absolute top-3 start-50 translate-middle-x text-white bg-dark bg-opacity-50 px-3 py-1 rounded-pill z-2">
                                            <span id="modalCurrentSlide">1</span> / <span id="modalTotalSlides">0</span>
                                        </div>
                                        
                                        <div class="carousel-inner h-100">
                                            <!-- Nội dung carousel sẽ được thêm bằng JavaScript -->
                                        </div>
                                        
                                        <!-- Nút điều hướng - ẩn khi chỉ có 1 media -->
                                        <button class="carousel-control-prev" type="button" data-bs-target="#modalCarousel" data-bs-slide="prev" style="display: none;">
                                            <span class="carousel-control-prev-icon bg-dark bg-opacity-50 rounded-circle p-3" aria-hidden="true"></span>
                                            <span class="visually-hidden">Previous</span>
                                        </button>
                                        <button class="carousel-control-next" type="button" data-bs-target="#modalCarousel" data-bs-slide="next" style="display: none;">
                                            <span class="carousel-control-next-icon bg-dark bg-opacity-50 rounded-circle p-3" aria-hidden="true"></span>
                                            <span class="visually-hidden">Next</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modal báo cáo bài đăng -->
                    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="reportModalLabel">Báo cáo bài đăng</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body" id="reportModalBody">
                                    <!-- Form report sẽ được load động vào đây -->
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                <div class="tab-content">
                    <!-- Tab Bài viết -->
                    <div class="tab-pane fade show active" id="posts">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Bài viết (@Model.PostCount)</h5>
                            @if (Model.IsOwner)
                            {
                                <a asp-controller="Post" asp-action="Create" class="btn btn-primary btn-sm">
                                    <i class="fas fa-plus me-1"></i> Đăng bài mới
                                </a>
                            }
                        </div>
                        
                        <!-- Phần hiển thị bài viết sử dụng _PostListPartial -->
                        @if (Model.UserPosts.Any())
                        {
                            <div id="profile-posts-container">
                                @{
                                    var postListViewModel = new SchoolBookPlatform.ViewModels.Post.PostListViewModel
                                    {
                                        Posts = Model.UserPosts,
                                        CurrentPage = 1,
                                        TotalPages = 1,
                                        ViewType = "profile"
                                    };
                                }
                                @await Html.PartialAsync("_PostListPartial", postListViewModel)
                                
                                @if (Model.PostCount > Model.UserPosts.Count)
                                {
                                    <div class="text-center mt-4">
                                        <a href="@Url.Action("UserPosts", "Post", new { userId = Model.UserId })" 
                                           class="btn btn-outline-primary">
                                            Xem tất cả bài viết (@Model.PostCount)
                                        </a>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5 text-muted">
                                <i class="fas fa-newspaper fa-3x mb-3"></i>
                                <h5>Chưa có bài viết nào</h5>
                                @if (Model.IsOwner)
                                {
                                    <p class="mb-3">Hãy đăng bài đầu tiên của bạn</p>
                                    <a asp-controller="Post" asp-action="Create" class="btn btn-primary">
                                        <i class="fas fa-plus me-1"></i> Đăng bài ngay
                                    </a>
                                }
                                else
                                {
                                    <p>@Model.Username chưa đăng bài viết nào</p>
                                }
                            </div>
                        }
                    </div>

                    <!-- Tab Bài đã upvote -->
                    <div class="tab-pane fade" id="upvoted">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Bài đã upvote (@Model.UpvotedPostCount)</h5>
                        </div>
                        
                        <!-- Phần hiển thị bài đã upvote CŨNG dùng _PostListPartial -->
                        @if (Model.UpvotedPosts.Any())
                        {
                            <div id="upvoted-posts-container">
                                @{
                                    var upvotedPostListViewModel = new SchoolBookPlatform.ViewModels.Post.PostListViewModel
                                    {
                                        Posts = Model.UpvotedPosts,
                                        CurrentPage = 1,
                                        TotalPages = 1,
                                        ViewType = "profile" // Hoặc "upvoted" nếu bạn muốn phân biệt
                                    };
                                }
                                @await Html.PartialAsync("_PostListPartial", upvotedPostListViewModel)
                                
                                @if (Model.UpvotedPostCount > Model.UpvotedPosts.Count)
                                {
                                    <div class="text-center mt-4">
                                        <a href="@Url.Action("UpvotedPosts", "Profile", new { userId = Model.UserId })" 
                                           class="btn btn-outline-primary">
                                            Xem tất cả bài đã upvote (@Model.UpvotedPostCount)
                                        </a>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5 text-muted">
                                <i class="fas fa-thumbs-up fa-3x mb-3"></i>
                                <h5>Chưa upvote bài viết nào</h5>
                                <p>Hãy upvote những bài viết bạn thấy hữu ích</p>
                            </div>
                        }
                    </div>

                        <!-- Tab Thông tin -->
                        <div class="tab-pane fade" id="info">
                            <div class="row">
                                <div class="col-12">
                                    <!-- Email -->
                                    @if (Model.Email != null)
                                    {
                                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                            <div class="flex-grow-1">
                                                <p id="email-display" class="mb-0"><strong>Email:</strong> <span>@Model.Email</span></p>

                                                <!-- Form chỉnh sửa Email -->
                                                <div id="email-edit" style="display:none;">
                                                    <input type="email" id="email-input" class="form-control mt-2" value="@Model.Email" placeholder="Nhập email"
                                                           oninput="checkChanges('email', '@Model.Email')" />
                                                    <div class="mt-2 text-end">
                                                        <button class="btn btn-success btn-sm" id="email-save-btn" onclick="saveField('Email', 'email-input', 'email-display', 'email-edit')" disabled>Lưu</button>
                                                        <button class="btn btn-secondary btn-sm" onclick="cancelEdit('email-display', 'email-edit', 'email-actions')">Hủy</button>
                                                    </div>
                                                </div>
                                            </div>
                                            @if (Model.CanEdit)
                                            {
                                                <div class="d-flex align-items-center gap-2" id="email-actions">
                                                    <div class="form-check form-switch mb-0">
                                                        <input class="form-check-input" type="checkbox" id="emailPrivacySwitch"
                                                               @(Model.IsEmailPublic ? "checked" : "")
                                                               onchange="togglePrivacy('IsEmailPublic', this.checked)">
                                                    </div>
                                                    @* <button class="btn btn-sm btn-outline-secondary btn-edit" onclick="editField('email')"> *@
                                                    @*     <span class="material-symbols-outlined" style="font-size:16px;">edit</span> *@
                                                    @* </button> *@
                                                </div>
                                            }
                                        </div>
                                    }

                                    <!-- Số điện thoại -->
                                    @if (Model.PhoneNumber != null)
                                    {
                                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                            <div class="flex-grow-1">
                                                <p id="phone-display" class="mb-0"><strong>Số điện thoại:</strong> <span>@Model.PhoneNumber</span></p>

                                                <!-- Form chỉnh sửa Phone -->
                                                <div id="phone-edit" style="display:none;">
                                                    <input type="tel" id="phone-input" class="form-control mt-2" value="@Model.PhoneNumber" placeholder="Nhập số điện thoại"
                                                           oninput="checkChanges('phone', '@Model.PhoneNumber')" />
                                                    <div class="mt-2 text-end">
                                                        <button class="btn btn-success btn-sm" id="phone-save-btn" onclick="saveField('PhoneNumber', 'phone-input', 'phone-display', 'phone-edit')" disabled>Lưu</button>
                                                        <button class="btn btn-secondary btn-sm" onclick="cancelEdit('phone-display', 'phone-edit', 'phone-actions')">Hủy</button>
                                                    </div>
                                                </div>
                                            </div>
                                            @if (Model.CanEdit)
                                            {
                                                <div class="d-flex align-items-center gap-2" id="phone-actions">
                                                    <div class="form-check form-switch mb-0">
                                                        <input class="form-check-input" type="checkbox" id="phonePrivacySwitch"
                                                               @(Model.IsPhonePublic ? "checked" : "")
                                                               onchange="togglePrivacy('IsPhonePublic', this.checked)">
                                                    </div>
                                                    @* <button class="btn btn-sm btn-outline-secondary btn-edit" onclick="editField('phone')"> *@
                                                    @*     <span class="material-symbols-outlined" style="font-size:16px;">edit</span> *@
                                                    @* </button> *@
                                                </div>
                                            }
                                        </div>
                                    }

                                    <!-- Giới tính -->
                                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                        <div class="flex-grow-1">
                                            <p id="gender-display" class="mb-0">
                                                <strong>Giới tính:</strong>
                                                @(string.IsNullOrEmpty(Model.Gender) ? "Chưa có thông tin để hiển thị" :
                                                Model.Gender == "Male" ? "Nam" :
                                                Model.Gender == "Female" ? "Nữ" :
                                                Model.Gender == "Other" ? "Khác" : Model.Gender)
                                            </p>

                                            <!-- Form chỉnh sửa Gender -->
                                            <div id="gender-edit" style="display:none;">
                                                <select id="gender-input" class="form-select mt-2" onchange="checkChanges('gender', '@Model.Gender')">
                                                    <option value="">Chọn giới tính</option>
                                                    <option value="Male" selected="@(Model.Gender == "Male")">Nam</option>
                                                    <option value="Female" selected="@(Model.Gender == "Female")">Nữ</option>
                                                    <option value="Other" selected="@(Model.Gender == "Other")">Khác</option>
                                                </select>
                                                <div class="mt-2 text-end">
                                                    <button class="btn btn-success btn-sm" id="gender-save-btn" onclick="saveField('Gender', 'gender-input', 'gender-display', 'gender-edit')" disabled>Lưu</button>
                                                    <button class="btn btn-secondary btn-sm" onclick="cancelEdit('gender-display', 'gender-edit', 'gender-actions')">Hủy</button>
                                                </div>
                                            </div>
                                        </div>
                                        @if (Model.CanEdit)
                                        {
                                            <div class="d-flex align-items-center gap-2" id="gender-actions">
                                                <button class="btn btn-sm btn-outline-secondary btn-edit" onclick="editField('gender')">
                                                    <span class="material-symbols-outlined" style="font-size:16px;">edit</span>
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    <!-- Ngày sinh -->
                                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                        <div class="flex-grow-1">
                                            <p id="birth-display" class="mb-0">
                                                <strong>Ngày sinh:</strong>
                                                @(Model.BirthDate?.ToString("dd/MM/yyyy") ?? "Chưa có thông tin để hiển thị")
                                            </p>

                                            <!-- Form chỉnh sửa BirthDate -->
                                            <div id="birth-edit" style="display:none;">
                                                <input type="date" id="birth-input" class="form-control mt-2" value="@(Model.BirthDate?.ToString("yyyy-MM-dd"))"
                                                       onchange="checkBirthDateChanges()" />
                                                <div class="mt-2 text-end">
                                                    <button class="btn btn-success btn-sm" id="birth-save-btn" onclick="saveBirthDate()" disabled>Lưu</button>
                                                    <button class="btn btn-secondary btn-sm" onclick="cancelEdit('birth-display', 'birth-edit', 'birth-actions')">Hủy</button>
                                                </div>
                                            </div>
                                        </div>
                                        @if (Model.CanEdit)
                                        {
                                            <div class="d-flex align-items-center gap-2" id="birth-actions">
                                                <div class="form-check form-switch mb-0">
                                                    <input class="form-check-input" type="checkbox" id="birthdatePrivacySwitch"
                                                           @(Model.IsBirthDatePublic ? "checked" : "")
                                                           onchange="togglePrivacy('IsBirthDatePublic', this.checked)">
                                                </div>
                                                <button class="btn btn-sm btn-outline-secondary btn-edit" onclick="editField('birth')">
                                                    <span class="material-symbols-outlined" style="font-size:16px;">edit</span>
                                                </button>
                                            </div>
                                        }
                                    </div>

                                    <!-- Ngày tạo tài khoản -->
                                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                        <div class="flex-grow-1">
                                            <p class="text-muted mb-0">
                                                <strong>Tham gia:</strong>
                                                @Model.CreatedAt.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("vi-VN"))
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Lưu trữ giá trị ban đầu để so sánh
    let originalValues = {};
    function editField(name) {
        console.log('Editing field:', name);

        // Ẩn tất cả các form chỉnh sửa đang mở
        const allEditForms = document.querySelectorAll('[id$="-edit"]');
        allEditForms.forEach(form => {
            form.style.setProperty('display', 'none', 'important');
        });

        // Hiển thị tất cả các display và actions
        const allDisplays = document.querySelectorAll('[id$="-display"]');
        allDisplays.forEach(display => {
            display.style.setProperty('display', 'block', 'important');
        });

        const allActions = document.querySelectorAll('[id$="-actions"]');
        allActions.forEach(action => {
            if (action) {
                // Bio hiển thị inline-block, các field khác hiển thị flex
                if (action.id === 'bio-actions') {
                    action.style.setProperty('display', 'inline-block', 'important');
                } else {
                    action.style.setProperty('display', 'flex', 'important');
                }
            }
        });

        // Lưu giá trị ban đầu
        const inputElement = document.getElementById(name + "-input");
        if (inputElement) {
            originalValues[name] = inputElement.value;
        }

        // Ẩn display và actions CỦA FIELD HIỆN TẠI, hiển thị form chỉnh sửa
        const displayElement = document.getElementById(name + "-display");
        const actionsElement = document.getElementById(name + "-actions");
        const editElement = document.getElementById(name + "-edit");

        if (displayElement) {
            displayElement.style.setProperty('display', 'none', 'important');
            console.log('Hidden display:', name + "-display");
        }

        if (actionsElement) {
            actionsElement.style.setProperty('display', 'none', 'important');
            console.log('Hidden actions:', name + "-actions");
        }

        if (editElement) {
            editElement.style.setProperty('display', 'block', 'important');
            console.log('Shown edit form:', name + "-edit");
        }

        // Reset nút lưu về disabled
        const saveBtn = document.getElementById(name + "-save-btn");
        if (saveBtn) {
            saveBtn.disabled = true;
        }
}

    function cancelEdit(displayId, editId, actionsId) {
        console.log('Canceling edit:', displayId, editId, actionsId);

        const displayElement = document.getElementById(displayId);
        const editElement = document.getElementById(editId);
        const actionsElement = document.getElementById(actionsId);

        if (displayElement) {
            displayElement.style.setProperty('display', 'block', 'important');
        }

        if (editElement) {
            editElement.style.setProperty('display', 'none', 'important');
        }

        if (actionsElement) {
            // Bio hiển thị inline-block, các field khác hiển thị flex
            if (actionsId === 'bio-actions') {
                actionsElement.style.setProperty('display', 'inline-block', 'important');
            } else {
                actionsElement.style.setProperty('display', 'flex', 'important');
            }
        }

        // Khôi phục giá trị ban đầu
        const fieldName = displayId.replace('-display', '');
        const inputElement = document.getElementById(fieldName + "-input");
        if (inputElement && originalValues[fieldName] !== undefined) {
            inputElement.value = originalValues[fieldName];
        }
}

    // Hàm riêng cho fullname - SỬA LẠI VỚI !important
    function editFullName() {
        console.log('Editing fullname');

        const display = document.getElementById("fullname-display");
        const input = document.getElementById("fullname-input");
        const editBtn = document.getElementById("fullname-edit-btn");
        const actions = document.getElementById("fullname-actions");

        // Ẩn display và nút edit
        if (display) {
            display.style.setProperty('display', 'none', 'important');
            console.log('Hidden fullname display');
        }

        if (editBtn) {
            editBtn.style.setProperty('display', 'none', 'important');
            console.log('Hidden fullname edit button');
        }

        // Hiện input và actions (save/cancel)
        if (input) {
            input.style.setProperty('display', 'block', 'important');
            console.log('Shown fullname input');
        }

        if (actions) {
            actions.style.setProperty('display', 'inline-block', 'important');
            console.log('Shown fullname actions');
        }

        // Đổ dữ liệu vào input
        if (input && display) {
            input.value = display.innerText.trim();
            console.log('Set input value to:', input.value);
        }
    }

    function saveFullName() {
        console.log('Saving fullname');

        const input = document.getElementById("fullname-input");
        const newName = input.value.trim();

        if (!newName) return; 

        const saveBtn = document.getElementById("fullname-save-btn");

        saveBtn.disabled = true;
        saveBtn.innerText = "Đang lưu...";

        fetch('/Profile/UpdateField', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({
                field: "FullName", 
                value: newName,
                dateValue: null
            })
        })
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    document.getElementById("fullname-display").innerText = newName;

                    const display = document.getElementById("fullname-display");
                    const editBtn = document.getElementById("fullname-edit-btn");
                    const actions = document.getElementById("fullname-actions");

                    if (display) display.style.setProperty('display', 'inline-block', 'important');
                    if (input) input.style.setProperty('display', 'none', 'important');
                    if (editBtn) editBtn.style.setProperty('display', 'inline-block', 'important');
                    if (actions) actions.style.setProperty('display', 'none', 'important');

                    showToast('Đã cập nhật tên thành công', 'success');
                } else {
                    alert(data.message || "Lưu thất bại!");
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert("Đã xảy ra lỗi khi lưu: " + error.message);
            })
            .finally(() => {
                if(saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerText = "Lưu";
                }
            });
    }

    function cancelFullName() {
        console.log('Canceling fullname edit');

        // Khôi phục giao diện
        const display = document.getElementById("fullname-display");
        const input = document.getElementById("fullname-input");
        const editBtn = document.getElementById("fullname-edit-btn");
        const actions = document.getElementById("fullname-actions");

        if (display) display.style.setProperty('display', 'inline-block', 'important');
        if (input) input.style.setProperty('display', 'none', 'important');
        if (editBtn) editBtn.style.setProperty('display', 'inline-block', 'important');
        if (actions) actions.style.setProperty('display', 'none', 'important');

        console.log('Restored fullname UI');
    }
    
    function checkChanges(fieldName, originalValue) {
        const inputElement = document.getElementById(fieldName + "-input");
        const saveBtn = document.getElementById(fieldName + "-save-btn");

        if (!inputElement || !saveBtn) return;

        const currentValue = inputElement.value.trim();

        if (currentValue !== originalValue && currentValue !== '') {
            saveBtn.disabled = false;
        } else {
            saveBtn.disabled = true;
        }
}

    function checkBirthDateChanges() {
        const inputElement = document.getElementById("birth-input");
        const saveBtn = document.getElementById("birth-save-btn");
        const originalValue = "@(Model.BirthDate?.ToString("yyyy-MM-dd"))";

        if (!inputElement || !saveBtn) return;

        const currentValue = inputElement.value;

        if (currentValue !== originalValue && currentValue !== '') {
            saveBtn.disabled = false;
        } else {
            saveBtn.disabled = true;
        }
}

    function saveField(fieldName, inputId, displayId, editId) {
        const inputElement = document.getElementById(inputId);
        if (!inputElement) {
            console.error('Input element not found:', inputId);
            return;
        }

        let value = null;

        if (inputElement.tagName === 'SELECT') {
            value = inputElement.value;
        } else if (inputElement.tagName === 'TEXTAREA') {
            value = inputElement.value.trim();
        } else {
            value = inputElement.value.trim();
        }

        const allowedFields = ['Bio', 'FullName', 'Gender', 'BirthDate', 'Email', 'PhoneNumber'];
        if (!allowedFields.includes(fieldName)) {
            alert("Không được phép chỉnh sửa trường này!");
            return;
        }

        console.log('Saving field:', fieldName, 'Value:', value);

        fetch('/Profile/UpdateField', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({
                field: fieldName,
                value: value,
                dateValue: null
            })
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log('Response data:', data);

                if (data.success) {
                    updateDisplayAfterSave(fieldName, value, displayId);

                    const fieldNameShort = displayId.replace('-display', '');
                    const actionsElement = document.getElementById(fieldNameShort + "-actions");
                    if (actionsElement) {
                        // Bio hiển thị inline-block, các field khác hiển thị flex
                        if (fieldNameShort === 'bio') {
                            actionsElement.style.setProperty('display', 'inline-block', 'important');
                        } else {
                            actionsElement.style.setProperty('display', 'flex', 'important');
                        }
                    }

                    document.getElementById(displayId).style.setProperty('display', 'block', 'important');
                    document.getElementById(editId).style.setProperty('display', 'none', 'important');
                    showToast('Đã cập nhật thông tin thành công', 'success');
                } else {
                    alert(data.message || "Lưu thất bại!");
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert("Đã xảy ra lỗi khi lưu: " + error.message);
            });
    }
    
    function updateDisplayAfterSave(fieldName, value, displayId) {
        const displayElement = document.getElementById(displayId);

        if (fieldName === 'FullName') {
            const span = displayElement.querySelector('span');
            if (span) {
                span.innerText = value || '@Model.Username';
            }
        }
        else if (fieldName === 'Bio') {
            const span = displayElement.querySelector('span');
            if (span) {
                span.innerText = value || "Chưa có mô tả";
            }
        }
        else if (fieldName === 'Gender') {
            const genderText = value === 'Male' ? 'Nam' :
                value === 'Female' ? 'Nữ' :
                    value === 'Other' ? 'Khác' : 'Chưa có thông tin để hiển thị';

            displayElement.innerHTML = `<strong>Giới tính:</strong> ${genderText}`;
        }
        else if (fieldName === 'Email') {
            const span = displayElement.querySelector('span');
            if (span) {
                span.innerText = value || '';
            }
        }
        else if (fieldName === 'PhoneNumber') {
            const span = displayElement.querySelector('span');
            if (span) {
                span.innerText = value || '';
            }
        }
}

    function saveBirthDate() {
        const inputElement = document.getElementById("birth-input");
        if (!inputElement) {
            console.error('Birth input not found');
            return;
        }

        const value = inputElement.value;
        console.log('Saving birth date:', value);

        fetch('/Profile/UpdateField', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({
                field: "BirthDate",
                value: null,
                dateValue: value
            })
        })
            .then(res => {
                console.log('Response status:', res.status);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log('Response data:', data);

                if (data.success) {
                    const formatted = value ? new Date(value).toLocaleDateString('vi-VN') : "Chưa có thông tin để hiển thị";
                    document.getElementById("birth-display").innerHTML = `<strong>Ngày sinh:</strong> ${formatted}`;

                    const actionsElement = document.getElementById("birth-actions");
                    if (actionsElement) {
                        actionsElement.style.setProperty('display', 'flex', 'important');
                    }

                    document.getElementById('birth-display').style.setProperty('display', 'block', 'important');
                    document.getElementById('birth-edit').style.setProperty('display', 'none', 'important');
                    showToast('Đã cập nhật ngày sinh thành công', 'success');
                } else {
                    alert(data.message || "Lưu thất bại!");
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert("Đã xảy ra lỗi khi lưu: " + error.message);
            });
    }
     
    function toggleFollow(userId, isFollowing) {
        console.log('toggleFollow called:', userId, isFollowing);

        const url = isFollowing ? '/Profile/Unfollow' : '/Profile/Follow';
        const btn = document.getElementById('followBtn');

        if (btn) btn.disabled = true;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({ userId: userId })
        })
            .then(res => {
                console.log('Response status:', res.status);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log('Response data:', data);

                if (data.success) {
                    if (btn) {
                        if (data.isFollowing) {
                            btn.textContent = 'Đang theo dõi';
                            btn.className = 'btn btn-outline-primary btn-lg px-5';
                            btn.onclick = () => toggleFollow(userId, true);
                        } else {
                            btn.textContent = 'Theo dõi';
                            btn.className = 'btn btn-primary btn-lg px-5';
                            btn.onclick = () => toggleFollow(userId, false);
                        }
                        btn.disabled = false;
                    }

                    if (data.followerCount !== undefined) {
                        const followerCountElem = document.querySelector('.d-flex.justify-content-center.gap-5 .text-dark.fs-4');
                        if (followerCountElem) {
                            followerCountElem.textContent = data.followerCount;
                        }
                    }
                } else {
                    alert(data.message || 'Đã xảy ra lỗi');
                    if (btn) btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Đã xảy ra lỗi khi thực hiện thao tác: ' + error.message);
                if (btn) btn.disabled = false;
            });
    }

    function togglePrivacy(field, isPublic) {
        console.log('togglePrivacy:', field, isPublic);

        fetch('@Url.Action("UpdatePrivacy", "Profile")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({
                field: field,
                isPublic: isPublic
            })
        })
            .then(res => {
                console.log('Response status:', res.status);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log('Response data:', data);

                if (data.success) {
                    showToast('Đã cập nhật cài đặt riêng tư', 'success');
                } else {
                    alert(data.message || 'Cập nhật thất bại');
                    const switchElem = document.querySelector(`[onchange*="${field}"]`);
                    if (switchElem) {
                        switchElem.checked = !isPublic;
                    }
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Đã xảy ra lỗi: ' + error.message);
                const switchElem = document.querySelector(`[onchange*="${field}"]`);
                if (switchElem) {
                    switchElem.checked = !isPublic;
                }
            });
    }

    // Hàm hiển thị toast notification
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
        toast.style.zIndex = '9999';
        toast.style.minWidth = '300px';
        toast.textContent = message;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.5s';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    // JavaScript để xử lý modal media toàn màn hình
    document.addEventListener('DOMContentLoaded', function() {
        const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
        const modalCarousel = document.getElementById('modalCarousel');
        const modalCarouselInner = modalCarousel.querySelector('.carousel-inner');
        const modalCurrentSlideSpan = document.getElementById('modalCurrentSlide');
        const modalTotalSlidesSpan = document.getElementById('modalTotalSlides');
        const blurredBackground = document.getElementById('blurredBackground');
        const prevButton = modalCarousel.querySelector('.carousel-control-prev');
        const nextButton = modalCarousel.querySelector('.carousel-control-next');
        
        let currentPostMedia = [];
        let currentPostId = null;
        let currentPostCarousel = null;
        let lastModalMediaIndex = 0; // Lưu vị trí media cuối cùng trong modal
        let playingVideos = new Map(); // Lưu các video đang phát
        
        // Biến lưu trữ tất cả media của bài post
        const postMediaMap = new Map();
        
        // Biến lưu trữ carousel instances
        const postCarousels = new Map();
        
        // Khởi tạo dữ liệu media cho từng bài post và carousel instances
        document.querySelectorAll('.card.mb-3').forEach(card => {
            const postId = card.querySelector('.media-modal-link')?.dataset?.postId;
            if (postId) {
                const mediaItems = [];
                card.querySelectorAll('.carousel-item').forEach((item, index) => {
                    const videoElement = item.querySelector('video');
                    const imgElement = item.querySelector('img');
                    
                    if (videoElement) {
                        mediaItems.push({
                            type: 'video',
                            src: videoElement.dataset.src || videoElement.querySelector('source')?.src,
                            alt: videoElement.dataset.mediaName || '',
                            name: videoElement.dataset.mediaName || '',
                            element: videoElement
                        });
                    } else if (imgElement) {
                        mediaItems.push({
                            type: 'image',
                            src: imgElement.dataset.src || imgElement.src,
                            alt: imgElement.alt,
                            name: imgElement.dataset.mediaName || '',
                            element: imgElement
                        });
                    }
                });
                postMediaMap.set(postId, mediaItems);
                
                // Lưu carousel instance
                const carouselElement = document.getElementById(`carousel-${postId}`);
                if (carouselElement) {
                    const carouselInstance = new bootstrap.Carousel(carouselElement);
                    postCarousels.set(postId, carouselInstance);
                }
            }
        });
        
        // Lắng nghe click vào media
        document.querySelectorAll('.media-modal-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const postId = this.dataset.postId;
                const mediaIndex = parseInt(this.dataset.mediaIndex);
                const totalMedia = parseInt(this.dataset.totalMedia);
                const mediaType = this.dataset.mediaType;
                
                currentPostId = postId;
                currentPostMedia = postMediaMap.get(postId) || [];
                currentPostCarousel = postCarousels.get(postId);
                lastModalMediaIndex = mediaIndex; // Lưu vị trí bắt đầu
                
                // Cập nhật tổng số media
                modalTotalSlidesSpan.textContent = currentPostMedia.length;
                
                // Ẩn/Hiện counter và nút điều hướng dựa trên số lượng media
                const counterElement = document.querySelector('.carousel-counter-modal');
                if (currentPostMedia.length <= 1) {
                    // Ẩn counter và nút điều hướng nếu chỉ có 1 media
                    if (counterElement) counterElement.style.display = 'none';
                    if (prevButton) prevButton.style.display = 'none';
                    if (nextButton) nextButton.style.display = 'none';
                } else {
                    // Hiện counter và nút điều hướng nếu có nhiều media
                    if (counterElement) counterElement.style.display = 'block';
                    if (prevButton) prevButton.style.display = 'flex';
                    if (nextButton) nextButton.style.display = 'flex';
                }
                
                // Xóa nội dung carousel cũ
                modalCarouselInner.innerHTML = '';
                
                // Thêm các media vào carousel modal
                currentPostMedia.forEach((media, index) => {
                    const carouselItem = document.createElement('div');
                    carouselItem.className = `carousel-item h-100 ${index === mediaIndex ? 'active' : ''}`;
                    
                    const mediaContainer = document.createElement('div');
                    mediaContainer.className = 'd-flex justify-content-center align-items-center h-100';
                    
                    if (media.type === 'image') {
                        const img = document.createElement('img');
                        img.src = media.src;
                        img.alt = media.alt;
                        img.className = 'img-fluid modal-media';
                        img.style.maxHeight = '95vh';
                        img.style.maxWidth = '95vw';
                        img.style.objectFit = 'contain';
                        img.style.cursor = 'pointer';
                        
                        // Thêm sự kiện click để đóng modal khi click vào ảnh
                        img.addEventListener('click', function() {
                            imageModal.hide();
                        });
                        
                        mediaContainer.appendChild(img);
                    } else if (media.type === 'video') {
                        const videoContainer = document.createElement('div');
                        videoContainer.className = 'position-relative w-100 h-100';
                        
                        const video = document.createElement('video');
                        video.className = 'modal-video';
                        video.controls = true;
                        video.controlsList = 'nodownload';
                        video.preload = 'auto';
                        video.autoplay = index === mediaIndex; // Tự động phát video khi mở modal
                        video.style.maxHeight = '95vh';
                        video.style.maxWidth = '95vw';
                        video.style.objectFit = 'contain';
                        video.style.backgroundColor = '#000';
                        
                        const source = document.createElement('source');
                        source.src = media.src;
                        source.type = 'video/mp4';
                        
                        video.appendChild(source);
                        video.appendChild(document.createTextNode('Trình duyệt của bạn không hỗ trợ video.'));
                        
                        // Lưu tham chiếu video để quản lý
                        video.dataset.mediaIndex = index;
                        
                        // Thêm sự kiện để quản lý trạng thái phát
                        video.addEventListener('play', function() {
                            playingVideos.set(index, video);
                            
                            // Dừng các video khác đang phát
                            playingVideos.forEach((vid, idx) => {
                                if (idx !== index && !vid.paused) {
                                    vid.pause();
                                }
                            });
                        });
                        
                        video.addEventListener('pause', function() {
                            playingVideos.delete(index);
                        });
                        
                        videoContainer.appendChild(video);
                        mediaContainer.appendChild(videoContainer);
                    }
                    
                    carouselItem.appendChild(mediaContainer);
                    modalCarouselInner.appendChild(carouselItem);
                });
                
                // Khởi tạo lại carousel modal
                const modalCarouselInstance = new bootstrap.Carousel(modalCarousel, {
                    interval: false
                });
                
                // Điều hướng đến media được click
                modalCarouselInstance.to(mediaIndex);
                
                // Cập nhật số slide hiện tại
                modalCurrentSlideSpan.textContent = mediaIndex + 1;
                
                // Cập nhật background mờ (chỉ cho ảnh)
                updateBlurredBackground(mediaIndex);
                
                // Hiển thị modal
                imageModal.show();
            });
        });
        
        // Lắng nghe sự kiện chuyển slide trong modal
        modalCarousel.addEventListener('slide.bs.carousel', function(event) {
            const nextSlide = event.to;
            lastModalMediaIndex = nextSlide; // Cập nhật vị trí cuối cùng
            modalCurrentSlideSpan.textContent = nextSlide + 1;
            updateBlurredBackground(nextSlide);
            
            // Dừng video hiện tại khi chuyển slide
            playingVideos.forEach(video => {
                if (!video.paused) {
                    video.pause();
                }
            });
            playingVideos.clear();
            
            // Tự động phát video nếu slide mới là video
            setTimeout(() => {
                const activeItem = modalCarouselInner.querySelector('.carousel-item.active');
                if (activeItem) {
                    const video = activeItem.querySelector('video');
                    if (video) {
                        video.play().catch(e => console.log('Autoplay failed:', e));
                    }
                }
            }, 300);
        });
        
        // Khi modal đóng, cập nhật carousel trong post và reset UI
        document.getElementById('imageModal').addEventListener('hidden.bs.modal', function() {
            // Dừng tất cả video đang phát
            playingVideos.forEach(video => {
                if (!video.paused) {
                    video.pause();
                }
            });
            playingVideos.clear();
            
            if (currentPostCarousel && currentPostId) {
                // Chuyển carousel trong post đến vị trí media cuối cùng xem trong modal
                currentPostCarousel.to(lastModalMediaIndex);
                
                // Cập nhật counter trong post
                const postCurrentSlideSpan = document.getElementById(`current-slide-${currentPostId}`);
                if (postCurrentSlideSpan) {
                    postCurrentSlideSpan.textContent = lastModalMediaIndex + 1;
                }
            }
            
            // Hiển thị lại counter và nút điều hướng (để chuẩn bị cho lần mở tiếp theo)
            const counterElement = document.querySelector('.carousel-counter-modal');
            if (counterElement) counterElement.style.display = 'block';
            if (prevButton) prevButton.style.display = 'none'; // Vẫn ẩn mặc định
            if (nextButton) nextButton.style.display = 'none'; // Vẫn ẩn mặc định
            
            // Reset biến
            currentPostMedia = [];
            currentPostId = null;
            currentPostCarousel = null;
            blurredBackground.innerHTML = '';
            modalCarouselInner.innerHTML = '';
            modalCurrentSlideSpan.textContent = '1';
            modalTotalSlidesSpan.textContent = '0';
        });
        
        // Hàm cập nhật background mờ (chỉ cho ảnh)
        function updateBlurredBackground(slideIndex) {
            blurredBackground.innerHTML = '';
            
            if (currentPostMedia.length > 0 && slideIndex < currentPostMedia.length) {
                const currentMedia = currentPostMedia[slideIndex];
                
                // Chỉ tạo background mờ cho ảnh
                if (currentMedia.type === 'image') {
                    const backgroundImage = document.createElement('img');
                    backgroundImage.src = currentMedia.src;
                    backgroundImage.style.width = '100%';
                    backgroundImage.style.height = '100%';
                    backgroundImage.style.objectFit = 'cover';
                    backgroundImage.style.filter = 'blur(20px) brightness(0.3)';
                    backgroundImage.style.position = 'absolute';
                    backgroundImage.style.top = '0';
                    backgroundImage.style.left = '0';
                    
                    blurredBackground.appendChild(backgroundImage);
                } else if (currentMedia.type === 'video') {
                    // Video không có background mờ, chỉ hiển thị background tối
                    blurredBackground.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
                }
            }
        }
        
        // Lắng nghe click vào nút đóng modal
        document.querySelector('#imageModal .btn-close').addEventListener('click', function() {
            imageModal.hide();
        });
        
        // Cho phép đóng modal bằng phím ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && imageModal._isShown) {
                imageModal.hide();
            }
            
            // Thêm phím mũi tên để chuyển media (chỉ khi có nhiều hơn 1 media)
            if (imageModal._isShown && currentPostMedia.length > 1) {
                const carouselInstance = bootstrap.Carousel.getInstance(modalCarousel);
                if (e.key === 'ArrowLeft') {
                    carouselInstance.prev();
                } else if (e.key === 'ArrowRight') {
                    carouselInstance.next();
                }
            }
        });
        
        // Click bên ngoài media để đóng modal
        document.getElementById('imageModal').addEventListener('click', function(e) {
            // Chỉ đóng khi click vào background, không phải vào media
            if (e.target === this || 
                (e.target.classList.contains('modal-body') && 
                 !e.target.closest('.carousel-item') &&
                 !e.target.closest('.modal-video') &&
                 !e.target.closest('.modal-media'))) {
                imageModal.hide();
            }
        });

        // JavaScript cho vote (AJAX) (thừa)
        // document.querySelectorAll('.vote-btn').forEach(btn => {
        //     btn.addEventListener('click', async function(e) {
        //         e.stopPropagation(); // Ngăn chặn sự kiện click vào bài viết
        //        
        //         const postId = this.dataset.postId;
        //         const isUpvote = this.dataset.voteType === 'true';
        //        
        //         try {
        //             const response = await fetch('/Post/Vote', {
        //                 method: 'POST',
        //                 headers: {
        //                     'Content-Type': 'application/x-www-form-urlencoded',
        //                     'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
        //                 },
        //                 body: `postId=${postId}&isUpvote=${isUpvote}`
        //             });
        //            
        //             const data = await response.json();
        //             if (data.success) {
        //                 // Cập nhật tổng điểm vote
        //                 const voteScoreElement = document.querySelector(`.vote-score[data-post-id="${postId}"]`);
        //                 if (voteScoreElement) {
        //                     voteScoreElement.textContent = data.voteScore < 0 ? 0 : data.voteScore;
        //                 }
        //             } else {
        //                 alert(data.message || 'Có lỗi xảy ra');
        //             }
        //         } catch (error) {
        //             console.error('Error:', error);
        //             alert('Có lỗi xảy ra khi vote');
        //         }
        //     });
        // });

        // JavaScript để cập nhật số đếm khi chuyển slide trong carousel post
        document.querySelectorAll('.carousel').forEach(carousel => {
            const carouselId = carousel.id;
            if (!carouselId) return;
            
            const postId = carouselId.replace('carousel-', '');
            const currentSlideSpan = document.getElementById(`current-slide-${postId}`);
            const totalSlidesSpan = document.getElementById(`total-slides-${postId}`);

            if (currentSlideSpan && totalSlidesSpan) {
                // Lắng nghe sự kiện slide.bs.carousel
                carousel.addEventListener('slide.bs.carousel', function (event) {
                    const activeSlide = event.to;
                    currentSlideSpan.textContent = activeSlide + 1;
                });
            }
        });

        // Thêm sự kiện click vào bài viết để đi đến trang chi tiết
        document.querySelectorAll('.post-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // Chỉ điều hướng nếu không click vào các phần tử con cần thiết
                if (!e.target.closest('.dropdown') && 
                    !e.target.closest('.vote-btn') && 
                    !e.target.closest('a') &&
                    !e.target.closest('.media-modal-link') &&
                    !e.target.closest('video') &&
                    !e.target.closest('button') &&
                    !e.target.closest('.dropdown-menu')) {
                    
                    const postId = this.dataset.postId;
                    if (postId) {
                        window.location.href = `/Post/Details/${postId}`;
                    }
                }
            });
        });
    });
    // ========== XỬ LÝ MODAL BÁO CÁO ==========

    // Biến lưu modal instance
    let reportModal = null;
    let currentReportPostId = null;

    // Khởi tạo modal báo cáo
    function initReportModal() {
        const modalElement = document.getElementById('reportModal');
        if (modalElement) {
            reportModal = new bootstrap.Modal(modalElement, {
                backdrop: 'static', // Ngăn không cho đóng khi click ra ngoài
                keyboard: true      // Cho phép đóng bằng phím ESC
            });

            // Xử lý khi modal đóng HOÀN TOÀN
            modalElement.addEventListener('hidden.bs.modal', function() {
                console.log('Report modal fully hidden');
                resetReportModal();

                // Đảm bảo backdrop được xóa
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop && backdrop.classList.contains('show')) {
                    backdrop.remove();
                }

                // Khôi phục body style
                document.body.classList.remove('modal-open');
                document.body.style.paddingRight = '';
            });

            // Xử lý khi modal bắt đầu ẩn
            modalElement.addEventListener('hide.bs.modal', function() {
                console.log('Report modal starting to hide');
            });

            console.log('Report modal initialized');
        }
    }

    // Hàm tải form báo cáo
    async function loadReportForm(postId) {
        currentReportPostId = postId;

        const modalBody = document.getElementById('reportModalBody');
        const modalLabel = document.getElementById('reportModalLabel');
        if (!modalBody) return;

        // Hiển thị loading
        modalBody.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Đang tải form báo cáo...</p>
            </div>
        `;

        // Đảm bảo modal được hiển thị
        if (reportModal) {
            reportModal.show();
        }

        try {
            const response = await fetch(`/PostReport/ReportForm/${postId}`);

            if (response.ok) {
                const html = await response.text();

                // Kiểm tra nếu response là JSON error
                if (html.trim().startsWith('{')) {
                    try {
                        const data = JSON.parse(html);
                        modalBody.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                ${data.message || 'Không thể tải form báo cáo.'}
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-secondary" onclick="retryLoadReportForm()">Thử lại</button>
                                <button class="btn btn-outline-secondary ms-2" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        `;
                        return;
                    } catch (e) {
                        // Không phải JSON, tiếp tục xử lý
                    }
                }

                modalBody.innerHTML = html;

                // Thêm animation cho form
                const formContainer = modalBody.querySelector('.report-form-container');
                if (formContainer) {
                    formContainer.style.opacity = '0';
                    formContainer.style.transform = 'translateY(10px)';
                    formContainer.style.transition = 'all 0.3s ease';

                    setTimeout(() => {
                        formContainer.style.opacity = '1';
                        formContainer.style.transform = 'translateY(0)';
                    }, 50);
                }

                // Cập nhật tiêu đề modal
                if (modalLabel) {
                    modalLabel.textContent = 'Báo cáo bài đăng';
                }

                // Bind sự kiện submit form
                bindReportFormSubmit();
            } else {
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Không thể tải form báo cáo. Vui lòng thử lại.
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-secondary" onclick="retryLoadReportForm()">Thử lại</button>
                        <button class="btn btn-outline-secondary ms-2" data-bs-dismiss="modal">Đóng</button>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading report form:', error);
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Lỗi kết nối mạng. Vui lòng kiểm tra kết nối và thử lại.
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-secondary" onclick="retryLoadReportForm()">Thử lại</button>
                    <button class="btn btn-outline-secondary ms-2" data-bs-dismiss="modal">Đóng</button>
                </div>
            `;
        }
    }

    // Hàm bind sự kiện submit form báo cáo
    function bindReportFormSubmit() {
        const form = document.querySelector('#reportModalBody .report-form');
        if (!form) return;

        // Xóa event listener cũ nếu có
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);

        newForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            e.stopPropagation();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            // Hiển thị loading
            submitBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Đang gửi...
            `;
            submitBtn.disabled = true;

            try {
                const formData = new FormData(this);
                const response = await fetch('/PostReport/Report', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    // Hiển thị thông báo thành công
                    showReportSuccess('Báo cáo đã được gửi thành công!');

                    // Đóng modal sau 2 giây
                    setTimeout(() => {
                        if (reportModal) {
                            reportModal.hide();
                        }
                    }, 2000);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showReportError(errorData.message || 'Có lỗi xảy ra khi gửi báo cáo.');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error submitting report:', error);
                showReportError('Lỗi kết nối mạng. Vui lòng thử lại.');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    }

    // Hàm hiển thị thông báo thành công
    function showReportSuccess(message) {
        const modalBody = document.getElementById('reportModalBody');
        if (modalBody) {
            modalBody.innerHTML = `
                <div class="text-center py-5">
                    <div class="mb-3">
                        
                    </div>
                    <h5 class="text-success">Thành công!</h5>
                    <p class="text-muted">${message}</p>
                    <div class="mt-4">
                        <p class="text-muted small">Modal sẽ tự động đóng trong 2 giây...</p>
                        <button class="btn" onclick="closeReportModal()">Đóng ngay</button>
                    </div>
                </div>
            `;
        }
    }

    // Hàm hiển thị thông báo lỗi
    function showReportError(message) {
        const modalBody = document.getElementById('reportModalBody');
        if (modalBody) {
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger alert-dismissible fade show mb-3';
            errorAlert.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            modalBody.prepend(errorAlert);

            // Tự động đóng alert sau 5 giây
            setTimeout(() => {
                if (errorAlert.parentNode) {
                    const bsAlert = new bootstrap.Alert(errorAlert);
                    bsAlert.close();
                }
            }, 5000);
        }
    }

    // Hàm đóng modal báo cáo
    function closeReportModal() {
        if (reportModal) {
            reportModal.hide();
        }
    }

    // Hàm reset modal về trạng thái ban đầu
    function resetReportModal() {
        const modalBody = document.getElementById('reportModalBody');
        if (modalBody) {
            modalBody.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
        }
        currentReportPostId = null;

        // Reset backdrop và body classes
        cleanupModalBackdrops();
    }

    // Hàm dọn dẹp backdrop
    function cleanupModalBackdrops() {
        // Xóa tất cả backdrop
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.remove();
        });

        // Xóa modal-open class nếu không có modal nào đang mở
        const openModals = document.querySelectorAll('.modal.show');
        if (openModals.length === 0) {
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
        }
    }

    // Hàm retry tải form báo cáo
    function retryLoadReportForm() {
        if (currentReportPostId) {
            loadReportForm(currentReportPostId);
        }
    }

    // Khởi tạo sự kiện cho các nút báo cáo
    function initReportButtons() {
        // Xử lý click vào nút báo cáo trong dropdown
        document.querySelectorAll('.dropdown-item.text-warning[data-bs-target="#reportModal"]').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                // Lấy postId từ bài đăng cha
                const postCard = this.closest('.post-card') ||
                    this.closest('.card') ||
                    this.closest('[data-post-id]');

                let postId = null;

                if (postCard) {
                    postId = postCard.dataset.postId;
                }

                // Nếu không tìm thấy, thử lấy từ onclick attribute
                if (!postId && this.getAttribute('onclick')) {
                    const match = this.getAttribute('onclick').match(/loadReportForm\('([^']+)'\)/);
                    if (match) {
                        postId = match[1];
                    }
                }

                if (postId) {
                    console.log('Loading report form for post:', postId);
                    loadReportForm(postId);
                } else {
                    console.error('Could not find postId for report button');
                }
            });
        });
    }

    // ========== KHỞI TẠO KHI DOM READY ==========

    document.addEventListener('DOMContentLoaded', function() {
        // Khởi tạo modal báo cáo
        initReportModal();

        // Khởi tạo sự kiện cho các nút báo cáo
        initReportButtons();

        // Thêm CSS cho modal báo cáo
        addReportModalStyles();

        // Xử lý ESC key để đóng modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && reportModal && reportModal._isShown) {
                reportModal.hide();
            }
        });
    });

    // Thêm CSS cho modal báo cáo
    function addReportModalStyles() {
        const style = document.createElement('style');
        style.textContent = `
            /* Modal báo cáo styling */
            #reportModal .modal-dialog {
                max-width: 500px;
            }
            
            #reportModal .modal-header {
                background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
                color: white;
                border-bottom: none;
            }
            
            #reportModal .modal-header .btn-close {
                filter: invert(1);
                opacity: 0.8;
                background: none;
                font-size: 1.5rem;
            }
            
            #reportModal .modal-header .btn-close:hover {
                opacity: 1;
                background: rgba(255, 255, 255, 0.1);
            }
            
            /* Nút báo cáo trong dropdown */
            .dropdown-item.text-warning {
                color: #ffc107 !important;
            }
            
            .dropdown-item.text-warning:hover {
                background-color: rgba(255, 193, 7, 0.1) !important;
                color: #e0a800 !important;
            }
            
            /* Form báo cáo */
            .report-form textarea {
                resize: vertical;
                min-height: 120px;
            }
            
            .report-form textarea:focus {
                border-color: #ffc107;
                box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25);
            }
            
            /* Fix backdrop z-index */
            .modal-backdrop {
                z-index: 1040;
            }
            
            #reportModal {
                z-index: 1055;
            }
        `;
        document.head.appendChild(style);
    }

    // Global function để gọi từ HTML
    window.loadReportForm = loadReportForm;
    window.retryLoadReportForm = retryLoadReportForm;
    window.closeReportModal = closeReportModal;
</script>
}