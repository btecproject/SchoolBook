@{
    ViewData["Title"] = "Đăng ký khuôn mặt";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5" style="max-width: 600px;">
    <h3 class="text-center mb-4">Đăng ký khuôn mặt</h3>

    <div class="text-center">
        <video id="video" width="480" height="360" autoplay playsinline class="border rounded-3 shadow-sm"></video>
        <canvas id="canvas" width="480" height="360" class="d-none"></canvas>

        <div class="mt-3">
            <button type="button" id="capture" class="btn btn-primary me-2">Chụp ảnh</button>
            <button type="button" id="retake" class="btn btn-secondary d-none">Chụp lại</button>
            <button type="button" id="submit" class="btn btn-success d-none">Gửi đăng ký</button>
        </div>
    </div>
</div>

<form id="faceForm" method="post" asp-action="RegisterFace" enctype="multipart/form-data" class="d-none">
    <input type="hidden" name="faceImage" id="faceImage" />
</form>

@section Scripts {
<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('capture');
    const retakeBtn = document.getElementById('retake');
    const submitBtn = document.getElementById('submit');
    const form = document.getElementById('faceForm');
    const faceInput = document.getElementById('faceImage');
    const ctx = canvas.getContext('2d');

    // Bật webcam
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => video.srcObject = stream)
        .catch(err => alert("Không thể truy cập camera: " + err));

    // Chụp ảnh
    captureBtn.onclick = () => {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        video.classList.add("d-none");
        canvas.classList.remove("d-none");
        captureBtn.classList.add("d-none");
        retakeBtn.classList.remove("d-none");
        submitBtn.classList.remove("d-none");

        // Lưu ảnh base64 vào input ẩn
        faceInput.value = canvas.toDataURL("image/png");
    };

    // Chụp lại
    retakeBtn.onclick = () => {
        video.classList.remove("d-none");
        canvas.classList.add("d-none");
        captureBtn.classList.remove("d-none");
        retakeBtn.classList.add("d-none");
        submitBtn.classList.add("d-none");
    };

    // Gửi form
    submitBtn.onclick = () => form.submit();
</script>
}
