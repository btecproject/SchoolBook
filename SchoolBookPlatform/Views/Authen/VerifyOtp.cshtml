@model SchoolBookPlatform.ViewModels.OtpViewModel

@{
    ViewData["Title"] = "Otp Verification";
    //ĐỌC TỪ MODEL TRƯỚC, SAU ĐÓ MỚI ĐẾN ViewData
    var otpType = Model.Type ?? ViewData["OtpType"]?.ToString() ?? "SMS";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-body">
                    <h3 class="text-center mb-4">Xác minh OTP</h3>
                    <p class="text-center text-muted">
                        Mã OTP đã được gửi qua <strong>@(otpType == "Email" ? "Email" : "SMS")</strong>
                        đến <strong>@(otpType == "Email" ? "email" : "số điện thoại")</strong> của bạn.
                    </p>

                    <form asp-action="VerifyOtp" method="post" id="verifyForm">
                        @Html.AntiForgeryToken()
                        <input asp-for="Type" type="hidden"/>
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <div class="mb-3">
                            <label asp-for="Code" class="form-label">Nhập mã OTP</label>
                            <input asp-for="Code" class="form-control text-center fs-3"
                                   placeholder="------" maxlength="6" autocomplete="off"/>
                            <span asp-validation-for="Code" class="text-danger"></span>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mb-2">Xác minh</button>
                    </form>

                    <!-- FORM RIÊNG CHO RESEND OTP -->
                    <form asp-action="ResendOtp" method="post" id="resendForm">
                        @Html.AntiForgeryToken()
                        <div class="text-center">
                            <button type="button" id="resendBtn" class="btn btn-link text-muted p-0" disabled>
                                Gửi lại OTP
                            </button>
                            <span id="countdown" class="text-muted ms-2">(5s)</span>
                        </div>
                    </form>

                    <div class="text-center mt-3">
                        <a asp-action="Login" class="text-muted">Quay lại đăng nhập</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial"/>
    <script>
        let countdownTime = 5;
        const resendBtn = document.getElementById('resendBtn');
        const countdownSpan = document.getElementById('countdown');
        const resendForm = document.getElementById('resendForm');

        function startCountdown() {
            resendBtn.disabled = true;
            const timer = setInterval(() => {
                countdownTime--;
                countdownSpan.textContent = `(${countdownTime}s)`;

                if (countdownTime <= 0) {
                    clearInterval(timer);
                    resendBtn.disabled = false;
                    countdownSpan.textContent = '';
                    resendBtn.innerHTML = 'Gửi lại OTP';
                }
            }, 1000);
        }

        resendBtn.addEventListener('click', async () => {
            resendBtn.disabled = true;
            resendBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Đang gửi...';

            const formData = new FormData(resendForm);

            const response = await fetch('@Url.Action("ResendOtp", "Authen")', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    alert('Đã gửi lại OTP thành công!');
                    countdownTime = 60;
                    startCountdown();
                    resendBtn.innerHTML = 'Gửi lại OTP';
                } else {
                    alert('Lỗi: ' + data.message);
                    resendBtn.disabled = false;
                    resendBtn.innerHTML = 'Gửi lại OTP';
                }
            } else {
                alert('Lỗi hệ thống. Vui lòng thử lại.');
                resendBtn.disabled = false;
                resendBtn.innerHTML = 'Gửi lại OTP';
            }
        });

        startCountdown();
    </script>
}