<!-- Index.cshtml -->
@{
ViewData["Title"] = "Chat";
}

@Html.AntiForgeryToken()

<div id="autoVerifyScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 class="fw-bold mb-2">Đang xác thực...</h5>
        <p class="text-muted" id="autoVerifyMessage">Vui lòng đợi</p>
    </div>
</div>

<div class="container-fluid vh-100 d-flex flex-column p-0">
    <div class="row g-0 flex-grow-1">
        <div class="col-md-4 col-lg-3 border-end bg-white d-flex flex-column">
            <div class="p-3 border-bottom">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0 fw-bold">Chat</h4>
                    <button class="btn btn-sm btn-outline-danger" onclick="logoutFromChat()" title="Đăng xuất khỏi chat">
                        <i class="bi bi-lock-fill"></i>
                    </button>
                </div>

                <div class="input-group search-box">
                    <span class="input-group-text bg-light border-0">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text"
                           id="searchUserInput"
                           class="form-control bg-light border-0"
                           placeholder="Tìm kiếm trong Messenger"
                           autocomplete="off" />
                    <button class="btn btn-light border-0" type="button" id="clearSearch" style="display: none;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>

            <div id="searchResults" class="flex-grow-1 overflow-auto" style="display: none;">
                <div class="p-2">
                    <div class="d-flex justify-content-between align-items-center px-2 mb-2">
                        <h6 class="text-muted mb-0 small">Kết quả tìm kiếm</h6>
                        <span id="searchCount" class="badge bg-primary rounded-pill">0</span>
                    </div>
                    <div id="searchResultsList"></div>
                </div>
            </div>

            <div id="conversationList" class="flex-grow-1 overflow-auto">
                <div id="contactsListContainer" class="p-2">
                    <div class="text-center text-muted py-5" id="emptyContactsState">
                        <i class="bi bi-chat-dots" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2 mb-0 small">Chưa có tin nhắn nào</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8 col-lg-9 d-flex flex-column bg-light">
            <div id="welcomeScreen" class="flex-grow-1 d-flex align-items-center justify-content-center">
                <div class="text-center">
                    <div class="welcome-icon mb-4">
                        <i class="bi bi-chat-dots-fill" style="font-size: 4rem; color: #cbd5e0;"></i>
                    </div>
                    <h2 class="fw-bold mb-2">Messenger</h2>
                    <p class="text-muted mb-4">Kết nối và trò chuyện với bạn bè một cách an toàn</p>
                    <div class="d-flex gap-2 justify-content-center text-muted small">
                        <span><i class="bi bi-shield-lock-fill text-success"></i> Mã hóa đầu cuối</span>
                    </div>
                </div>
            </div>

            <div id="chatWindow" style="display: none;" class="d-flex flex-column flex-grow-1 bg-white">
                <div class="chat-header p-3 border-bottom bg-white">
                    <div class="d-flex align-items-center">
                        <div class="avatar-chat me-3">
                            <div class="avatar-circle-chat">
                                <i class="bi bi-person-fill"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0 fw-semibold" id="chatDisplayName">Display Name</h6>
                            <small class="text-muted" id="chatUsername"></small>
                        </div>
                    </div>
                </div>

                <div id="messagesArea" class="flex-grow-1 overflow-auto p-3">
                    <div class="text-center text-muted py-4">
                        <div class="avatar-large mb-3">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <h5 class="fw-semibold" id="welcomeName">Tên người dùng</h5>
                        <p class="text-muted small">
                            <i class="bi bi-lock-fill"></i> Tin nhắn được mã hóa đầu cuối
                        </p>
                    </div>
                </div>

                <div class="message-input-area p-3 border-top bg-white">
                    <form id="messageForm">
                        <div id="filePreview" class="d-none mb-2">
                            <div class="card bg-light border-0">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center">
                                        <i id="fileIcon" class="bi bi-file-earmark fs-3 text-primary me-2"></i>
                                        <div class="flex-grow-1">
                                            <div id="fileName" class="small fw-semibold"></div>
                                            <div id="fileSize" class="text-muted" style="font-size: 0.75rem;"></div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-link text-danger" id="removeFileBtn">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                    <div id="uploadProgress" class="progress mt-2" style="height: 3px; display: none;">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <button type="button" class="btn btn-light rounded-circle p-2" id="attachFileBtn">
                                <i class="bi bi-paperclip text-primary fs-5"></i>
                            </button>
                            <input type="file" id="fileInput" class="d-none"
                                   accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar" />

                            <input type="text" id="messageInput"
                                   class="form-control rounded-pill border-0 bg-light px-4 py-2"
                                   placeholder="Aa" autocomplete="off" disabled />

                            <button type="submit" class="btn btn-primary rounded-circle p-2" id="sendBtn" disabled>
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loadingModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <p class="mb-0 fw-semibold" id="loadingMessage">Đang tải...</p>
            </div>
        </div>
    </div>
</div>

@section Styles {
<style>
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

    .vh-100 { height: 100vh; }
    .border-end { border-right: 1px solid #dee2e6 !important; }

    /* Contacts List Styles */
    .contact-item {
        cursor: pointer;
        transition: all 0.2s ease;
        border-radius: 12px;
        margin-bottom: 4px;
        padding: 12px;
        position: relative;
        border: 1px solid transparent;
    }
    .contact-item:hover {
        background-color: #f7fafc;
        transform: translateY(-1px);
    }
    .contact-item.active {
        background-color: #ebf4ff;
        border-color: #bee3f8;
    }

    /* Avatar Styles */
    .avatar-container {
        width: 48px;
        height: 48px;
        flex-shrink: 0;
        margin-right: 12px;
        position: relative;
    }
    .avatar-img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid #e2e8f0;
    }
    .avatar-text {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        text-transform: uppercase;
        box-shadow: 0 2px 4px rgba(118, 75, 162, 0.2);
    }

    /* Search Result Avatar */
    .avatar-circle {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
    }

    /* Text & Badges */
    .last-msg-preview {
        font-size: 0.85rem;
        color: #718096;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 180px;
        margin-top: 2px;
    }
    .unread-badge {
        background-color: #ef4444;
        color: white;
        font-size: 0.7rem;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 10px;
        min-width: 18px;
        text-align: center;
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
    }
    .contact-time {
        font-size: 0.7rem;
        color: #a0aec0;
        position: absolute;
        top: 12px;
        right: 12px;
    }

    /* Chat Area */
    #messagesArea {
        background-color: #fdfdfd;
        background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
        background-size: 20px 20px;
    }
    .message {
        display: flex;
        margin-bottom: 12px;
        animation: fadeIn 0.3s ease;
    }
    @@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .message-bubble {
        max-width: 70%;
        padding: 10px 16px;
        border-radius: 18px;
        font-size: 0.95rem;
        position: relative;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .message-mine { justify-content: flex-end; }
    .message-theirs { justify-content: flex-start; }

    .message-mine .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }
    .message-theirs .message-bubble {
        background-color: #fff;
        color: #2d3748;
        border: 1px solid #e2e8f0;
        border-bottom-left-radius: 4px;
    }
    .message-time { font-size: 0.7rem; color: #a0aec0; margin-top: 4px; margin-left: 5px; margin-right: 5px; }

    /* Typing Animation */
    .typing-dots {
        display: inline-flex;
        align-items: center;
        height: 20px;
    }
    .typing-dots .dot {
        width: 6px;
        height: 6px;
        background-color: #adb5bd;
        border-radius: 50%;
        margin: 0 2px;
        animation: typingBounce 1.4s infinite ease-in-out both;
    }
    .typing-dots .dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots .dot:nth-child(2) { animation-delay: -0.16s; }

    @@keyframes typingBounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
</style>
}

@section Scripts {
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script>
    // ===== GLOBAL VARIABLES =====
    let currentConversationId = null;
    let currentRecipientId = null;
    let currentRecipientPublicKey = null;
    let currentUserId = null;
    let searchTimeout = null;
    let myPin = null;
    let myPrivateKeyEncrypted = null;
    let typingTimeout = null;
    let connection = null;
    let selectedFile = null;
    let recipientPinsCache = new Map();

    const currentUsername = '@User.Identity.Name';

    // ===== PIN & AUTH =====
    function getToken() {
        return document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
    }

    async function autoVerifyPin() {
        const storageKey = `pinCode_${currentUsername}`;
        const savedPin = localStorage.getItem(storageKey);
        if (!savedPin) {
            document.getElementById('autoVerifyMessage').textContent = 'Chưa có mã PIN...';
            setTimeout(() => window.location.href = '@Url.Action("VerifyPinCode", "Chat")', 1000);
            return false;
        }
        document.getElementById('autoVerifyMessage').textContent = 'Đang xác thực...';
        try {
            const hashedPin = CryptoJS.SHA256(savedPin).toString();
            const response = await fetch('@Url.Action("VerifyPinCode", "Chat")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': getToken() },
                body: JSON.stringify(hashedPin)
            });
            if (response.ok && (await response.json()).success) {
                myPin = savedPin;
                setTimeout(() => document.getElementById('autoVerifyScreen').style.display = 'none', 500);
                return true;
            }
        } catch (e) {}
        document.getElementById('autoVerifyMessage').textContent = 'Lỗi xác thực...';
        setTimeout(() => window.location.href = '@Url.Action("VerifyPinCode", "Chat")', 1500);
        return false;
    }

    function getMyPin() { return myPin; }

    async function getMyPrivateKey() {
        if (myPrivateKeyEncrypted) return myPrivateKeyEncrypted;
        try {
            const resp = await fetch('@Url.Action("GetMyPrivateKey", "Chat")');
            if (resp.ok) return myPrivateKeyEncrypted = (await resp.json()).privateKeyEncrypted;
        } catch (e) {}
        return null;
    }

    async function loadCurrentUserInfo() {
        try {
            const resp = await fetch('@Url.Action("GetCurrentUserInfo", "Chat")');
            if (resp.ok) {
                currentUserId = (await resp.json()).userId;
                return true;
            }
        } catch (e) {}
        return false;
    }

    // ===== UI HELPERS =====
    let loadingModalInstance = null;
    function showLoading(msg = 'Đang tải...') {
        const el = document.getElementById('loadingModal');
        document.getElementById('loadingMessage').textContent = msg;
        if (!loadingModalInstance) loadingModalInstance = new bootstrap.Modal(el, { backdrop: 'static', keyboard: false });
        loadingModalInstance.show();
    }
    function hideLoading() {
        if (loadingModalInstance) loadingModalInstance.hide();
        // Fallback cleanup
        setTimeout(() => {
            const modalEl = document.getElementById('loadingModal');
            if(modalEl) {
                modalEl.classList.remove('show');
                modalEl.style.display = 'none';
                modalEl.removeAttribute('aria-hidden'); // Cleanup attribute
                modalEl.removeAttribute('role'); // Cleanup attribute
            }
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('padding-right');
            document.body.style.removeProperty('overflow');
        }, 300);
    }

    function scrollToBottom(smooth = true) {
        const area = document.getElementById('messagesArea');
        if (!area) return;

        // Auto-scroll logic: only if near bottom or forced
        const isNearBottom = area.scrollHeight - area.scrollTop - area.clientHeight < 150;

        if (isNearBottom || !smooth) {
            area.scrollTo({
                top: area.scrollHeight,
                behavior: smooth ? 'smooth' : 'auto'
            });
        }
    }

    // ===== RECENT CONTACTS LOGIC (MỚI - SỬA LỖI NULL) =====
    async function loadRecentContacts() {
        try {
            const response = await fetch('@Url.Action("GetRecentContacts", "Chat")');
            if (!response.ok) return;
            const contacts = await response.json();
            displayContacts(contacts);
        } catch (error) { console.error("Error loading contacts:", error); }
    }

    function displayContacts(contacts) {
        const container = document.getElementById('contactsListContainer');
        if (!container) return;

        // Sort: Mới nhất lên đầu
        contacts.sort((a, b) => new Date(b.lastSentAt) - new Date(a.lastSentAt));

        if (contacts.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-5" id="emptyContactsState">
                    <i class="bi bi-chat-dots" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-2 mb-0 small">Chưa có tin nhắn nào</p>
                </div>`;
            return;
        }

        const html = contacts.map(c => {
            const date = new Date(c.lastSentAt);
            const timeStr = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            // Avatar logic
            let avatarHtml;
            if (c.avatarUrl && c.avatarUrl.trim() !== "") {
                avatarHtml = `<img src="${c.avatarUrl}" class="avatar-img" alt="${c.displayName}">`;
            } else {
                const initial = '/images/avatars/default.png';
                avatarHtml = `<img src="${initial}" class="avatar-img" alt="${c.displayName}">`;
            }

            let previewText = c.lastMessagePreview || (c.unreadCount > 0 ? "Tin nhắn mới" : "Tin nhắn được bảo mật");
            const previewClass = c.unreadCount > 0 ? "fw-bold text-dark" : "text-muted";
            const isActive = currentRecipientId === c.userId ? 'active' : '';
            const unreadBadge = c.unreadCount > 0 ? `<div class="unread-badge">${c.unreadCount}</div>` : '';

            return `
                <div class="contact-item d-flex align-items-center ${isActive}" 
                     id="contact-${c.userId}"
                     onclick="startChatWithUser('${c.userId}', '${c.username}', '${c.displayName}')">
                    <div class="avatar-container">${avatarHtml}</div>
                    <div class="flex-grow-1 overflow-hidden" style="min-width: 0;">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-semibold text-truncate">${c.displayName}</h6>
                        </div>
                        <div class="last-msg-preview ${previewClass} text-truncate">${previewText}</div>
                    </div>
                    ${unreadBadge}
                    <div class="contact-time">${timeStr}</div>
                </div>
            `;
        }).join('');
        container.innerHTML = html;
    }

    // ===== SEARCH LOGIC =====
    document.getElementById('searchUserInput').addEventListener('input', function(e) {
        const term = e.target.value.trim();
        document.getElementById('clearSearch').style.display = term.length > 0 ? 'block' : 'none';
        if (searchTimeout) clearTimeout(searchTimeout);

        if (term.length < 3) {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('conversationList').style.display = 'block';
            return;
        }
        searchTimeout = setTimeout(() => searchUsers(term), 300);
    });

    document.getElementById('clearSearch').addEventListener('click', function() {
        document.getElementById('searchUserInput').value = '';
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('conversationList').style.display = 'block';
        this.style.display = 'none';
    });

    async function searchUsers(term) {
        try {
            const response = await fetch(`@Url.Action("SearchUsers", "Chat")?searchTerm=${encodeURIComponent(term)}`);
            if (response.ok) displaySearchResults(await response.json());
        } catch (e) {}
    }

    function displaySearchResults(users) {
        const resultsDiv = document.getElementById('searchResultsList');
        document.getElementById('searchCount').textContent = users.length;
        document.getElementById('searchResults').style.display = 'block';
        document.getElementById('conversationList').style.display = 'none';

        if (users.length === 0) {
            resultsDiv.innerHTML = '<div class="text-center py-4 text-muted">Không tìm thấy</div>';
            return;
        }

        resultsDiv.innerHTML = users.map(user => {
            // 1. Xử lý ảnh null hoặc rỗng
            const avatarSrc = user.avatarUrl && user.avatarUrl.trim() !== ''
                ? user.avatarUrl
                : '~/images/avatars/default.png';

            return `
        <div class="user-item d-flex align-items-center mb-2 p-2 rounded cursor-pointer hover-bg" 
             onclick="startChatWithUser('${user.userId}', '${user.username}', '${user.displayName}')"
             style="transition: background 0.2s;">
            
            <div class="avatar-circle me-3" 
                 style="width: 45px; height: 45px; min-width: 45px; border-radius: 50%; overflow: hidden; background-color: #e4e6eb; border: 1px solid #dee2e6;">
                
                <img src="${avatarSrc}" 
                     alt="${user.displayName}"
                     style="width: 100%; height: 100%; object-fit: cover;"
                     onerror="this.onerror=null; this.src='/images/avatars/default.png';"/>
            </div>

            <div style="overflow: hidden;">
                <div class="fw-semibold text-truncate" style="font-size: 15px;">${user.displayName}</div>
                <small class="text-muted text-truncate d-block" style="font-size: 13px;">${user.username}</small>
            </div>
        </div>
    `}).join('');
    }

    // ===== DECRYPT LOGIC (Simplified) =====
    async function decryptAndCachePinExchange(encryptedPin, senderId) {
        try {
            const myPrivateKeyEnc = await getMyPrivateKey();
            const myPinLocal = getMyPin();
            if (!myPrivateKeyEnc || !myPinLocal) return null;

            const decryptedBytes = CryptoJS.AES.decrypt(myPrivateKeyEnc, myPinLocal);
            let myPrivateKeyDecrypted;
            try { myPrivateKeyDecrypted = decryptedBytes.toString(CryptoJS.enc.Utf8); }
            catch (e) { throw new Error("UTF8_PARSE_ERROR"); }

            if (!myPrivateKeyDecrypted) throw new Error("EMPTY_KEY");

            const decrypt = new JSEncrypt();
            decrypt.setPrivateKey(myPrivateKeyDecrypted);
            const senderPin = decrypt.decrypt(encryptedPin);

            if (senderPin) {
                recipientPinsCache.set(senderId.toLowerCase(), senderPin);
                return senderPin;
            }
        } catch (e) {
            if (e.message === "UTF8_PARSE_ERROR") {
                hideLoading();
                alert("Mã PIN không khớp Private Key. Vui lòng tạo lại khóa.");
                window.location.href = '@Url.Action("SetupKeys", "Chat")';
            }
        }
        return null;
    }

    // Tìm và giải mã RSA từ danh sách tin nhắn
    async function findKeyViaRSA(messages, partnerId) {
        const pinExchanges = messages.filter(m => m.pinExchange && !m.isMine && m.senderId === partnerId);
        pinExchanges.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        for (const msg of pinExchanges) {
            const pin = await decryptAndCachePinExchange(msg.pinExchange, msg.senderId);
            if (pin) return pin;
        }
        return null;
    }

    // ===== MAIN CHAT FUNCTIONS =====
    async function startChatWithUser(userId, username, displayName) {
        if (!currentUserId) return;

        // UI Update (Optimistic)
        document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
        const activeItem = document.getElementById(`contact-${userId}`);
        if(activeItem) {
            activeItem.classList.add('active');
            const badge = activeItem.querySelector('.unread-badge');
            if(badge) badge.remove();
        }

        showLoading('Đang tải chat...');

        try {
            // 1. Mark Read
            await markAsRead(userId);

            // 2. Get Public Key & Conv
            const keyResp = await fetch(`@Url.Action("GetUserPublicKey", "Chat")?userId=${userId}`);
            if (keyResp.ok) currentRecipientPublicKey = (await keyResp.json()).publicKey;

            const convResp = await fetch(`@Url.Action("GetOrCreateConversation", "Chat")?recipientId=${userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': getToken() }
            });
            const convData = await convResp.json();
            currentConversationId = convData.conversationId;
            currentRecipientId = userId;

            if (connection?.state === signalR.HubConnectionState.Connected) {
                await connection.invoke("JoinConversation", currentConversationId);
            }

            // 3. Load & Decrypt
            const messages = await loadMessagesAndReturn(currentConversationId);
            let cachedKey = recipientPinsCache.get(userId.toLowerCase());

            if (!cachedKey) {
                await findKeyViaRSA(messages, userId);
            }

            displayMessages(messages);
            showChatWindow(username, displayName);

            // Auto scroll bottom
            setTimeout(() => scrollToBottom(false), 100);

            // 4. Self-healing
            cachedKey = recipientPinsCache.get(userId.toLowerCase());
            if ((!cachedKey || convData.isNew || !convData.hasPinExchange) && currentRecipientPublicKey) {
                console.log("🔄 Sending initial PIN Exchange...");
                await sendPinExchange();
            }

        } catch (e) { console.error(e); }
        finally { hideLoading(); }
    }

    async function markAsRead(senderId) {
        try {
            await fetch('@Url.Action("MarkRead", "Chat")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': getToken() },
                body: JSON.stringify(senderId)
            });
            loadRecentContacts(); // Reload sidebar quietly
        } catch(e) {}
    }

    async function sendPinExchange() {
        const pin = getMyPin();
        if (!pin || !connection) return;

        try {
            const resp = await fetch(`@Url.Action("GetUserPublicKey", "Chat")?userId=${currentRecipientId}`);
            if (resp.ok) currentRecipientPublicKey = (await resp.json()).publicKey;
        } catch(e) {}

        if (!currentRecipientPublicKey) return;

        const encrypt = new JSEncrypt();
        encrypt.setPublicKey(currentRecipientPublicKey.trim());
        const encryptedPin = encrypt.encrypt(pin);

        if(encryptedPin) {
            await connection.invoke("SendPinExchange", {
                conversationId: currentConversationId,
                recipientId: currentRecipientId,
                encryptedPin: encryptedPin
            });
        }
    }

    async function loadMessagesAndReturn(convId) {
        try {
            const resp = await fetch(`@Url.Action("GetMessages", "Chat")?conversationId=${convId}&count=20`);
            return resp.ok ? await resp.json() : [];
        } catch { return []; }
    }

    function displayMessages(messages) {
        const area = document.getElementById('messagesArea');
        area.innerHTML = '';

        // 1. LỌC TIN NHẮN: Loại bỏ các tin nhắn là Pin Exchange
        const visibleMessages = messages.filter(msg => !msg.pinExchange);

        // 2. Kiểm tra lại độ dài sau khi lọc
        if (!visibleMessages.length) {
            area.innerHTML = '<div class="text-center py-4 text-muted"><p>Chưa có tin nhắn</p></div>';
            return;
        }

        const myPinLocal = getMyPin();

        // 3. Render trên danh sách đã lọc (visibleMessages)
        const html = visibleMessages.map(msg => {
            // Không cần kiểm tra msg.pinExchange ở đây nữa vì đã lọc ở trên rồi

            let content = msg.cipherText;

            try {
                let pinToUse = msg.isMine ? myPinLocal : recipientPinsCache.get(msg.senderId.toLowerCase());

                if (pinToUse) {
                    // Giải mã tin nhắn văn bản
                    content = CryptoJS.AES.decrypt(msg.cipherText, pinToUse).toString(CryptoJS.enc.Utf8);
                    if (!content) content = '[Lỗi giải mã]';
                } else {
                    content = '[Đang tải khóa...]';
                    // Nếu chưa có khóa, bạn có thể kích hoạt logic tìm khóa ở đây nếu muốn
                }
            } catch {
                content = '[Lỗi dữ liệu]';
            }

            const bubbleClass = msg.isMine ? 'message-mine' : 'message-theirs';
            const time = new Date(msg.createdAt).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            return `
            <div class="message ${bubbleClass}">
                <div class="message-bubble">${content}</div>
                <div class="message-time">${time}</div>
            </div>
        `;
        }).join('');

        area.innerHTML = html;
    }

    function showChatWindow(username, displayName) {
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('chatWindow').style.display = 'flex';

        const elDisplayName = document.getElementById('chatDisplayName');
        if(elDisplayName) elDisplayName.textContent = displayName;

        const elUsername = document.getElementById('chatUsername');
        if(elUsername) elUsername.textContent = username;

        const elWelcome = document.getElementById('welcomeName');
        if(elWelcome) elWelcome.textContent = displayName;

        const input = document.getElementById('messageInput');
        const btn = document.getElementById('sendBtn');
        if(input) { input.disabled = false; input.focus(); }
        if(btn) btn.disabled = false;
    }

    // ===== UI HELPERS (TYPING) =====
    function showTypingIndicator() {
        const area = document.getElementById('messagesArea');
        if (document.getElementById('typingIndicator')) return;

        const div = document.createElement('div');
        div.id = 'typingIndicator';
        div.className = 'message message-theirs';
        div.innerHTML = `
            <div class="message-bubble bg-light text-secondary">
                <div class="typing-dots">
                    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                </div>
            </div>`;
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    function hideTypingIndicator() {
        const el = document.getElementById('typingIndicator');
        if (el) el.remove();
    }

    // ===== HELPER: APPEND MESSAGE (SMOOTH UX) =====
    async function appendSingleMessageToUI(msg) {
        let content = msg.cipherText;

        if (!msg.pinExchange) {
            try {
                let pinToUse = msg.senderId === currentUserId ? getMyPin() : recipientPinsCache.get(msg.senderId.toLowerCase());
                if (pinToUse) {
                    content = CryptoJS.AES.decrypt(msg.cipherText, pinToUse).toString(CryptoJS.enc.Utf8);
                } else {
                    // Fallback: reload keys
                    content = '[Đang tải khóa...]';
                    findKeyViaRSA([msg], msg.senderId).then(k => {
                        if(k) loadMessagesAndReturn(currentConversationId).then(displayMessages);
                    });
                }
            } catch (e) { content = '[Lỗi giải mã]'; }
        } else {
            content = '[Hệ thống: Đã cập nhật khóa]';
        }

        const area = document.getElementById('messagesArea');
        const div = document.createElement('div');
        div.className = `message ${msg.senderId === currentUserId ? 'message-mine' : 'message-theirs'}`;
        div.innerHTML = `
            <div class="message-bubble">${content}</div>
            <div class="message-time">${new Date(msg.createdAt).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</div>
        `;
        area.appendChild(div);

        // Remove typing indicator if exists
        hideTypingIndicator();
        scrollToBottom(true);
    }

    // ===== SIGNALR EVENTS =====
    async function initializeSignalR() {
        connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").withAutomaticReconnect().build();

        connection.on("ReceiveMessage", async (msg) => {
            if (msg.senderId !== currentUserId) await loadRecentContacts();

            if (msg.conversationId === currentConversationId) {
                await appendSingleMessageToUI(msg);
                markAsRead(msg.senderId);
            }
        });

        connection.on("ReceivePinExchange", async (data) => {
            if (data.senderId === currentUserId) return;
            const senderPin = await decryptAndCachePinExchange(data.encryptedPin, data.senderId);

            if (senderPin) {
                const key = `hs_${data.conversationId}_${data.senderId}`;
                if (!sessionStorage.getItem(key)) {
                    sessionStorage.setItem(key, "1");
                    setTimeout(() => sendPinExchange(), 500);
                }
                if (data.conversationId === currentConversationId) {
                    const msgs = await loadMessagesAndReturn(currentConversationId);
                    displayMessages(msgs);
                }
            }
        });

        connection.on("UserTyping", (data) => {
            if (data.conversationId === currentConversationId && data.userId !== currentUserId) showTypingIndicator();
        });

        connection.on("UserStoppedTyping", (data) => {
            if (data.conversationId === currentConversationId && data.userId !== currentUserId) hideTypingIndicator();
        });

        try { await connection.start(); console.log("SignalR Connected"); } catch(e) {}
    }

    // ===== SENDING =====
    document.getElementById('messageInput').addEventListener('input', () => {
        if (!currentConversationId || !connection) return;
        if (typingTimeout) clearTimeout(typingTimeout);
        connection.invoke("UserTyping", currentConversationId).catch(console.error);
        typingTimeout = setTimeout(() => {
            connection.invoke("UserStoppedTyping", currentConversationId).catch(console.error);
        }, 2000);
    });

    document.getElementById('messageForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!currentConversationId || !connection) return;

        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if (!text) return;

        const pin = getMyPin();
        const encrypted = CryptoJS.AES.encrypt(text, pin).toString();

        await connection.invoke("SendMessage", {
            conversationId: currentConversationId,
            cipherText: encrypted,
            messageType: 0
        });

        input.value = '';
        await loadRecentContacts();
    });

    // ===== INIT =====
    window.addEventListener('load', async () => {
        if (await autoVerifyPin() && await loadCurrentUserInfo()) {
            await initializeSignalR();
            await loadRecentContacts();
        }
    });
</script>
}