@{
ViewData["Title"] = "Chat";
}

@Html.AntiForgeryToken()

<!-- Auto Verify Loading Screen -->
<div id="autoVerifyScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 class="fw-bold mb-2">Đang xác thực...</h5>
        <p class="text-muted" id="autoVerifyMessage">Vui lòng đợi</p>
    </div>
</div>

<div class="container-fluid vh-100 d-flex flex-column p-0">
    <div class="row g-0 flex-grow-1">
        <!-- Sidebar - User List -->
        <div class="col-md-4 col-lg-3 border-end bg-white d-flex flex-column">
            <!-- Header -->
            <div class="p-3 border-bottom">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0 fw-bold">Chat</h4>
                    <button class="btn btn-sm btn-outline-danger" onclick="logoutFromChat()" title="Đăng xuất khỏi chat">
                        <i class="bi bi-lock-fill"></i>
                    </button>
                </div>

                <!-- Search Box -->
                <div class="input-group search-box">
                    <span class="input-group-text bg-light border-0">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text"
                           id="searchUserInput"
                           class="form-control bg-light border-0"
                           placeholder="Tìm kiếm trong Messenger"
                           autocomplete="off" />
                    <button class="btn btn-light border-0" type="button" id="clearSearch" style="display: none;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Search Results -->
            <div id="searchResults" class="flex-grow-1 overflow-auto" style="display: none;">
                <div class="p-2">
                    <div class="d-flex justify-content-between align-items-center px-2 mb-2">
                        <h6 class="text-muted mb-0 small">Kết quả tìm kiếm</h6>
                        <span id="searchCount" class="badge bg-primary rounded-pill">0</span>
                    </div>
                    <div id="searchResultsList"></div>
                </div>
            </div>

            <!-- Conversation List -->
            <div id="conversationList" class="flex-grow-1 overflow-auto">
                <div id="conversationsList">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-chat-dots" style="font-size: 4rem; opacity: 0.3;"></i>
                        <p class="mt-3 mb-1 fw-semibold">Chưa có cuộc trò chuyện</p>
                        <small class="text-muted">Tìm kiếm để bắt đầu nhắn tin</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="col-md-8 col-lg-9 d-flex flex-column bg-light">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="flex-grow-1 d-flex align-items-center justify-content-center">
                <div class="text-center">
                    <div class="welcome-icon mb-4">
                        <i class="bi bi-chat-dots-fill"></i>
                    </div>
                    <h2 class="fw-bold mb-2">Messenger</h2>
                    <p class="text-muted mb-4">Kết nối và trò chuyện với bạn bè một cách an toàn</p>
                    <div class="d-flex gap-2 justify-content-center text-muted small">
                        <span><i class="bi bi-shield-lock-fill text-success"></i> Mã hóa đầu cuối</span>
                    </div>
                </div>
            </div>

            <!-- Chat Window -->
            <div id="chatWindow" style="display: none;" class="d-flex flex-column flex-grow-1 bg-white">
                <!-- Chat Header -->
                <div class="chat-header p-3 border-bottom bg-white">
                    <div class="d-flex align-items-center">
                        <div class="avatar-chat me-3">
                            <div class="avatar-circle-chat">
                                <i class="bi bi-person-fill"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0 fw-semibold" id="chatDisplayName">Display Name</h6>
                            <small class="text-muted" id="chatUsername"></small>
                        </div>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="messagesArea" class="flex-grow-1 overflow-auto p-3">
                    <div class="text-center text-muted py-4">
                        <div class="avatar-large mb-3">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <h5 class="fw-semibold" id="welcomeName">Tên người dùng</h5>
                        <p class="text-muted small">
                            <i class="bi bi-lock-fill"></i> Tin nhắn được mã hóa đầu cuối
                        </p>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="message-input-area p-3 border-top bg-white">
                    <form id="messageForm">
                        <div id="filePreview" class="d-none mb-2">
                            <div class="card bg-light border-0">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center">
                                        <i id="fileIcon" class="bi bi-file-earmark fs-3 text-primary me-2"></i>
                                        <div class="flex-grow-1">
                                            <div id="fileName" class="small fw-semibold"></div>
                                            <div id="fileSize" class="text-muted" style="font-size: 0.75rem;"></div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-link text-danger" id="removeFileBtn">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                    <div id="uploadProgress" class="progress mt-2" style="height: 3px; display: none;">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-end gap-2">
                            <div class="d-flex gap-1">
                                <button type="button" class="btn btn-light rounded-circle p-2" id="attachFileBtn">
                                    <i class="bi bi-plus-lg text-primary"></i>
                                </button>
                                <input type="file" id="fileInput" style="display: none;"
                                       accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar" />
                            </div>

                            <div class="flex-grow-1">
                                <input type="text"
                                       id="messageInput"
                                       class="form-control rounded-pill border-0 bg-light px-4"
                                       placeholder="Aa"
                                       autocomplete="off"
                                       disabled />
                            </div>

                            <button type="submit" class="btn btn-primary rounded-circle p-2" id="sendBtn" disabled>
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <p class="mb-0 fw-semibold" id="loadingMessage">Đang tải...</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script>
    // ===== GLOBAL VARIABLES =====
    let currentConversationId = null;
    let currentRecipientId = null;
    let currentRecipientPublicKey = null;
    let searchTimeout = null;
    let myPin = null;
    let typingTimeout = null;
    let connection = null;
    let selectedFile = null;

    // Lấy username hiện tại
    const currentUsername = '@User.Identity.Name';

    // ===== PIN MANAGEMENT =====

    // Auto verify PIN khi load trang
    async function autoVerifyPin() {
        const storageKey = `pinCode_${currentUsername}`;
        const savedPin = localStorage.getItem(storageKey);

        console.log('Auto verifying PIN for user:', currentUsername);
        console.log('Storage key:', storageKey);

        if (!savedPin) {
            console.log('No PIN in localStorage, redirecting to verify page');
            document.getElementById('autoVerifyMessage').textContent = 'Chưa có mã PIN, đang chuyển hướng...';
            setTimeout(() => {
                window.location.href = '@Url.Action("VerifyPinCode", "Chat")';
            }, 1000);
            return false;
        }

        console.log('PIN found in localStorage, verifying with server...');
        document.getElementById('autoVerifyMessage').textContent = 'Đang xác thực mã PIN...';

        try {
            // Hash PIN
            const hashedPin = CryptoJS.SHA256(savedPin).toString();

            // Verify với server
            const response = await fetch('@Url.Action("VerifyPinCode", "Chat")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getToken()
                },
                body: JSON.stringify(hashedPin)
            });

            if (!response.ok) {
                throw new Error('Network error');
            }

            const result = await response.json();

            if (result.success) {
                console.log('Auto verify successful');
                document.getElementById('autoVerifyMessage').textContent = 'Xác thực thành công!';

                // Lưu PIN vào biến global
                myPin = savedPin;

                // Ẩn màn hình verify
                setTimeout(() => {
                    document.getElementById('autoVerifyScreen').style.display = 'none';
                }, 500);

                return true;
            } else {
                console.log('Auto verify failed, PIN might be changed');
                document.getElementById('autoVerifyMessage').textContent = 'Mã PIN không hợp lệ, vui lòng nhập lại...';

                // Xóa PIN cũ
                localStorage.removeItem(storageKey);

                setTimeout(() => {
                    window.location.href = '@Url.Action("VerifyPinCode", "Chat")';
                }, 1500);

                return false;
            }
        } catch (error) {
            console.error('Auto verify error:', error);
            document.getElementById('autoVerifyMessage').textContent = 'Lỗi xác thực, đang thử lại...';

            setTimeout(() => {
                window.location.href = '@Url.Action("VerifyPinCode", "Chat")';
            }, 1500);

            return false;
        }
    }

    // Kiểm tra PIN trong localStorage
    function checkPinCodeStatus() {
        const storageKey = `pinCode_${currentUsername}`;
        const savedPin = localStorage.getItem(storageKey);

        if (!savedPin) {
            console.log('No PIN found, redirecting to verify page');
            window.location.href = '@Url.Action("VerifyPinCode", "Chat")';
            return false;
        }

        return true;
    }

    // Lấy PIN từ localStorage
    function getMyPin() {
        if (!myPin) {
            const storageKey = `pinCode_${currentUsername}`;
            myPin = localStorage.getItem(storageKey);

            if (!myPin) {
                console.error('PIN not found in localStorage');
                alert('Không tìm thấy mã PIN. Vui lòng xác thực lại.');
                window.location.href = '@Url.Action("VerifyPinCode", "Chat")';
                return null;
            }
        }
        return myPin;
    }

    // Đăng xuất khỏi chat (xóa PIN)
    function logoutFromChat() {
        if (confirm('Bạn có chắc muốn đăng xuất khỏi chat? Bạn sẽ cần nhập lại mã PIN để truy cập.')) {
            const storageKey = `pinCode_${currentUsername}`;
            localStorage.removeItem(storageKey);
            myPin = null;
            window.location.href = '@Url.Action("VerifyPinCode", "Chat")';
        }
    }

    // ===== SIGNALR =====

    function handleReceiveMessage(message) {
        console.log('Received message:', message);
        if (message.conversationId !== currentConversationId) return;

        const pin = getMyPin();
        if (!pin) return;

        try {
            let decryptedContent = message.cipherText;
            if (!message.pinExchange) {
                decryptedContent = CryptoJS.AES.decrypt(message.cipherText, pin)
                    .toString(CryptoJS.enc.Utf8) || '[Không thể giải mã]';
            }

            appendMessageToUI({
                messageId: message.messageId,
                senderId: message.senderId,
                decryptedContent: message.pinExchange ? '[PIN Exchange]' : decryptedContent,
                createdAt: message.createdAt,
                isMine: false,
                isPinExchange: !!message.pinExchange,
                messageType: message.messageType
            });
        } catch (error) {
            console.error('Error handling message:', error);
        }
    }

    function handleReceivePinExchange(data) {
        console.log('Received PIN exchange');
        if (data.conversationId !== currentConversationId) return;

        appendMessageToUI({
            messageId: 0,
            senderId: data.senderId,
            decryptedContent: '[PIN Exchange]',
            createdAt: data.createdAt,
            isMine: false,
            isPinExchange: true
        });
    }

    function handleUserTyping(data) {
        if (data.conversationId !== currentConversationId) return;
        showTypingIndicator(data.username);
    }

    function handleUserStoppedTyping(data) {
        if (data.conversationId !== currentConversationId) return;
        hideTypingIndicator();
    }

    function handleError(message) {
        console.error('SignalR error:', message);
    }

    async function initializeSignalR() {
        connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        connection.on("ReceiveMessage", handleReceiveMessage);
        connection.on("ReceivePinExchange", handleReceivePinExchange);
        connection.on("UserTyping", handleUserTyping);
        connection.on("UserStoppedTyping", handleUserStoppedTyping);
        connection.on("Error", handleError);

        connection.onreconnecting(() => console.log('Reconnecting...'));
        connection.onreconnected((id) => {
            console.log('Reconnected:', id);
            if (currentConversationId) {
                connection.invoke("JoinConversation", currentConversationId);
            }
        });

        try {
            await connection.start();
            console.log('SignalR connected');
        } catch (error) {
            console.error('SignalR error:', error);
            setTimeout(() => initializeSignalR(), 5000);
        }
    }

    // ===== UI HELPERS =====

    function showLoading(msg = 'Đang tải...') {
        document.getElementById('loadingMessage').textContent = msg;
        new bootstrap.Modal(document.getElementById('loadingModal')).show();
    }

    function hideLoading() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
        if (modal) modal.hide();
    }

    function getToken() {
        return document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
    }

    // ===== SEARCH =====

    document.getElementById('searchUserInput').addEventListener('input', function(e) {
        const term = e.target.value.trim();
        document.getElementById('clearSearch').style.display = term.length > 0 ? 'block' : 'none';

        if (searchTimeout) clearTimeout(searchTimeout);

        if (term.length < 3) {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('conversationList').style.display = 'block';
            return;
        }

        searchTimeout = setTimeout(() => searchUsers(term), 300);
    });

    document.getElementById('clearSearch').addEventListener('click', function() {
        document.getElementById('searchUserInput').value = '';
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('conversationList').style.display = 'block';
        this.style.display = 'none';
    });

    async function searchUsers(term) {
        try {
            const response = await fetch(`@Url.Action("SearchUsers", "Chat")?searchTerm=${encodeURIComponent(term)}`);
            if (!response.ok) throw new Error('Search failed');

            const users = await response.json();
            displaySearchResults(users);
        } catch (error) {
            console.error('Error searching:', error);
            alert('Lỗi khi tìm kiếm');
        }
    }

    function displaySearchResults(users) {
        const resultsDiv = document.getElementById('searchResultsList');
        const countBadge = document.getElementById('searchCount');

        countBadge.textContent = users.length;
        document.getElementById('searchResults').style.display = 'block';
        document.getElementById('conversationList').style.display = 'none';

        if (users.length === 0) {
            resultsDiv.innerHTML = '<div class="text-center py-4 text-muted">Không tìm thấy</div>';
            return;
        }

        resultsDiv.innerHTML = users.map(user => `
                <div class="user-item" data-user-id="${user.userId}" 
                     data-username="${user.username}" data-displayname="${user.displayName}">
                    <div class="d-flex align-items-center">
                        <div class="avatar-circle me-3">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">${user.displayName}</div>
                            <small class="text-muted">${user.username}</small>
                        </div>
                    </div>
                </div>
            `).join('');

        resultsDiv.querySelectorAll('.user-item').forEach(item => {
            item.addEventListener('click', function() {
                startChatWithUser(
                    this.dataset.userId,
                    this.dataset.username,
                    this.dataset.displayname
                );
            });
        });
    }

    // ===== CHAT FUNCTIONS =====

    async function startChatWithUser(userId, username, displayName) {
        showLoading('Đang khởi tạo chat...');

        try {
            // 1. Lấy public key
            const keyResp = await fetch(`@Url.Action("GetUserPublicKey", "Chat")?userId=${userId}`);
            if (!keyResp.ok) throw new Error('Không lấy được public key');

            const keyData = await keyResp.json();
            if (!keyData.publicKey) throw new Error('Đối phương chưa có khóa RSA');

            currentRecipientPublicKey = keyData.publicKey;

            // 2. Lấy/tạo conversation
            const convResp = await fetch(`@Url.Action("GetOrCreateConversation", "Chat")?recipientId=${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getToken()
                }
            });
            if (!convResp.ok) throw new Error('Không tạo được đoạn chat');

            const convData = await convResp.json();
            currentConversationId = convData.conversationId;
            currentRecipientId = userId;

            // 3. Join SignalR group
            if (connection?.state === signalR.HubConnectionState.Connected) {
                await connection.invoke("JoinConversation", currentConversationId);
            }

            // 4. Load tin nhắn + hiển thị giao diện
            await loadMessages(currentConversationId);
            showChatWindow(username, displayName);

            // 5. Chỉ gửi PIN exchange nếu thật sự cần
            if (convData.isNew || !convData.hasPinExchange) {
                await sendPinExchange();
            }

            hideLoading();
        }
        catch (error) {
            console.error('Lỗi mở chat:', error);
            hideLoading();
            alert('Không thể mở chat: ' + (error.message || 'Lỗi không xác định'));
        }
    }

    async function sendPinExchange() {
        const pin = getMyPin();
        if (!pin) throw new Error('Không tìm thấy mã PIN');
        if (!connection) throw new Error('Chưa kết nối SignalR');

        const encrypt = new JSEncrypt();
        encrypt.setPublicKey(currentRecipientPublicKey.trim());
        const encryptedPin = encrypt.encrypt(pin);

        if (!encryptedPin) {
            throw new Error('Mã hóa PIN thất bại – public key không hợp lệ');
        }

        await connection.invoke("SendPinExchange", {
            conversationId: currentConversationId,
            recipientId: currentRecipientId,
            encryptedPin: encryptedPin
        });

        console.log('PIN exchange sent successfully');
    }

    async function loadMessages(convId) {
        try {
            const resp = await fetch(`@Url.Action("GetMessages", "Chat")?conversationId=${convId}&count=20`);
            if (!resp.ok) throw new Error('Load failed');

            const messages = await resp.json();
            displayMessages(messages);
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    function displayMessages(messages) {
        const area = document.getElementById('messagesArea');

        if (messages.length === 0) {
            area.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <div class="avatar-large mb-3"><i class="bi bi-person-fill"></i></div>
                        <p class="small"><i class="bi bi-lock-fill"></i> Mã hóa đầu cuối</p>
                    </div>
                `;
            return;
        }

        const pin = getMyPin();
        const decrypted = messages.map(msg => {
            if (msg.pinExchange) {
                return { ...msg, decryptedContent: '[PIN Exchange]', isPinExchange: true };
            }

            try {
                const dec = CryptoJS.AES.decrypt(msg.cipherText, pin).toString(CryptoJS.enc.Utf8);
                return { ...msg, decryptedContent: dec || '[Không giải mã được]' };
            } catch {
                return { ...msg, decryptedContent: '[Lỗi]' };
            }
        });

        area.innerHTML = decrypted.map(msg => `
                <div class="message ${msg.isMine ? 'message-mine' : 'message-theirs'}">
                    <div class="message-bubble">
                        ${msg.isPinExchange ?
            '<small class="text-muted"><i class="bi bi-shield-lock"></i> Thiết lập mã hóa</small>' :
            msg.decryptedContent
        }
                    </div>
                    <div class="message-time">
                        ${new Date(msg.createdAt).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                </div>
            `).join('');

        area.scrollTop = area.scrollHeight;
    }

    function showChatWindow(username, displayName) {
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('chatWindow').style.display = 'flex';

        const setText = (id, text) => {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        };

        setText('chatUsername', username);
        setText('chatDisplayName', displayName);
        setText('welcomeName', displayName);

        const input = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        if (input) input.disabled = false;
        if (sendBtn) sendBtn.disabled = false;
    }

    function appendMessageToUI(msg) {
        const area = document.getElementById('messagesArea');

        const div = document.createElement('div');
        div.className = `message ${msg.isMine ? 'message-mine' : 'message-theirs'}`;

        const content = msg.isPinExchange ?
            '<small class="text-muted"><i class="bi bi-shield-lock"></i> Thiết lập mã hóa</small>' :
            msg.decryptedContent;

        div.innerHTML = `
                <div class="message-bubble">${content}</div>
                <div class="message-time">
                    ${new Date(msg.createdAt).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}
                </div>
            `;

        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    function showTypingIndicator(username) {
        const area = document.getElementById('messagesArea');
        let indicator = document.getElementById('typingIndicator');

        if (indicator) indicator.remove();

        indicator = document.createElement('div');
        indicator.id = 'typingIndicator';
        indicator.className = 'message message-theirs';
        indicator.innerHTML = `
                <div class="message-bubble">
                    <small class="text-muted"><i class="bi bi-three-dots"></i> ${username} đang nhập...</small>
                </div>
            `;

        area.appendChild(indicator);
        area.scrollTop = area.scrollHeight;
    }

    function hideTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    // ===== MESSAGE SENDING =====

    document.getElementById('messageForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!currentConversationId || !connection) return;

        const pin = getMyPin();
        if (!pin) return;

        try {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            const encrypted = CryptoJS.AES.encrypt(message, pin).toString();

            await connection.invoke("SendMessage", {
                conversationId: currentConversationId,
                cipherText: encrypted,
                messageType: 0
            });

            input.value = '';
            await connection.invoke("UserStoppedTyping", currentConversationId);
        } catch (error) {
            console.error('Error sending:', error);
            alert('Không gửi được tin nhắn');
        }
    });

    // ===== TYPING INDICATOR =====

    document.getElementById('messageInput').addEventListener('input', async function() {
        if (!currentConversationId || !connection) return;

        if (typingTimeout) clearTimeout(typingTimeout);

        try {
            await connection.invoke("UserTyping", currentConversationId);
        } catch (e) {
            console.error('Typing error:', e);
        }

        typingTimeout = setTimeout(async () => {
            try {
                await connection.invoke("UserStoppedTyping", currentConversationId);
            } catch (e) {
                console.error('Stop typing error:', e);
            }
        }, 2000);
    });

    // ===== INITIALIZATION =====

    window.addEventListener('load', async () => {
        // Auto verify PIN trước
        const verifySuccess = await autoVerifyPin();

        if (!verifySuccess) {
            // Nếu verify thất bại, sẽ tự động redirect
            return;
        }

        // Nếu verify thành công, khởi tạo SignalR
        await initializeSignalR();
    });

    window.addEventListener('beforeunload', async () => {
        if (connection && currentConversationId) {
            try {
                await connection.invoke("LeaveConversation", currentConversationId);
            } catch (e) {
                console.error('Error leaving conversation:', e);
            }
        }
    });
</script>
}